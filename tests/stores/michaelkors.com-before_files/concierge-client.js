/* Copyright 2014-2020 © Moxie Software. All Rights Reserved. Concierge Version: v1.20.3 */
!function(){"use strict";function e(e){return"function"==typeof e}var t,i,n=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,o=function(e,t){m[r]=e,m[r+1]=t,2===(r+=2)&&(i?i(w):g())};var a="undefined"!=typeof window?window:void 0,s=a||{},c=s.MutationObserver||s.WebKitMutationObserver,u="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),l="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function d(){var e=setTimeout;return function(){return e(w,1)}}var g,h,f,p,v,m=new Array(1e3);function w(){for(var e=0;e<r;e+=2){(0,m[e])(m[e+1]),m[e]=void 0,m[e+1]=void 0}r=0}function y(e,t){var i=this,n=new this.constructor(C);void 0===n[S]&&W(n);var r=i._state;if(r){var a=arguments[r-1];o((function(){return x(r,n,a,i._result)}))}else T(i,n,e,t);return n}function b(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(C);return N(t,e),t}u?g=function(){return process.nextTick(w)}:c?(f=0,p=new c(w),v=document.createTextNode(""),p.observe(v,{characterData:!0}),g=function(){v.data=f=++f%2}):l?((h=new MessageChannel).port1.onmessage=w,g=function(){return h.port2.postMessage(0)}):g=void 0===a&&"function"==typeof require?function(){try{var e=Function("return this")().require("vertx");return void 0!==(t=e.runOnLoop||e.runOnContext)?function(){t(w)}:d()}catch(e){return d()}}():d();var S=Math.random().toString(36).substring(2);function C(){}function _(t,i,n){i.constructor===t.constructor&&n===y&&i.constructor.resolve===b?function(e,t){1===t._state?E(e,t._result):2===t._state?O(e,t._result):T(t,void 0,(function(t){return N(e,t)}),(function(t){return O(e,t)}))}(t,i):void 0===n?E(t,i):e(n)?function(e,t,i){o((function(e){var n=!1,r=function(e,t,i,n){try{e.call(t,i,n)}catch(e){return e}}(i,t,(function(i){n||(n=!0,t!==i?N(e,i):E(e,i))}),(function(t){n||(n=!0,O(e,t))}),e._label);!n&&r&&(n=!0,O(e,r))}),e)}(t,i,n):E(t,i)}function N(e,t){if(e===t)O(e,new TypeError("You cannot resolve a promise with itself"));else if(r=typeof(n=t),null===n||"object"!==r&&"function"!==r)E(e,t);else{var i;try{i=t.then}catch(t){return void O(e,t)}_(e,t,i)}var n,r}function I(e){e._onerror&&e._onerror(e._result),k(e)}function E(e,t){void 0===e._state&&(e._result=t,e._state=1,0!==e._subscribers.length&&o(k,e))}function O(e,t){void 0===e._state&&(e._state=2,e._result=t,o(I,e))}function T(e,t,i,n){var r=e._subscribers,a=r.length;e._onerror=null,r[a]=t,r[a+1]=i,r[a+2]=n,0===a&&e._state&&o(k,e)}function k(e){var t=e._subscribers,i=e._state;if(0!==t.length){for(var n,r,o=e._result,a=0;a<t.length;a+=3)n=t[a],r=t[a+i],n?x(i,n,r,o):r(o);e._subscribers.length=0}}function x(t,i,n,r){var o,a,s=e(n),c=!0;if(s){try{o=n(r)}catch(e){c=!1,a=e}if(i===o)return void O(i,new TypeError("A promises callback cannot return that same promise."))}else o=r;void 0!==i._state||(s&&c?N(i,o):!1===c?O(i,a):1===t?E(i,o):2===t&&O(i,o))}var L=0;function W(e){e[S]=L++,e._state=void 0,e._result=void 0,e._subscribers=[]}var M=function(e,t){this._instanceConstructor=e,this.promise=new e(C),this.promise[S]||W(this.promise),n(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?E(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&E(this.promise,this._result))):O(this.promise,new Error("Array Methods must be provided an Array"))};M.prototype._enumerate=function(e){for(var t=0;void 0===this._state&&t<e.length;t++)this._eachEntry(e[t],t)},M.prototype._eachEntry=function(e,t){var i=this._instanceConstructor,n=i.resolve;if(n===b){var r,o,a=!1;try{r=e.then}catch(e){a=!0,o=e}if(r===y&&void 0!==e._state)this._settledAt(e._state,t,e._result);else if("function"!=typeof r)this._remaining--,this._result[t]=e;else if(i===A){var s=new i(C);a?O(s,o):_(s,e,r),this._willSettleAt(s,t)}else this._willSettleAt(new i((function(t){return t(e)})),t)}else this._willSettleAt(n(e),t)},M.prototype._settledAt=function(e,t,i){var n=this.promise;void 0===n._state&&(this._remaining--,2===e?O(n,i):this._result[t]=i),0===this._remaining&&E(n,this._result)},M.prototype._willSettleAt=function(e,t){var i=this;T(e,void 0,(function(e){return i._settledAt(1,t,e)}),(function(e){return i._settledAt(2,t,e)}))};var A=function e(t){this[S]=L++,this._result=this._state=void 0,this._subscribers=[],C!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(e,t){try{t((function(t){N(e,t)}),(function(t){O(e,t)}))}catch(t){O(e,t)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())};A.prototype.catch=function(e){return this.then(null,e)},A.prototype.finally=function(t){var i=this.constructor;return e(t)?this.then((function(e){return i.resolve(t()).then((function(){return e}))}),(function(e){return i.resolve(t()).then((function(){throw e}))})):this.then(t,t)},A.prototype.then=y,A.all=function(e){return new M(this,e).promise},A.race=function(e){var t=this;return n(e)?new t((function(i,n){for(var r=e.length,o=0;o<r;o++)t.resolve(e[o]).then(i,n)})):new t((function(e,t){return t(new TypeError("You must pass an array to race."))}))},A.resolve=b,A.reject=function(e){var t=new this(C);return O(t,e),t},A._setScheduler=function(e){i=e},A._setAsap=function(e){o=e},A._asap=o;var D={EQUAL:0,GREATER:1,LESS:2,GREATEREQ:3,LESSEQ:4,BETWEEN:5,NOTEQUAL:6,CONTAINS:10,NOTCONTAINS:11,STARTSWITH:12,NOTSTARTSWITH:13,ENDSWITH:14,NOTENDSWITH:15,MATCH:16,NOTMATCH:17,CUSTOM:18,FIRST:0,CURRENT:1,PREVIOUS:2};function R(e){return"string"==typeof e&&(e=isNaN(e)?Date.parse(e):Number(e)),"object"==typeof e&&e instanceof Date&&(e=e.getTime()),"number"==typeof e&&e<9999999999&&(e*=1e3),e}function P(e,t,i){if(null==e)throw new TypeError('"array" is null or not defined');var n=e.length>>>0;for(i=+i||0,Math.abs(i)===1/0&&(i=0),i<0&&(i+=n)<0&&(i=0);i<n;i++)if(e[i]===t)return i;return-1}function j(e,t,i){return i=i||0,e.lastIndexOf(t,i)===i}function V(e,t,i){var n=e.toString();(void 0===i||i>n.length)&&(i=n.length),i-=t.length;var r=n.indexOf(t,i);return-1!==r&&r===i}function J(e,t,i){return-1!==e.indexOf(t,i)}function q(e){var t=".",i=V(e=(""+e).trim(),"%"),n=(e=e.replace(/[^0-9.,]/g,"")).lastIndexOf(","),r=e.lastIndexOf(".");r>=0&&n>=0&&r<n&&(t=","),(e.match(new RegExp("\\"+t,"g"))||[]).length>1&&(t=""),e=(e=e.replace(new RegExp("[^0-9"+t+"]","g"),"")).replace(",",".");var o=parseFloat(e);return i&&(o/=100),o}function F(e,t,i){if(t<10){var n=q(i),r=q(e);return function(e,t,i){if("number"!=typeof e||!("number"==typeof i||i instanceof Array))return!1;switch(t){case 0:return e===i;case 6:return e!==i;case 1:return e>i;case 2:return e<i;case 3:return e>=i;case 4:return e<=i;case 5:return e>=parseFloat(i[0])&&e<=parseFloat(i[1]);default:return!1}}(isNaN(r)?q(e.replace(/\./g,"").replace(/,/g,".")):r,t,i instanceof Array?i:isNaN(n)?q(i.replace(/\./g,"").replace(/,/g,".")):n)}return function(e,t,i){switch(e=e.toLowerCase(),i=i.toLowerCase(),t){case 12:return j(e,i);case 10:return J(e,i);case 16:return e===i;case 14:return V(e,i);case 13:return!j(e,i);case 11:return!J(e,i);case 17:return e!==i;case 15:return!V(e,i);case 18:return null!==e.match(i);default:return!1}}(e,t,i)}function $(e,t){return e=R(e),t?(e-R(t))/1e3:(Date.now()-e)/1e3}function U(e,t,i,n){void 0===n&&(n=!0);var r=0;switch(t){case 0:r=0;break;case 1:r=e.journey.length-1;break;case 2:i||(i=2),(e.journey.length>i||!1===n)&&(r=e.journey.length-i)}return e.journey[r]}function H(e,t,i){var n=0;switch(t){case 0:n=0;break;case 1:n=e.session.visits.length-1;break;case 2:i||(i=2),e.session.visits.length>i&&(n=e.session.visits.length-i)}return e.session.visits[n]}function B(e){return void 0===e?e:JSON.parse(JSON.stringify(e))}function G(e,t,i){e&&e[t]!==i&&(e[t]=i,e.dirty=!0)}function z(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function K(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}var Q=String.prototype.valueOf,X=Object.prototype.toString,Y="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag;function Z(e){return"string"==typeof e||"object"==typeof e&&(Y?function(e){try{return Q.call(e),!0}catch(e){return!1}}(e):"[object String]"===X.call(e))}function ee(e){return 0===Object.keys(e).length}var te=Math.pow(2,53)-1;function ie(e){return"function"==typeof e||"[object Function]"===X.call(e)}function ne(e){var t=function(e){var t=Number(e);if(isNaN(t))return 0;if(0===t||!isFinite(t))return t;return(t>0?1:-1)*Math.floor(Math.abs(t))}(e);return Math.min(Math.max(t,0),te)}function re(e,t,i){var n=arguments.length;if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var r=Object(e);if(n>1&&!ie(t))throw new TypeError("Array.from: when provided, the second argument must be a function");for(var o,a=ne(r.length),s=ie(Array)?Object(new Array(a)):new Array(a),c=0;c<a;)o=r[c],s[c]=t?n>2?t.call(i,o,c):t(o,c):o,c+=1;return s.length=a,s}function oe(){return window.innerHeight}function ae(){return window.innerWidth}function se(e){return t=e,!isNaN(parseFloat(t))&&isFinite(t)?e+"px":e;var t}var ce={top:se,bottom:se,left:se,right:se,height:se,width:se};function ue(e){var t=(e=e.toString()).indexOf("px");return t>0&&(e=Number(e.slice(0,t))),e}var le={top:ue,bottom:ue,left:ue,right:ue,height:ue,width:ue};function de(e,t){var i=ce[e];return i?i(t):t}function ge(e,t){var i=le[e];return i?i(t):t}function he(e){return getComputedStyle(e,null)}function fe(e){var t=ue(he(e).height);return""===t&&(t=e.getBoundingClientRect.height),t}function pe(e){var t=ue(he(e).width);return""===t&&(t=e.getBoundingClientRect.width),t}function ve(e){var t=he(e);return"none"!=t.display&&("hidden"!=t.visibility&&(!e.parentElement||ve(e.parentElement)))}function me(e,t){for(var i=[],n=arguments.length-2;n-- >0;)i[n]=arguments[n+2];if(e&&void 0!==e.length)for(var r=0;r<e.length;r++){var o=e[r];t.apply(void 0,[o].concat(i))}else{var a=e;t.apply(void 0,[a].concat(i))}}function we(e,t){for(var i=[],n=arguments.length-2;n-- >0;)i[n]=arguments[n+2];e&&void 0!==e.length&&e.length>0&&t.apply(void 0,[e[0]].concat(i))}function ye(e){return document.getElementById(e)}function be(e,t){return e.querySelectorAll(t)}function Se(e,t){var i=e.length;if(t>=0){if(0===i)return e;if(0===t&&1===i)return e;if(i>t)return[e[t]]}return[]}function Ce(e){return function(e,t){for(var i=[],n=arguments.length-2;n-- >0;)i[n]=arguments[n+2];var r=[];return me(e,(function(e){t.apply(void 0,[e].concat(i))&&r.push(e)})),r}(e,ve)}function _e(e){return function e(t,i){if(!i)return[];if(i.indexOf(",")>=0){var n=[];return i.split(",").forEach((function(i){n.push.apply(n,e(t,i.trim()))})),n}var r=i.match(/:(eq|first|last|visible)(\((\d+)\))?$/i);if(!r)return be(t,i);var o=i.slice(0,r.index),a=r[1].toLowerCase();if("eq"==a){var s=r[3];return Se(be(t,o),s)}return"first"==a?Se(be(t,o),0):"last"==a?function(e){var t=e.length;return t>1?[e[t-1]]:e}(be(t,o)):"visible"==a?Ce(be(t,o)):void 0}(document,e)}function Ne(e){z(e,"remove")?e.remove():e.parentNode&&e.parentNode.removeChild(e)}function Ie(e,t){e.innerHTML=t}function Ee(e,t,i){e.insertAdjacentHTML(t,i)}function Oe(e,t){Ee(e,"afterbegin",t)}function Te(e,t){Ee(e,"beforeend",t)}function ke(e,t){!function(e,t){Ee(e,"afterend",t)}(e,t),Ne(e)}function xe(e){me(e.childNodes,Ne)}function Le(e,t){e.appendChild(t)}function We(e,t){e.childNodes.length>0?e.insertBefore(t,e.childNodes[0]):Le(e,t)}function Me(e){e.focus()}function Ae(e){e.blur()}function De(e){return function e(t,i){return t===i||!!i.parentNode&&e(t,i.parentNode)}(e.ownerDocument,e)}function Re(e,t){return e.tagName===t}function Pe(e,t){return e.classList.contains(t)}function je(e,t){return e.attributes&&null!==e.getAttribute(t)}var Ve=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector;function Je(e,t){return Ve.call(e,t)}function qe(e,t){return e.getAttribute(t)}function Fe(e,t,i){e.setAttribute(t,i)}function $e(e,t){e.removeAttribute(t)}function Ue(e,t,i){e.style[t]=de(t,i)}function He(e,t){for(var i in t)Ue(e,i,t[i])}var Be=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&De(e)&&"none"===he(e).display},Ge=function(){return null},ze=function(){},Ke={};function Qe(e){var t,i=e.ownerDocument,n=e.nodeName,r=Ke[n];return r||(r=he(t=i.body.appendChild(i.createElement(n))).display,t.parentNode.removeChild(t),"none"===r&&(r="block"),Ke[n]=r,r)}function Xe(e,t){for(var i,n,r=[],o=0,a=e.length;o<a;o++)(n=e[o]).style&&(i=n.style.display,t?("none"===i&&(r[o]=Ge(n,"display")||null,r[o]||(n.style.display="")),""===n.style.display&&Be(n)&&(r[o]=Qe(n))):"none"!==i&&(r[o]="none",ze(n,"display",i)));for(o=0;o<a;o++)null!=r[o]&&(e[o].style.display=r[o]);return e}function Ye(e,t){e.classList.add(t)}function Ze(e,t){e.classList.remove(t)}function et(e,t,i){e.addEventListener(t,i,!1)}function tt(e,t,i){e.addEventListener(t,i,{passive:!0})}function it(e,t,i){e.removeEventListener(t,i)}function nt(e){for(var t=[],i=arguments.length-1;i-- >0;)t[i]=arguments[i+1];return function(i){if(i&&i.target)for(var n=i.target,r=i.currentTarget,o=n;null!==o&&!o.isEqualNode(r);){if(e.apply(void 0,[o].concat(t)))return[!0,o];o=o.parentElement}return[!1,null]}}function rt(e,t,i,n,r){var o=function(e){var t=i(e),o=t[0],a=t[1];o&&(null===a&&(a=this),!1===n.bind(a)(e)&&(e.stopPropagation(),r||e.preventDefault()))};return me(e,r?tt:et,t,o),o}function ot(e,t,i){me(e,it,t,i)}function at(e){return nt(Pe,e)}function st(e){return nt(Re,e.toUpperCase())}function ct(e){return nt(Je,e)}function ut(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),n=1;n<arguments.length;n++){var r=t[n];if(null!=r)for(var o in r)z(r,o)&&(i[o]=r[o])}return i}var lt=Object.prototype.propertyIsEnumerable;function dt(e){if(null==e)throw new TypeError("Sources cannot be null or undefined");return Object(e)}function gt(e,t,i){var n=t[i];if(null!=n)if(z(e,i)){if(void 0===e[i]||null===e[i])throw new TypeError("Cannot convert undefined or null to object ("+i+")");K(n)?e[i]=ht(Object(e[i]),n):e[i]=n}else K(n)?e[i]=ht(Object({}),n):e[i]=n}function ht(e,t){if(e===t)return e;for(var i in t=Object(t))z(t,i)&&gt(e,t,i);if(Object.getOwnPropertySymbols)for(var n=Object.getOwnPropertySymbols(t),r=0;r<n.length;r++)lt.call(t,n[r])&&gt(e,t,n[r]);return e}function ft(e){var t=arguments;e=dt(e);for(var i=1;i<arguments.length;i++)ht(e,t[i]);return e}function pt(e){for(var t=[],i=!1,n=0;n!==e.length;n++){var r=e[n];"-"===r?i=!0:i?(t.push(r.toUpperCase()),i=!1):t.push(r)}return t.join("")}function vt(e){return encodeURIComponent(e)}function mt(e){for(var t=[],i=Object.keys(e),n=0;n<i.length;n++){var r=i[n];if(Array.isArray(e[r])){var o,a=[];for(o=0;o<e[r].length;o++)a.push(vt(r+"[]")+"="+vt(e[r][o]));t.push(a.join("&"))}else t.push(vt(r)+"="+vt(e[r]))}return t.join("&")}var wt=Date.now()%1e9;function yt(){var e="__stash_"+(1e9*Math.random()>>>0)+wt+++"__";this.set=function(t,i){var n=t[e];return n&&n[0]===t?n[1]=i:Object.defineProperty(t,e,{value:[t,i],writable:!0}),this},this.get=function(t){var i=t[e];return i&&i[0]===t?i[1]:void 0},this.delete=function(t){var i=t[e];if(!i)return!1;var n=i[0]===t;return i[0]=i[1]=void 0,n},this.has=function(t){var i=t[e];return!!i&&i[0]===t}}var bt=!1||"undefined"==typeof WeakMap?new yt:new WeakMap;function St(e){var t;return bt.has(e)?t=bt.get(e):(t={},bt.set(e,t)),t}function Ct(e,t,i){var n=St(e),r=n[t];return n[t]=i,r}function _t(e,t){return St(e)[t]}function Nt(e,t){delete St(e)[t]}function It(e,t){var i=_t(e,t);return void 0===i&&(i=qe(e,"data-"+function(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}(t))),i}function Et(e){for(var t=ut({},St(e)),i=e.attributes,n=0;n<i.length;n++){var r=i.item(n);0===r.name.indexOf("data-")&&(t[pt(r.name.slice(5))]=r.value)}return t}function Ot(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];if(0!==e.length){for(var i=e[0],n=1;n<e.length;n++){var r=e[n];if(null==i)return;i="function"==typeof r?r(i):i[r]}return i}}var Tt=function(){};var kt=new function(){var e,t,i;e=console,t=Ot(console,"log"),i=Ot(console,"error"),t||(e={},t=Tt),i||(i=t),this.log=function(){t.apply(e,arguments)},this.error=function(){i.apply(e,arguments)},this.suppressLogs=function(){this.log=Tt,this.error=Tt}},xt=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},Lt=window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(e){clearTimeout(e)},Wt=function(){this.duration=300,this.aniCount=0,this.frameCount=0,this.timeCount=0,this.animations={},this.frames={},this.timeouts={}};Wt.prototype.count=function(){return this.aniCount+this.frameCount+this.timeCount},Wt.prototype.animationIds=function(){return Object.keys(this.animations)},Wt.prototype.frameIds=function(){return Object.keys(this.frames)},Wt.prototype.timeoutIds=function(){return Object.keys(this.timeouts)};var Mt=new Wt;function At(e){!function(e,t){var i=_t(e,"_animations");void 0===i?Ct(e,"_animations",[t]):i.push(t)}(e.element,e.id),Mt.animations[e.id]=e,Mt.aniCount+=1}function Dt(e){Mt.frames[e]&&(Mt.frameCount-=1,delete Mt.frames[e])}function Rt(e){Mt.timeouts[e]&&(Mt.timeCount-=1,delete Mt.timeouts[e])}function Pt(e){!function(e,t){var i=_t(e,"_animations");if(void 0!==i){var n=i.indexOf(t);0===n?Nt(e,"_animations"):n>=0&&i.splice(n,1)}}(e.element,e.id),function(e){Mt.animations[e.id]&&(delete Mt.animations[e.id],Mt.aniCount-=1)}(e),e.curAniFrame&&($t(e.curAniFrame),e.curAniFrame=!1),e.doneTimeout&&(Rt(e.doneTimeout),window.clearTimeout(e.doneTimeout),e.doneTimeout=!1)}var jt=0,Vt=function(e,t,i,n){jt+=1,this.id=jt,this.element=e,this.duration=t,this.doneHandler=i,this.label=n,this.startTime=null,this.doneTimeout=!1,this.curAniFrame=!1,this.animator=null,this.doneFunction=null};function Jt(e,t){var i=_t(e,"_animations");if(i&&i.length){i=re(i);for(var n=0;n<i.length;n++){var r=Mt.animations[i[n]];r&&(t?r.done():r.cancel())}}Nt(e,"_animations")}function qt(e,t,i){var n=he(e),r={};for(var o in t)r[o]=Number(ge(o,n[o]));var a=(i=i||{}).duration||Mt.duration,s=i.label||"css.animate",c=new Vt(e,a,i.done,s);c.animator=function(e){this.curAniFrame=!1,this.startTime||(this.startTime=e);var i=e-this.startTime,n=i>=a?1:i/a,o={};for(var s in t){var c=Number(ge(s,t[s]))-r[s];o[s]=de(s,r[s]+c*n)}He(this.element,o),i>=this.duration?this.done():this.curAniFrame=Ft(this.animator,this.label)}.bind(c),a>0?(c.curAniFrame=Ft(c.animator,c.label),c.doneTimeout=window.setTimeout(function(){Rt(c.doneTimeout),c.doneTimeout=!1,Pt(c);var e=Date.now();c.startTime=e-a,c.animator(e)}.bind(c),a),function(e,t){Mt.timeCount+=1,Mt.timeouts[e]=t||"unknown"}(c.doneTimeout,c.label),At(c)):c.animator(Date.now())}function Ft(e,t){var i=xt((function(t){Dt(i),e(t)}));return function(e,t){Mt.frameCount+=1,Mt.frames[e]=t||"unknown"}(i,t),i}function $t(e){e&&(Dt(e),Lt(e))}Vt.prototype.finish=function(){if(Pt(this),this.animator){var e=Date.now();this.startTime=e-this.duration,this.animator(e)}},Vt.prototype.done=function(){if(Pt(this),this.doneHandler)try{this.doneHandler.call(this.element)}catch(e){kt.error("ERROR in animation done handler",e)}},Vt.prototype.cancel=function(){Pt(this)};var Ut=null;function Ht(e){null===Ut&&(Ut=document.createElement("DIV")),Oe(Ut,e);var t=re(Ut.childNodes);return me(t,Ne),t}var Bt=function(e){this.length=0,null==e||("string"==typeof e?e.length>0&&("<"===e.charAt(0)?this.pushAll(Ht(e)):this.pushAll(be(document,e))):void 0!==e.length?this.pushAll(e):this.push(e))};function Gt(e){return new Bt(e)}function zt(e,t){Object.defineProperty(this,"name",{enumerable:!1,writable:!1,value:"AJAXError"}),Object.defineProperty(this,"message",{enumerable:!1,writable:!0,value:e.statusText}),Object.defineProperty(this,"elapsed",{enumerable:!1,writable:!0,value:t}),Object.defineProperty(this,"request",{enumerable:!1,writable:!0,value:e}),z(Error,"captureStackTrace")?Error.captureStackTrace(this,zt):Object.defineProperty(this,"stack",{enumerable:!1,writable:!1,value:new Error(e.statusText).stack})}Bt.prototype.push=function(e){return e&&1===e.nodeType&&(this[this.length]=e,this.length+=1),this},Bt.prototype.pushAll=function(e){for(var t=0;t<e.length;t++)this.push(e[t]);return this},Bt.prototype.each=function(e){for(var t=[],i=arguments.length-1;i-- >0;)t[i]=arguments[i+1];return me.apply(void 0,[this,e].concat(t)),this},Bt.prototype.hasClass=function(e){return this.length>0&&Pe(this[0],e)},Bt.prototype.attr=function(e,t){var i=arguments.length;if(2===i)me(this,Fe,e,t);else if(1===i){var n=this.length>0?qe(this[0],e):null;return null!==n?n:void 0}return this},Bt.prototype.removeAttr=function(e){return me(this,$e,e),this},Bt.prototype.data=function(e,t){var i=arguments.length;if(2===i)me(this,Ct,e,t);else{if(1===i)return 0===this.length?void 0:It(this[0],e);if(0===i)return 0===this.length?void 0:Et(this[0])}return this},Bt.prototype.addClass=function(e){return me(this,Ye,e),this},Bt.prototype.removeClass=function(e){return me(this,Ze,e),this},Bt.prototype.on=function(e,t,i){var n=this,r=arguments.length;return 2===r&&"string"==typeof e&&"function"==typeof t&&e.split(" ").forEach((function(e){e&&me(n,et,e,t)})),3===r&&"string"==typeof e&&"string"==typeof t&&"function"==typeof i&&rt(this,e,ct(t),i,!1),this},Bt.prototype.onPassive=function(e,t,i){var n=arguments.length;return 2===n&&"string"==typeof e&&"function"==typeof t&&me(this,tt,e,t),3===n&&"string"==typeof e&&"string"==typeof t&&"function"==typeof i&&rt(this,e,ct(t),i,!0),this},Bt.prototype.css=function(e,t){var i=arguments.length;if(i>0){var n=typeof e;if(1===i){if("string"===n)return this.length>0?he(this[0])[pt(e)]:null;if(Array.isArray(e)){for(var r={},o=he(this[0]),a=0;a<e.length;a++){var s=e[a];r[s]=o[s]}return r}"object"===n&&me(this,He,e)}if(2===i&&"string"==typeof e){var c=pt(e);me(this,Ue,c,t)}}return this},Bt.prototype.append=function(e){return"string"==typeof e?me(this,Te,e):e instanceof Element&&we(this,Le,e),this},Bt.prototype.replaceWith=function(e){return me(this,ke,e),this},Bt.prototype.prepend=function(e){return"string"==typeof e?me(this,Oe,e):e instanceof Element&&we(this,We,e),this},Bt.prototype.empty=function(){return me(this,xe),this},Bt.prototype.appendTo=function(e){return e instanceof Bt&&e.length>0&&(e=e[0]),me(this,(function(t){Le(e,t)})),this},Bt.prototype.html=function(e){return me(this,Ie,e),this},Bt.prototype.val=function(){return this.length>0?this[0].value||null:void 0},Bt.prototype.text=function(e){var t=arguments.length;if(0===t){var i=[];return me(this,(function(e){e.textContent&&i.push(e.textContent)})),i.join("")}return 1===t&&this.length>0&&(this[0].textContent=e),this},Bt.prototype.prependHtml=function(e){return me(this,Oe,e),this},Bt.prototype.remove=function(){return me(this,Ne),this},Bt.prototype.find=function(e){var t=new Bt;return me(this,(function(i){t.pushAll(be(i,e))})),t},Bt.prototype.closest=function(e){var t=new Bt;return me(this,(function(i){t.push(function(e,t){if(Element.prototype.closest)return e.closest(t);var i=e;do{if(Je(i,t))return i;i=i.parentNode}while(null!==i&&1===i.nodeType);return null}(i,e))})),t},Bt.prototype.first=function(){var e=new Bt;return this.length>0&&e.push(this[0]),e},Bt.prototype.parent=function(){var e=new Bt;return this.length>0&&e.push(this[0].parentNode),e},Bt.prototype.children=function(e){var t=new Bt;return me(this,(function(e){var i=e.childNodes;t.pushAll(i)})),e&&(t=t.filter(e)),t},Bt.prototype.index=function(){return this.length>0?function(e){var t=e.parentNode.childNodes,i=0;for(i=0;i<t.length;i++)if(t[i]===e)return i;return-1}(this[0]):0},Bt.prototype.filter=function(e){var t=new Bt;return me(this,(function(i){Je(i,e)&&t.push(i)})),t},Bt.prototype.not=function(e){var t=new Bt;if("string"==typeof e)me(this,(function(i){Je(i,e)||t.push(i)}));else if(e instanceof Bt){var i=e.length;me(this,(function(n){for(var r=!1,o=0;o<i&&!r;o++)r=n===e[o];r||t.push(n)}))}return t},Bt.prototype.animate=function(e,t){return we(this,qt,e,t),this},Bt.prototype.stop=function(e,t){return me(this,Jt,t),this},Bt.prototype.show=function(){return Xe(this,!0),this},Bt.prototype.hide=function(){return Xe(this,!1),this},Bt.prototype.focus=function(){return we(this,Me),this},Bt.prototype.blur=function(){return we(this,Ae),this},Bt.prototype.height=function(e){return 0===arguments.length?this.length>0?fe(this[0]):0:(me(this,He,{height:e+"px"}),this)},Bt.prototype.width=function(e){return 0===arguments.length?this.length>0?pe(this[0]):0:(me(this,He,{width:e+"px"}),this)},Bt.prototype.sort=function(e){var t=re(this);t.sort(e);for(var i=0;i<this.length;i++)this[i]=t[i];return this},Bt.prototype.detach=function(){return me(this,Ne),this},"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(zt.prototype,Error.prototype):zt.prototype=Object.create(Error.prototype,{constructor:{value:zt}});function Kt(){var e={},t={};var i={retainFor:1e4,timeout:2e4};this.retainFor=function(e){return(e=Number(e))>=0&&(i.retainFor=e),i.retainFor},this.timeout=function(e){return(e=Number(e))>=0&&(i.timeout=e),i.timeout},this.urls=function(){return Object.keys(e)},this.get=function(n,r){r=function(e,t){return t?ut({},e,t):e}(i,r);var o=e[n];if(!o){var a={url:n,method:"GET"};r.crossDomain&&(a.crossDomain=r.crossDomain),r.contentType&&(a.contentType=r.contentType),void 0!==r.data&&(a.data=r.data),r.dataType&&(a.dataType=r.dataType),r.headers&&(a.headers=r.headers);var s=function(){!function(i,n){e[i]===n&&(delete e[i],t[i]&&(clearTimeout(t[i]),delete t[i]))}(n,o)},c=new XMLHttpRequest;if(o=new A((function(e,t){var i=Date.now();c.open("GET",n,!0),r.crossDomain&&(c.withCredentials=!0),c.setRequestHeader("Accept","application/json");var o=!1;r.timeout&&r.timeout>=0&&(c.addEventListener("loadstart",(function(){o=setTimeout((function(){o=!1,c.abort(),t(new Error("Operation timed out"))}),r.timeout)})),c.addEventListener("loadend",(function(){o&&clearTimeout(o)}))),c.addEventListener("load",(function(){c.status>=200&&c.status<400?e(JSON.parse(c.response)):t(new zt(c,Date.now()-i))})),c.addEventListener("error",(function(){t(new zt(c,Date.now()-i))})),c.send()})),e[n]=o,r.retainFor>0){var u=setTimeout(s,r.retainFor);t[n]=u}o.catch((function(){return s(),null}))}return o},this.remove=function(i){delete e[i],t[i]&&(clearTimeout(t[i]),delete t[i])},this.set=function(t,i){e[t]=A.resolve(i)},this.clear=function(){for(var i in t)clearTimeout(t[i]);e={},t={}}}var Qt="function"==typeof CustomEvent?function(e,t){return new CustomEvent(e,{detail:t})}:function(e,t){var i=document.createEvent("CustomEvent");return i.initCustomEvent(e,!1,!1,t),i};function Xt(e,t,i){var n=Qt("GoMoxie:"+e,t);return n.version=i,n}var Yt={kb:1,chat:2,email:3,kbot:2,link:4},Zt={_blank:1,_self:2};function ei(e){var t=e.userAgent;return t.match(/GoogleTV|SmartTV|Internet.TV|NetCast|NETTV|AppleTV|boxee|Kylo|Roku|DLNADOC|CE-HTML/i)?"Desktop":t.match(/Xbox|PLAYSTATION.3|Wii/i)?"Desktop":t.match(/Windows.(NT|XP|ME|9)/)&&!t.match(/Phone/i)||t.match(/Win(9|.9|NT)/i)?"Desktop":t.match(/iPad/i)||t.match(/tablet/i)&&!t.match(/RX-34/i)||t.match(/FOLIO/i)?"Tablet":t.match(/Linux/i)&&t.match(/Android/i)&&!t.match(/Fennec|mobi|HTC.Magic|HTCX06HT|Nexus.One|SC-02B|fone.945/i)?"Tablet":t.match(/Kindle/i)||t.match(/Mac.OS/i)&&t.match(/Silk/i)?"Tablet":t.match(/GT-P10|SC-01C|SHW-M180S|SGH-T849|SCH-I800|SHW-M180L|SPH-P100|SGH-I987|zt180|HTC(.Flyer|_Flyer)|Sprint.ATP51|ViewPad7|pandigital(sprnova|nova)|Ideos.S7|Dell.Streak.7|Advent.Vega|A101IT|A70BHT|MID7015|Next2|nook/i)||t.match(/MB511/i)&&t.match(/RUTEM/i)?"Tablet":t.match(/BOLT|Fennec|Iris|Maemo|Minimo|Mobi|mowser|NetFront|Novarra|Prism|RX-34|Skyfire|Tear|XV6875|XV6975|Google.Wireless.Transcoder/i)?"Mobile":t.match(/Opera/i)&&t.match(/Windows.NT.5/i)&&t.match(/HTC|Xda|Mini|Vario|SAMSUNG-GT-i8000|SAMSUNG-SGH-i9/i)?"Mobile":t.match(/Macintosh|PowerPC/i)&&!t.match(/Silk/i)?"Desktop":t.match(/Linux/i)&&t.match(/X11/i)?"Desktop":t.match(/Solaris|SunOS|BSD/i)?"Desktop":t.match(/Bot|Crawler|Spider|Yahoo|ia_archiver|Covario-IDS|findlinks|DataparkSearch|larbin|Mediapartners-Google|NG-Search|Snappy|Teoma|Jeeves|TinEye/i)&&!t.match(/Mobile/i)?"Desktop":t.match(/CrOS/i)?"Desktop":"Mobile"}function ti(e){return function(){try{return e.apply(this,arguments)}catch(e){kt.error(e)}}}function ii(e,t){var i,n,r,o,a;if(e&&e.rulesEngine&&e.rulesEngine.siteRules&&e.rulesEngine.siteRules.rules)e:for(n=0;n<e.rulesEngine.siteRules.rules.length;n++)if((r=e.rulesEngine.siteRules.rules[n]).id===t){if(r.action&&r.action.success)for(o=0;o<r.action.success.length;o++)if((a=r.action.success[o]).parameters&&a.parameters.rule&&a.parameters.rule.id===t){i=o;break e}break}return i}function ni(e,t){return e.widgetManager.engagementWidgets.widgets[t]}function ri(e){var t=null,i=e.contextMonitor.getLastDevice();if(i)switch(i){case"Desktop":t=1;break;case"Tablet":t=2;break;case"Mobile":t=3}var n={};return n.d=Date.now(),n.u=function(e){return e.cacheManager.getVisitorProfileId()}(e),n.w=t,n.W=1,n.p=e.url,n.q=e.pageTitle,n.v="v1.20.3",n.$="1.1",n["@"]=e.cacheManager.makeEventSerialNumber(),n}function oi(e,t,i,n){var r=ri(e);return r.t=t,r.z=Yt[i],r.r=n.id,r.i=1,r.o=e.currentOfferCreatedAt.toString(),r}function ai(e,t){e.logDisabled||(kt.log("Events.sendToEventService:",t),e.eventService.notifyEventService(t))}function si(e,t){e.logDisabled||(kt.log("Events.sendToEventServiceImmediately:",t),e.eventService.notifyEventServiceImmediately(t))}function ci(e,t,i){var n=function(e,t){var i=ni(e,t);return i&&i.widgetParameters&&i.widgetParameters.rule?i.widgetParameters.rule.id:null}(e,i);if(n){t.r=n;var r=ii(e,n);void 0!==r&&(t.i=r),t.x=function(e,t){var i=ni(e,t),n=2;return i&&i.proactive&&(n=1),n}(e,i)}return t}var ui=ti((function(e,t,i,n,r,o,a,s){var c=ri(e);c.t=t?10:9,n&&(c.a=n.toString()),r&&(c.A=r),o&&(c.S=o.toString()),void 0!==a&&(c.f=a),s&&(c["!"]=s.toString()),ai(e,c=ci(e,c,i))})),li=ti((function(e,t,i,n,r,o){var a=ri(e);a.t=t?17:18,void 0!==n&&(a.S=n.toString()),a=ci(e,a,i),void 0!==r&&(a.f=r),void 0!==o&&(a["!"]=o.toString()),ai(e,a)})),di=ti((function(e,t,i,n){var r=ri(e);r.t=11,void 0!==i&&(r.k=i),void 0!==n&&(r.K=n),(r=ci(e,r,t)).z=Yt[t],ai(e,r)})),gi=ti((function(e,t,i){var n=ri(e);n.t=12,i&&(n.E=parseInt(i,10)),ai(e,n=ci(e,n,t))})),hi=ti((function(e,t,i){var n=ri(e);return n.t=99,void 0!==i&&(n.I=i),n.V=parseFloat(t),si(e,n),n})),fi=ti((function(e,t,i){var n=ri(e);return n.t=5,n.V=parseFloat(t),void 0!==i&&(n.F=i),ai(e,n),n})),pi=ti((function(e,t,i){var n=oi(e,21,t,i);return ai(e,n),n})),vi=ti((function(e,t,i){var n=oi(e,22,t,i);return n["Δ"]=Date.now()-e.currentOfferCreatedAt,ai(e,n),n})),mi=ti((function(e,t,i){var n=oi(e,23,t,i);return n["Δ"]=Date.now()-e.currentOfferCreatedAt,ai(e,n),n})),wi=ti((function(e,t,i,n,r){var o=ri(e);if(o.t=15,void 0!==i&&(o.Q=i),n&&(o.h=parseInt(n,10)),r){o.H=[];for(var a=0;a<r.length;a++){var s={};s.k=r[a].articleId,s.K=r[a].articleTitle,o.H.push(s)}}ai(e,o)})),yi=ti((function(e,t,i,n){var r=ri(e);r.t=16,r=ci(e,r,t),void 0!==i&&(r.f=i),n&&(r["!"]=n.toString()),ai(e,r)})),bi=ti((function(e,t,i,n,r){if(n){var o=ri(e);switch(t){case"service-line-closed":o.t=25;break;case"no-agent-available":o.t=26;break;case"wait-too-long":o.t=27}if(i&&(o["!"]=i.toString()),void 0!==n){o.r=n;var a=ii(e,n);void 0!==a&&(o.i=a)}o.x="proactive"===r?1:2,ai(e,o)}})),Si=ti((function(e,t,i){var n=ri(e);t?(n.t=31,n=ci(e,n,i),void 0!==i&&(n.z=Yt[i])):n.t=30,ai(e,n)})),Ci=ti((function(e){var t=ri(e);t.t=1;var i=e.contextMonitor.getLastBrowseInfo().name;i&&(t.B=i),ai(e,t)})),_i=ti((function(e){var t=ri(e);t.t=2,t.U=window.navigator.userAgent;var i=e.contextMonitor.getLastBrowseInfo().version;i&&(t.b=i);var n=e.contextMonitor.getLastLocation()||{};t.l=n.latitude,t.L=n.longitude,t.C=n.city,t.T=n.state,t.Y=n.country,ai(e,t)})),Ni=ti((function(e){var t=ri(e);t.t=3,ai(e,t)})),Ii=ti((function(e,t){var i=ri(e);i.t=6,i.D=JSON.stringify(t),ai(e,i)})),Ei=ti((function(e,t,i,n,r){var o=ri(t);o.t=e?13:14,o.G=i,o.r=n,o.i=r,ai(t,o)})),Oi=ti((function(e,t,i,n,r,o){var a=ri(e);a.t=20,a.r=t,a.i=i,n&&(a["!"]=n.toString()),r&&(a.z=Yt[r]),a.x="proactive"===o?1:2,ai(e,a)})),Ti=ti((function(e,t,i,n){var r=ri(e);r.t=32,r.r=n,r["^"]=Zt[i],r["&"]=t,r.z=Yt.link,r.x=1,"_self"===i?si(e,r):ai(e,r)}));function ki(e,t){var i=new Xt(e,t,"1.0");return setTimeout((function(){try{window.dispatchEvent(i)}catch(t){kt.log("PublicAPI.broadcast("+e+"): error: "+(t.stack?t.stack:t.message))}})),i}function xi(e,t,i){var n,r,o,a,s,c,u;if(c={cartValue:!1,cartItems:!1},!t||!function(e){return!!(e&&e.session&&e.session.visits&&e.session.visits.length>=1)}(e))return e;if(a=e.session.visits.length-1,o=e.session.visits[a].journey.length-1,void 0!==t.currentCartValue&&(r=Number(t.currentCartValue),isNaN(r)||(e.session.visits[a].journey[o].current_cart_value=r,c.cartValue=r)),void 0!==t.currentCartItems&&(n=(u=t.currentCartItems)&&u.length>0?u.filter((function(e){if("name"in e&&""!==e.name||"sku_or_id"in e&&""!==e.sku_or_id)return!0})):[],e.session.visits[a].journey[o].current_cart_items=n,c.cartItems=n),void 0!==t.transactionTotal&&(s=Number(t.transactionTotal),isNaN(s)||(e.session.end_cart_value=s)),e.last_updated=Date.now(),c.cartValue||c.cartItems){var l=c.cartValue||r,d=c.cartItems||n;ki("cartUpdated",{cartValue:l,cartItems:d}),fi(i,l,d)}return e}function Li(e){return-1!==["link"].indexOf(e)}var Wi="MoxieCache_visitorProfile_lastUpdated";function Mi(e,t){return new A((function(i,n){i(void 0===t?e():e.call(t))}))}function Ai(e){return function(){var t=this,i=[].slice.call(arguments,0);return new A((function(n){n(e.apply(t,i))}))}}function Di(e){try{var t=window[e],i="__test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return!1}}var Ri=new Array(16);for(var Pi,ji,Vi=[],Ji=0;Ji<256;++Ji)Vi[Ji]=(Ji+256).toString(16).substr(1);var qi=0,Fi=0;function $i(e,t,i){var n=t&&i||0,r=t||[],o=(e=e||{}).node||Pi,a=void 0!==e.clockseq?e.clockseq:ji;if(null==o||null==a){var s=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),Ri[t]=e>>>((3&t)<<3)&255;return Ri}();null==o&&(o=Pi=[1|s[0],s[1],s[2],s[3],s[4],s[5]]),null==a&&(a=ji=16383&(s[6]<<8|s[7]))}var c=void 0!==e.msecs?e.msecs:(new Date).getTime(),u=void 0!==e.nsecs?e.nsecs:Fi+1,l=c-qi+(u-Fi)/1e4;if(l<0&&void 0===e.clockseq&&(a=a+1&16383),(l<0||c>qi)&&void 0===e.nsecs&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");qi=c,Fi=u,ji=a;var d=(1e4*(268435455&(c+=122192928e5))+u)%4294967296;r[n++]=d>>>24&255,r[n++]=d>>>16&255,r[n++]=d>>>8&255,r[n++]=255&d;var g=c/4294967296*1e4&268435455;r[n++]=g>>>8&255,r[n++]=255&g,r[n++]=g>>>24&15|16,r[n++]=g>>>16&255,r[n++]=a>>>8|128,r[n++]=255&a;for(var h=0;h<6;++h)r[n+h]=o[h];return t||function(e,t){var i=t||0,n=Vi;return[n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]]].join("")}(r)}function Ui(e){return!0===e?"p":"s"}function Hi(e){return JSON.stringify(e)}function Bi(e){if(void 0!==e)try{return JSON.parse(e)}catch(t){return e}}var Gi=function(){this.name="DefaultStoragePlugin",this.data={p:{},s:{}}};Gi.prototype.destroy=function(){},Gi.prototype.clear=function(){this.data.p={},this.data.s={}},Gi.prototype.has=function(e,t){return z(this.data[Ui(t)],e)},Gi.prototype.set=function(e,t,i){this.data[Ui(i)][e]=t},Gi.prototype.del=function(e,t){delete this.data[Ui(t)][e]},Gi.prototype.get=function(e,t){var i=Ui(t);return z(this.data[i],e)?Bi(this.data[i][e]):null};var zi=["rules_version","uuid","widgets_version"],Ki=["chat-","conclient_","email-","kbot-","kb-","MoxieCache_","moxie"];function Qi(e){if(P(zi,e,0)>=0)return!0;for(var t=0;t<Ki.length;t++)if(0===e.indexOf(Ki[t]))return!0;return!1}function Xi(e){var t,i,n=[];for(i=0;i<e.length;i++)Qi(t=e.key(i))&&n.push(t);for(i=0;i<n.length;i++)e.removeItem(n[i])}var Yi=function(e){this.parentStorage=e,this.name="LocalStorageStoragePlugin",this.skip=["Rules","engagementWidgets"]};Yi.prototype.destroy=function(){this.parentStorage.destroy()},Yi.prototype.has=function(e,t){return!!this.parentStorage.has(e,t)||(!0===t?null!==localStorage.getItem(e):null!==sessionStorage.getItem(e))},Yi.prototype.set=function(e,t,i){if(this.parentStorage.set(e,t,i),!(P(this.skip,e)>=0))if(!0===i)try{localStorage.setItem(e,Hi(t))}catch(t){kt.log("Error setting "+e+": "+t)}else try{sessionStorage.setItem(e,Hi(t))}catch(t){kt.log("Error setting "+e+": "+t)}},Yi.prototype.get=function(e,t){if(this.parentStorage.has(e,t))return this.parentStorage.get(e,t);var i=!0===t?localStorage.getItem(e):sessionStorage.getItem(e);return null!==i&&(i=Bi(i)),i},Yi.prototype.del=function(e,t){this.parentStorage.del(e,t),!0===t?localStorage.removeItem(e):sessionStorage.removeItem(e)},Yi.prototype.clear=function(){this.parentStorage.clear(),Xi(localStorage),Xi(sessionStorage)};var Zi="moxie=".length,en="!--moxie".length,tn=window.top||window;function nn(e){var t="",i="",n=e.indexOf("moxie=");if(n>=0){n>0&&(t=e.slice(0,n));var r=e.indexOf("!--moxie",n+Zi);r>=0?(i=e.slice(n+Zi,r),t+=e.slice(r+en)):i=e.slice("moxie=".length)}return[t,i]}function rn(e){var t=nn(tn.name||"");tn.name=t[0]+"moxie="+JSON.stringify(e)+"!--moxie"}var on=function(e,t){this.name="WindowNameStoragePlugin",this.parentStorage=e,this.clientName=t.clientName,this._data=function(e){var t=nn(tn.name||"")[1],i={};if(t.length>0)try{i=JSON.parse(t)}catch(e){kt.log("JSON: unable to parse window.name value:",t)}return i[e]||(i[e]={p:{},s:{}}),i}(this.clientName);var i,n=this;this.saveItListener||(this.saveItListener=function(){rn(n._data)},tn.addEventListener("unload",this.saveItListener,!1));var r=n._data[this.clientName];for(i in r.p)e.set(i,r.p[i],!0);for(i in r.s)e.set(i,r.s[i],!1)};function an(e){var t=e.widgetManager,i=e.cacheManager;return e._clearingHistoryPromise||(e._clearingHistoryPromise=A.resolve(!0).then((function(){return e.contextMonitor.stop(),t.clearHistory().then((function(){t.destroy()})).then((function(){var t=e.eventService;return e.eventService={clearHistoryStub:!0,notifyEventServiceImmediately:function(){},notifyEventService:function(){}},A.resolve(t.stopEventService())})).then((function(){return A.resolve(i.storagePlugin.clear()).then((function(){i.destroy(),e.cacheManager=null}))})).catch((function(e){throw kt.log("History.clearHistory received an error:",e),e}))}))),e._clearingHistoryPromise}function sn(e){var t=e.userAgent.toString().toLowerCase(),i=e.appName,n=/(dolfin)[ /]([\w.]+)/.exec(t)||/(javafx)[/]([\w.]+)/.exec(t)||/(chrome)[ /]([\w.]+)/.exec(t)||/(opera)(?:.*version)?[ /]([\w.]+)/.exec(t)||/(webkit)(?:.*version)?[ /]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+))?/.exec(t)||["","unknown"];return"webkit"===n[1]?n=/fbav|instagram/.test(t)&&/(iphone|ipad|ipod)/.test(t)?[n[0],"safari",n[2]]:/(iphone|ipad|ipod)\/?\s*(\.?\d+(\.\d+)*)/.exec(t)||/(android)[ /]([\w._-]+);/.exec(t)||[n[0],"safari",n[2]]:"mozilla"===n[1]?/trident/.test(t)?n[1]="MSIE":n[1]="firefox":/polaris|natebrowser|([010|011|016|017|018|019]{3}\d{3,4}\d{4}$)/.test(t)&&(n[1]="Polaris"),[n[1].toLowerCase(),"unknown"===n[2]?[i,window.navigator.appVersion,"-?"]:n[2]]}on.prototype.destroy=function(){this.parentStorage.destroy(),this.saveItListener&&(tn.removeEventListener("unload",this.saveItListener),delete this.saveItListener)},on.prototype.has=function(e,t){return this.parentStorage.has(e,t)},on.prototype.set=function(e,t,i){if(this.parentStorage.set(e,t,i),!this.skipSaveForKey||!this.skipSaveForKey(e)){var n=!1;!0===i?(this._data[this.clientName].p[e]!==t&&(n=!0),this._data[this.clientName].p[e]=t):(this._data[this.clientName].s[e]!==t&&(n=!0),this._data[this.clientName].s[e]=t),n&&rn(this._data)}},on.prototype.get=function(e,t){var i=!0===t?this._data[this.clientName].p[e]:this._data[this.clientName].s[e];if(void 0!==i)try{return JSON.parse(i)}catch(e){return i}return this.parentStorage.has(e,t)?(i=this.parentStorage.get(e,t),this.skipSaveForKey&&this.skipSaveForKey(e)?i:(!0===t?this._data[this.clientName].p[e]=i:this._data[this.clientName].s[e]=i,rn(this._data),i)):null},on.prototype.del=function(e,t){this.parentStorage.del(e,t),!0===t?delete this._data[this.clientName].p[e]:delete this._data[this.clientName].s[e],rn(this._data)},on.prototype.clear=function(){this.parentStorage.clear(),this._data[this.clientName].p={},this._data[this.clientName].s={},rn(this._data)};var cn={},un=0,ln={},dn=0,gn={},hn={};var fn=!1;function pn(){fn||(console.log("Double load of concierge suspected"),fn=!0)}function vn(e,t){var i=++dn;return t.bridgeName="storage_bridge",t.requesterId=e.id,t.requestId=i,t.client=e.concierge.clientName,t.signature="moxie_concierge",e&&e.ifrm&&e.ifrm.contentWindow&&e.ifrm.contentWindow.postMessage?(e.ifrm.contentWindow.postMessage(JSON.stringify(t),"*"),new A((function(e,n){var r=setTimeout((function(){r=!1,n(new Error("TIMEOUT waiting for shared storage."))}),2e3),o=function(){r&&(clearTimeout(r),r=!1)};gn[i]={message:t,resolve:function(t){o(),e(t)},reject:function(e){o(),n(e)}}})).finally((function(){delete gn[i]}))):(pn(),A.resolve(!0))}function mn(e,t){this.useSharedStorage=!1,this.parentStorage=e,this.concierge=t,this.scriptLocation=t.scriptLocation,this.created=Date.now(),this.sharedStorageId=function(e){var t=ln[e];return t||(t="concierge-shared-storage",++un>1&&(t=t+"-"+un),ln[e]=t),t}(this.scriptLocation),this.id=Date.now()}function wn(e){this.name="InvalidArgumentException",this.message=e,this.toString=function(){return this.name+": "+this.message}}function yn(e){return V(e,"_file")&&e.indexOf("profileJSON")<0||"Rules"===e||"engagementWidgets"===e}function bn(e,t,i,n){return A.resolve(e.storagePlugin.set(t,i,n))}mn.prototype.destroy=function(e){e&&this.parentStorage.destroy(),this.ifrm.remove(),this.removeListener?(this.removeListener(),delete this.ifrm):pn()},mn.prototype.init=function(){var e=this;if(cn[this.id]=this,this.data={p:{},s:{}},e.ifrm=ye(e.sharedStorageId),!e.ifrm){e.ifrm=document.createElement("iframe"),e.ifrm.setAttribute("id",e.sharedStorageId),e.ifrm.setAttribute("tabindex","-1");var t=e.scriptLocation+"/client/storage_bridge.html";e.ifrm.setAttribute("src",t);var i=function(t){if("."===e.scriptLocation||0===e.scriptLocation.indexOf(t.origin)){var i={};try{i="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){}if(i&&"storage_bridge"===i.bridgeName){var n,r,o,a=e;if(i.requesterId&&cn[i.requesterId]&&(a=cn[i.requesterId]),i.requesterId===a.id)i.error?(n=i.requestId,r=new Error("Error from shared storage: "+i.error.message),(o=gn[n])?o.reject(r):kt.log("SharedStorageBridge: rejectRequest("+n+", "+JSON.stringify(r)+") cannot find outstanding request")):"updated"===i.request?(kt.log("CONCIERGE StoragePlugin update: ",i),"moxie_cc"!==i.key||i.newValue||an(e.concierge).catch((function(e){kt.log("ERROR clearing history"+e)}))):function(e,t){var i=gn[e];i?i.resolve(t):kt.log("SharedStorageBridge: resolveRequest("+e+", "+JSON.stringify(t)+") cannot find outstanding request")}(i.requestId,i);else kt.log('CONCIERGE StoragePlugin request ID mismatch: plug in "'+a.id+'" receved an event for "'+i.requesterId+'"')}}};e.removeListener=function(){window.removeEventListener("message",i,!1)},hn[e.scriptLocation]=new A((function(t){e.ifrm.onload=function(e){e.target&&e.target.src&&t(e)}})).then((function(){window.addEventListener("message",i,!1)})),e.ifrm.style.display="none",document.body.appendChild(e.ifrm)}return hn[e.scriptLocation].then((function(){var t="safari"===sn(window.navigator)[0];return vn(e,{request:"init",shadowInSessionStorage:t}).then((function(t){for(var i in t.lsValue)e.parentStorage.set(i,t.lsValue[i],!0);for(var n in t.ssValue)e.parentStorage.set(n,t.ssValue[n],!1);e.useSharedStorage=!0}),(function(t){throw kt.log("SharedStoragePlugin#init: Failed to load from shared storage, removing listener: "+t.message),e.removeListener(),t}))}))},mn.prototype.name="SharedStoragePlugin",mn.prototype.has=function(e,t){return this.parentStorage.has(e,t)},mn.prototype.get=function(e,t){return this.parentStorage.get(e,t)},mn.prototype.clear=function(){this.parentStorage.clear();return vn(this,{request:"clear"}).then((function(e){return"ack"===e.request}))},mn.prototype.set=function(e,t,i){if(this.parentStorage.set(e,t,i),!this.skipSaveForKey||!this.skipSaveForKey(e))return vn(this,{request:"store",key:e,value:t,persist:!0===i}).then((function(e){return"ack"===e.request}))},mn.prototype.del=function(e,t){return this.parentStorage.del(e,t),vn(this,{request:"remove",key:e,persist:!0===t}).then((function(e){return"ack"===e.request}))};var Sn=0;function Cn(e){this.id=++Sn,this.concierge=e,this.storagePlugin=this.defaultStoragePlugin=new Gi;var t=Di("sessionStorage");Di("localStorage")&&t?(this.storagePlugin=new Yi(this.defaultStoragePlugin),this.storagePluginToLoad="SharedStorage"):this.storagePluginToLoad="window.name",this.eventSerialNumber=null,this.saveEventSerialNumber=null,t&&(this.saveEventSerial=this.storeEventSerialNumberSessionStorage,this.eventSerialNumber=this.readEventSerialNumberFromSessionStorage())}function _n(e,t,i){return A.resolve(e.storagePlugin.del(t,i))}function Nn(e){return"MoxieCache_"+e+"_file"}function In(e){if(e&&(delete e.last_updated,delete e.last_submitted,e.session&&e.session.visits)){var t=e.session.visits.length-1;if(t>=0){var i=e.session.visits[t].journey;if(i){var n=i.length-1;n>=0&&(e.session.visits[t].journey[n].end_time=0)}}}}function En(e){var t=Nn("profileJSON");return function(e,t){return A.resolve(e.storagePlugin.get(t,!0)).then((function(e){return e?void 0===e.contents?(kt.log("Loaded "+t+" from localStorage, but .contents was undefined"),null):(kt.log("Loaded "+t+" from localStorage"),e.contents):null}))}(e,t).then((function(e){if(null!==e)try{return JSON.parse(e)}catch(e){kt.log("Error parsing profile: "+e.message)}return null})).then((function(t){if(null!==t)return e.setData("profileJSON",JSON.stringify(t),!0)})).then((function(){return e}))}function On(e){return function(e){return e.storagePlugin.get("moxie_cc",!0)||e.storagePlugin.get("uuid",!0)}(e)?e.autoLoadProperties().then(En).then((function(){return e})):function(e){kt.log("Creating new identity");var t=e.makeProfileId();return A.all([bn(e,"uuid",t,!0),bn(e,"moxie_cc",t+"|2147483647",!0)]).then((function(){return e.uuid=t,e}))}(e).then(En).then((function(){return e}))}Cn.prototype.storeEventSerialNumberSessionStorage=function(e){window.sessionStorage.setItem("moxie_concierge_event_serial_number",JSON.stringify(e))},Cn.prototype.readEventSerialNumberFromSessionStorage=function(){var e=window.sessionStorage.getItem("moxie_concierge_event_serial_number");if(null==e||""===e)return null;var t=null;try{t=JSON.parse(e)}catch(e){return kt.log("Could not read serial number from session storage: "+e.message),null}return"number"!=typeof t?null:Math.floor(t)!==t?null:t<0||t>4294967295?null:t},Cn.prototype.makeEventSerialNumber=function(){null===this.eventSerialNumber&&(this.eventSerialNumber=Math.floor(Math.random()*(Math.pow(2,32)-1)));var e=this.eventSerialNumber++;return this.saveEventSerial&&this.saveEventSerial(this.eventSerialNumber),this.eventSerialNumber>4294967295&&(this.eventSerialNumber=0),e},Cn.prototype.cleanup=function(){delete this.profileJSON,delete this.uuid},Cn.prototype.destroy=function(){this.cleanup(),this.storagePlugin.destroy()},Cn.prototype.skipSaveForKey=yn,Cn.prototype.isValidUserProfile=function(e){return void 0!==e.session&&void 0!==e.session.id},Cn.prototype.getVisitorProfileId=function(){return this.getDataClone("uuid")},Cn.prototype.emitEvent=function(e){var t;return"function"==typeof CustomEvent?t=new CustomEvent(e):(t=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!0,{}),kt.log("CacheManager: emitting profile update event: "+JSON.stringify(t)),this.dispatchEvent(window,t)},Cn.prototype.dispatchEvent=function(e,t){return e.dispatchEvent(t)},Cn.prototype.resetVisitorProfile=function(){var e=this;return this.concierge.contextMonitor.stop(),_n(this,Nn("profileJSON"),!0).then((function(){e.visitorProfile=null;var t=e.concierge.contextMonitor.createNewProfile();return e.setData("profileJSON",JSON.stringify(t))})).then((function(){e.concierge.contextMonitor.start()}))},Cn.prototype.setData=Ai((function(e,t,i){if(!Z(t))throw new wn("Cannot set "+e+", data must be a string.");if("profileJSON"===e){var n,r=this.getDataClone("profileJSON");try{n=JSON.parse(t)}catch(t){throw new wn("Cannot set "+e+", data is invalid JSON.")}var o=!1,a=!i&&function(e,t){var i=!1;if(e&&e.session&&e.session.visits&&e.session.visits.length>0){var n=e.session.visits.slice(-1)[0];if(n.journey&&n.journey.length>0){var r=n.journey.slice(-1)[0];new Date-new Date(r.end_time)>60*t*1e3&&(i=!0)}else i=!0}else i=!0;return i}(r,30),s=!1;if(i||null!=r){if(void 0!==n.customData)if(r&&void 0!==r.customData)JSON.stringify(r.customData)!==JSON.stringify(n.customData)&&(s=!0);else s=!0}else o=!0,void 0!==n.customData&&(s=!0);return o&&Ci(this.concierge),a&&_i(this.concierge),s&&Ii(this.concierge,n.customData),this.storeProfile(t)}if(e===Wi)return this[Wi]=t,bn(this,Wi,t,!0);if("rules_version"===e)return this.rules_version=t,bn(this,"rules_version",t,!0);if("widgets_version"===e)return this.widgets_version=t,bn(this,"widgets_version",t,!0);throw new wn("Cannot set "+e+", unknown property.")})),Cn.prototype.storeProfile=Ai((function(e){var t,i=JSON.parse(e);if(this.isValidUserProfile(i)){this.profileJSON=i;var n=(t=0,{contents:e,timestamp:(new Date).getTime(),version:t});return bn(this,Nn("profileJSON"),n,!0)}throw new wn("Cannot store profile, it is not valid.")})),Cn.prototype.setVolatileData=Ai((function(e,t){if("moxie_channels_custom_data"===e||"moxie_channels_form_data"===e)return this[e]=t;throw new wn("Cannot set "+e+".")})),Cn.prototype.getVolatileData=function(e){return this[e]},Cn.prototype.profileUpdated=function(e){var t=this.getDataClone("profileJSON"),i=B(e);return In(i),In(t),JSON.stringify(t)!==JSON.stringify(i)},Cn.prototype.getData=function(e){var t=this[e];return t?"object"==typeof t?B(this[e]):this[e]:null},Cn.prototype.getDataClone=function(e){return this.getData(e)},Cn.prototype.getDataObject=function(e){return this[e]?this[e]:null},Cn.prototype.removeClientCache=function(e,t){return _n(this,"conclient_"+e,t)},Cn.prototype.setClientCache=function(e,t,i){return bn(this,"conclient_"+e,t,i)},Cn.prototype.getClientCache=function(e,t){return this.storagePlugin.get("conclient_"+e,t)},Cn.prototype.removeWidgetCache=function(e,t,i){return _n(this,e+"-"+t,i)},Cn.prototype.setWidgetCache=function(e,t,i,n){return bn(this,e+"-"+t,i,n)},Cn.prototype.getWidgetCache=function(e,t,i){return this.storagePlugin.get(e+"-"+t,i)},Cn.prototype.clearWidgetCacheKey=function(e,t){for(var i=[],n=this.storagePlugin;n.parentStorage;)n=n.parentStorage;var r,o=t?"p":"s",a=Object.keys(n.data[o]);for(r=0;r<a.length;r++)V(a[r],e)&&i.push(_n(this,a[r],t));return A.all(i)},Cn.prototype.init=function(){var e=this;if(!this.ready){var t,i=A.resolve(e);"window.name"===e.storagePluginToLoad?(e.storagePlugin=new on(e.storagePlugin,e.concierge),e.storagePlugin.skipSaveForKey=yn):"SharedStorage"===e.storagePluginToLoad&&(t=new mn(e.storagePlugin,e.concierge),i=i.then((function(){return t.init()})).then((function(){e.storagePlugin=t,t.skipSaveForKey=yn})).catch((function(e){t&&t.destroy(!1),kt.log("FAILED to initialize the SharedStoragePlugin falling back to using regular localStorage: "+e.message)})).then((function(){return e}))),this.ready=i}return this.ready.then(On)};var Tn=function(e,t){A.resolve(e.storagePlugin.get(t,!0)).then((function(i){e[t]=i}))};Cn.prototype.autoLoadProperties=function(){var e=this,t=[];return t.push(e.storagePlugin.get("moxie_cc",!0)),t.push(e.storagePlugin.get("uuid",!0)),t.push(Tn(e,Wi)),t.push(Tn(e,"rules_version")),t.push(Tn(e,"widgets_version")),A.all(t).then((function(t){var i,n=t[0],r=t[1];return i=n?n.split("|").shift():r,e.uuid=i,e}))},Cn.prototype.makeProfileId=function(){return $i()};var kn=null,xn=null,Ln=null;function Wn(e){this.monitoredRules=[],this.concierge=e,this.rulesEngine=e.rulesEngine,this.cacheManager=e.cacheManager,this.moxieData=window.MoxieData||{},this.getLastLocation=function(){return kn},this.getLastDevice=function(){return xn},this.getLastBrowseInfo=function(){return Ln};var t=0,i=0;this.nextMonitorId=function(){return++i},this.start=function(){var e=this;t=setInterval((function(){e.poll()}),1e3)},this.stop=function(){t>0&&(clearInterval(t),t=0)}}Wn.prototype.cleanup=function(){this.stop()},Wn.prototype.evalRules=function(){this.monitoredRules.forEach((function(e){this.rulesEngine.evalRule(e)&&(this.rulesEngine.queueActions(e),this.unregister(e),e.monitor=!1)}),this)},Wn.prototype.fetchLocation=function(){return this.concierge.httpGet(this.concierge.serviceUrl.location,{type:"GET"}).then((function(e){var t=e.subdivisions&&e.subdivisions.length?e.subdivisions[0].names.en:"";return{city:e.city?e.city.names.en:"",state:t,country:e.country?e.country.names.en:"",ip_address:"",zip:"",longitude:e.location?e.location.longitude:"",latitude:e.location?e.location.latitude:""}}))},Wn.prototype.recordEngagementValue=function(){var e=this.cacheManager.getDataClone("profileJSON"),t=U(H(e,1),1).current_cart_value;return void 0===e.session.first_engagement_cart_value&&(e.session.dirty=!0,e.session.first_engagement_cart_value=t),void 0===e.session.visits[e.session.visits.length-1].first_engagement_cart_value&&(e.session.visits[e.session.visits.length-1].first_engagement_cart_value=t),this.cacheManager.setData("profileJSON",JSON.stringify(e))},Wn.prototype.parseMappedContext=function(e){if(void 0!==e){"string"==typeof e&&(e=[e]);var t=function(e,t){t.replace(/^\$\[/,"").replace(/\]\$$/,"");var i=Gt(_e(t)),n=i.text()||i.val();return n?n.trim():""};for(var i in e)z(e,i)&&"string"==typeof e[i]&&(e[i]=e[i].replace(/\$\[(.*?)\]\$/g,t));return e}},Wn.prototype.initTracking=function(){var e,t=0,i=0,n=this.cacheManager.getDataClone("profileJSON"),r=!1,o=!1,a=sn(navigator);Ln={name:a[0],version:a[1]},xn=ei(navigator);var s=Number(this.cacheManager.getData(Wi)),c=this;if(null==n)(n={id:this.cacheManager.getData("uuid"),dirty:!0,tags:null,ip_address:"",all_device_names:[],all_browsers:[{name:Ln[0],version:Ln[1],language:navigator.language}],all_locations:null,preferences:{never_invite_to_chat:!1,language:navigator.language},session:null,history:{visits:0,last_visit:Date.now(),articles_viewed:0,invited_chat:0,refused_chat:0},last_updated:Date.now(),last_submitted:0}).all_device_names.push(xn),r=!0,o=!0;else{if(Number(U(H(n,1),1).end_time)<s&&(t=n.session.visits.length-1,e=n.session.visits[t].journey.length-1,n.session.visits[t].journey[e].end_time=s,n.last_updated=s),!0!==n.session.transaction_completed&&!0!==this.moxieData.transactionComplete||(this.moxieData.transactionComplete&&(n.session.transaction_completed=this.moxieData.transactionComplete=!0,n.session.end_cart_value=this.moxieData.transactionTotal,ki("transactionCompleted",{transactionTotal:this.moxieData.transactionTotal,cart:{value:this.moxieData.currentCartValue,items:this.moxieData.currentCartItems}}),hi(this.concierge,this.moxieData.transactionTotal),this.cacheManager.setData("profileJSON",JSON.stringify(n))),void 0!==this.moxieData.customData&&this.concierge.publicAPI.customData(this.concierge,this.moxieData.customData),n.session=null),void 0!==n.session&&null!==n.session&&void 0!==n.session.visits){var u=$(U(H(n,0)).start_time);(u>2592e3||isNaN(u))&&(n.session=null)}null!==n.session&&0!==n.session.visits.length&&((i=$(U(H(n,1),1).end_time))>1800||isNaN(i))&&(o=!0)}if(null===n.session||void 0===n.session){var l={};l.id=$i(),l.visits=[],l.dirty=!0,l.end_cart_value=0,n.session=l,r=!0,o=!0}if(o){var d={};d.id=$i(),d.dirty=!0,d.journey=[],d.browser={name:Ln[0],version:Ln[1],language:navigator.language},d.device={},d.device.name=ei(navigator),d.referral={url:document.referrer.substr(0,200)},d.journey=[],n.session.visits.push(d),n.history.visits+=1,r=!0}var g={};g.id=$i(),g.dirty=!0,g.url=this.concierge.url.substr(0,200),g.title=this.concierge.pageTitle.substr(0,200),g.start_time=Date.now(),g.end_time=Date.now(),g.referral={url:document.referrer.substr(0,200)};var h=U(H(n,1),1),f=h&&h.current_cart_value?h.current_cart_value:0;if(void 0!==this.moxieData.customData&&this.concierge.publicAPI.customData(this.concierge,this.moxieData.customData),void 0!==this.moxieData.currentCartValue){g.current_cart_value=this.moxieData.currentCartValue;var p=this.moxieData.currentCartItems||(h&&h.current_cart_items?h.current_cart_items:[]);ki("cartUpdated",{cartValue:this.moxieData.currentCartValue,cartItems:p}),fi(this.concierge,this.moxieData.currentCartValue,p)}else g.current_cart_value=f;if(void 0!==this.moxieData.currentCartItems){var v;for(g.current_cart_items=[],v=0;v<this.moxieData.currentCartItems.length;v++)g.current_cart_items.push({name:this.moxieData.currentCartItems[v].name?this.moxieData.currentCartItems[v].name:"",sku_or_id:this.moxieData.currentCartItems[v].skuOrId,value:this.moxieData.currentCartItems[v].value,quantity:this.moxieData.currentCartItems[v].quantity,uom:this.moxieData.currentCartItems[v].uom,description:this.moxieData.currentCartItems[v].description})}else{var m=h&&h.current_cart_items?h.current_cart_items:[];g.current_cart_items=B(m)}t=n.session.visits.length-1;return n.history.last_visit=Date.now(),(r?this.fetchLocation().then((function(e){kn=e,G(n,"ip_address",e.ip_address),G(n.session,"ip_address",e.ip_address);var i=!0;if(n.all_locations)for(var r=0;r<n.all_locations.length;r++)if(n.all_locations[r].city===e.city){i=!1;break}i&&(n.all_locations=n.all_locations||[],n.all_locations.push(e)),o&&(n.session.visits[t].ip_address=e.ip_address,n.session.visits[t].location=e)})).catch((function(e){kt.log("Failed to fetch location: "+JSON.stringify(e))})):A.resolve()).then((function(){return n.session.visits[t].journey.push(g),c.cacheManager.setData("profileJSON",JSON.stringify(n)).then((function(){return{rules:1,widgets:c.concierge.configuration.widgets.version}}))}))},Wn.prototype.createNewProfile=function(){var e=Date.now();return{last_updated:e,last_submitted:0,history:{last_visit:e},session:{id:$i(),dirty:!0,visits:[{journey:[{id:$i(),dirty:!0,start_time:e,end_time:e,title:this.concierge.pageTitle.substr(0,200),url:this.concierge.url.substr(0,200),current_cart_value:0,current_cart_items:[]}]}],transaction_completed:!1,end_cart_value:0}}},Wn.prototype.poll=function(){var e=Date.now(),t=this;Mi((function(){t.evalRules();var i=[];if(i.push(t.cacheManager.setData(Wi,e.toString(),!0)),"function"==typeof document.hasFocus&&document.hasFocus()){var n=t.cacheManager.getDataClone("profileJSON"),r=n.session.visits.length-1,o=n.session.visits[r].journey.length-1;n.session.visits[r].journey[o].end_time=e,n.last_updated=e,i.push(t.cacheManager.setData("profileJSON",JSON.stringify(n)))}return A.all(i)})).catch((function(e){kt.log("ContextMonitor.poll: error "+(e.stack?e.stack:e.message))}))},Wn.prototype.register=function(e){e.monitor&&!e.monitorId&&(e.monitorId=this.nextMonitorId(),this.monitoredRules.push(e))},Wn.prototype.unregister=function(e){if(e.monitor&&void 0!==e.monitorId)for(var t=e.monitorId,i=0;i<this.monitoredRules.length;i++)if(this.monitoredRules[i].monitorId===t){this.monitoredRules.splice(i,1),e.monitorId=!1;break}},Wn.prototype.tagProfile=function(e,t){var i=this.cacheManager.getData("profileJSON");i.tags=i.tags||[];var n={status:!1,tags:e.tag.filter((function(e){return-1===i.tags.indexOf(e)}))};return n.tags.length&&(i.tags=i.tags||[],i.tags=i.tags.concat(n.tags),this.cacheManager.setData("profileJSON",JSON.stringify(i)),n.status=!0),n},Wn.prototype.removeProfileTag=function(e,t){var i=this.cacheManager.getData("profileJSON");i.tags=i.tags||[];var n={status:!1,tags:e.tag.filter((function(e){return-1!==i.tags.indexOf(e)}))};return n.tags.length&&(i.tags=i.tags.filter((function(e){return-1===n.tags.indexOf(e)})),0===i.tags.length&&(i.tags=null),this.cacheManager.setData("profileJSON",JSON.stringify(i)),n.status=!0),n};var Mn=function(e){this.concierge=e};function An(e,t){return e.then((function(e){try{var i=t(e);void 0!==i&&(e=i)}catch(e){kt.error("Error in callback function: "+e)}return e}))}Mn.prototype.log=function(e){kt.log(e)},Mn.prototype.location=function(){return this.concierge.scriptLocation+"/widgets/"+this.concierge.assetVersion.widgets+"/translation.json"},Mn.prototype.navigator=function(){return navigator},Mn.prototype.htmlElement=function(){return document.documentElement},Mn.prototype.sanitizeLang=function(e){return e=(e=e.toLowerCase()).replace("_","-")},Mn.prototype.parentLang=function(e){return e?e.split("-").slice(0,-1).join("-"):""},Mn.prototype.detectLanguage=function(){var e=this.navigator(),t=this.htmlElement(),i=this.sanitizeLang(t.getAttribute("lang")||t.getAttribute("xml:lang")||e.languages&&e.languages[0]||e.language||e.userLanguage||this.data.defaultLanguage||"en");return this.log("Language: "+i),i},Mn.prototype.getValue=function(e,t){var i=this.data.sourceLangs[e];return!(!i||!z(this.data.langs[i],t))&&this.data.langs[i][t]},Mn.prototype.translate=function(e,t){for(var i=this.data.selectedLanguage,n=!1,r=!1;i;){if(!1!==(n=this.getValue(i,e)))return n;i===this.data.defaultLanguage&&(r=!0),(i=this.parentLang(i))||r||(i=this.data.defaultLanguage)}return t||"__"+e+"__"},Mn.prototype.handleJSONResponse=function(e){this.data=e,e.selectedLanguage=this.detectLanguage(),e.defaultLanguage=this.sanitizeLang(e.defaultLanguage);for(var t={},i=Object.keys(e.langs),n=0;n<i.length;n++)t[this.sanitizeLang(i[n])]=i[n];e.sourceLangs=t,this.concierge.langOptions={defaultLanguage:e.defaultLanguage,selectedLanguage:e.selectedLanguage}},Mn.prototype.init=function(){this.handleJSONResponse(this.concierge.configuration.translations)};var Dn=function(){this.callbacks=[]};function Rn(e){this.concierge=e,this.names={}}function Pn(){this.isRunning=!1,this.whenDone=A.resolve(!0),this.queue=[]}function jn(e){kt.log("ActionQueue: Error thrown from run promise, "+JSON.stringify(e))}function Vn(e){this.addWidget=function(t,i,n){return e.widgetManager.addWidget(i,{id:t.id,action:n,name:t.name,source:t.source})},this.removeWidget=function(t,i,n){return e.widgetManager.removeWidget(i,{id:t.id,action:n,name:t.name})},this.notify=function(t,i,n){return e.widgetManager.notify(i,{id:t.id,action:n,name:t.name,source:t.source})},this.tagProfile=function(t,i,n){return e.contextMonitor.tagProfile(i,{id:t.id,action:n,name:t.name,source:t.source})},this.removeProfileTag=function(t,i,n){return e.contextMonitor.removeProfileTag(i,{id:t.id,action:n,name:t.name,source:t.source})}}function Jn(e){var t=e.cacheManager,i=e.rulesEngine;this.visitorProfileHasTag={func:function(e,i,n){for(var r=t.getData("profileJSON"),o=0;o<n.tag.length;o++)if(r.tags&&-1!==r.tags.indexOf(n.tag[o]))return!0;return!1}},this.visitorProfileDoesNotHaveTag={func:function(e,i,n){for(var r=t.getData("profileJSON"),o=0;o<n.tag.length;o++)if(r.tags&&-1!==r.tags.indexOf(n.tag[o]))return!1;return!0}},this.visitsToSite={func:function(e,i,n){var r,o=t.getData("profileJSON"),a=F(o.history.visits,i,n.visits),s=!0;if(a&&n.last_visit){var c=U(H(o,1),2,2,!1);(void 0===c||void 0===c.end_time||$(c.end_time,r)/86400>n.last_visit)&&(s=!1)}return a&&s}},this.currentCartValue={func:function(e,i,n){return F(U(H(t.getData("profileJSON"),1),1).current_cart_value,i,n.value)}},this.productInCart={func:function(e,i,n){for(var r=U(H(t.getData("profileJSON"),1),1),o=0;o<r.current_cart_items.length;o++)for(var a=0;a<n.name.length;a++)if(F(r.current_cart_items[o].name,i,n.name[a]))return!0;return!1}},this.userDeviceName={func:function(e,i,n){for(var r=H(t.getData("profileJSON"),1),o=0;o<n.device.length;o++)if(F(r.device.name,i,n.device[o]))return!0;return!1}},this.userBrowserName={func:function(e,i,n){return F(H(t.getData("profileJSON"),1).browser.name,i,n.browser)}},this.secondsOnCurrentPage={func:function(e,i,n){var r=U(H(t.getData("profileJSON"),1),1);return F($(Date.now(),r.start_time),i,n.seconds)}},this.secondsOnSite={func:function(e,i,n){var r=H(t.getData("profileJSON"),1),o=U(r,0);return F($(U(r,1).end_time,o.start_time),i,n.seconds)}},this.secondsFromLastVisit={func:function(i,n,r){for(var o=H(t.getData("profileJSON"),1),a=-1,s=o.journey.length-1-1;s>=0;s--){var c=U(o,2,s);if(c.url===e.url){a=$(Date.now(),c.end_time);break}}return-1!==a&&F(a,n,r.seconds)}},this.numberOfPagesVisited={func:function(e,i,n){return F(H(t.getData("profileJSON"),1).journey.length,i,n.pages)}},this.geographicLocation={func:function(e,i,n){for(var r=H(t.getData("profileJSON"),1),o=JSON.parse(n.locations),a=0;a<o.length;a++){var s=o[a],c=!s.city_name||s.city_name===r.location.city,u=!s.subdivision_name||s.subdivision_name===r.location.state,l=s.country_name===r.location.country;if(c&&u&&l)return!0}return!1}},this.excludedGeographicLocation={func:function(e,i,n){for(var r=H(t.getData("profileJSON"),1),o=JSON.parse(n.locations),a=0;a<o.length;a++){var s=o[a],c=!s.city_name||s.city_name===r.location.city,u=!s.subdivision_name||s.subdivision_name===r.location.state,l=s.country_name===r.location.country;if(c&&u&&l)return!1}return!0}},this.numberOfTimesPageViewed={func:function(i,n,r){for(var o=H(t.getData("profileJSON"),1),a=0,s=o.journey.length-1;s>=0;s--){U(o,2,s).url===e.url&&a++}return F(a,n,r.views)}},this.referralURL={func:function(e,i,n){for(var r=U(H(t.getData("profileJSON"),1),1).referral.url,o=0;o<n.url.length;o++)if(F(r,i,n.url[o]))return!0;return!1}},this.notReferralURL={func:function(e,i,n){for(var r=U(H(t.getData("profileJSON"),1),1).referral.url,o=0;o<n.url.length;o++)if(!F(r,i,n.url[o]))return!1;return!0}},this.lastPageVisitedURL={func:function(e,i,n){for(var r=U(H(t.getData("profileJSON"),1),2),o=0;o<n.url.length;o++)if(F(r.url,i,n.url[o]))return!0;return!1}},this.lastPageVisitedTitle={func:function(e,i,n){for(var r=U(H(t.getData("profileJSON"),1),2),o=0;o<n.title.length;o++)if(F(r.title,i,n.title[o]))return!0;return!1}},this.previouslyVisitedURL={func:function(e,i,n){for(var r=H(t.getData("profileJSON"),1),o=r.journey.length-1,a=0;a<o;a++)for(var s=U(r,2,a),c=0;c<n.url.length;c++)if(F(s.url,i,n.url[c]))return!0;return!1}},this.previouslyVisitedTitle={func:function(e,i,n){for(var r=H(t.getData("profileJSON"),1),o=r.journey.length-1,a=0;a<o;a++)for(var s=U(r,2,a),c=0;c<n.title.length;c++)if(F(s.title,i,n.title[c]))return!0;return!1}},this.enterFormData={event:{change:function(e){e.data.rule.state=!0,i.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&i.queueActions(e.data.ruleset),e.data.rule.state=!1}},func:function(e,t,i){if(e.state){var n=Gt(_e(i.element));return F(n.val()||n.text(),t,i.value)}return!1}},this.editForm={event:{change:function(e){e.data.rule.element=e.target,e.data.rule.state=!0,i.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&i.queueActions(e.data.ruleset),e.data.rule.state=!1,e.data.rule.element=null}},func:function(e,t,i){if(e.state){var n=Gt(_e(e.element));return F(n.val()||n.text(),t,i.value)}return!1}},this.selectedElementValue={event:{change:function(e){i.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&i.queueActions(e.data.ruleset)}},func:function(e,t,i){var n=Gt(_e(i.element)).find("option:checked");return F(n.val()||n.text(),t,i.value)}},this.clickedOnButton={event:{"touchend click":function(e){e.data.rule.state=!0,i.evalRule(e.data.ruleset)&&e.data.ruleset.action.success&&i.queueActions(e.data.ruleset),e.data.rule.state=!1}},func:function(e,t,i){return void 0!==e.state&&e.state}},this.elementExists={func:function(e,t,i){for(var n=0;n<i.element.length;n++)if(Gt(_e(i.element[n])).length)return!0;return!1}},this.elementValue={func:function(e,t,i){for(var n,r=0;r<i.element.length;r++)if(F((n=Gt(_e(i.element[r]))).val()||n.text(),t,i.value))return!0;return!1}},this.customValue={func:function(e,t,i){return F(window.MoxieData[i.name],t,i.value)}}}function qn(e){this.pageUrl={func:function(t,i,n){for(var r=0;r<n.url.length;r++)if(F(e.url,i,n.url[r]))return!0;return!1}},this.userPlatformName={func:function(e,t,i){for(var n=0;n<i.platform.length;n++)if(F("web",t,i.platform[n]))return!0;return!1}},this.pageTitle={func:function(t,i,n){for(var r=0;r<n.title.length;r++)if(F(e.pageTitle,i,n.title[r]))return!0;return!1}},this.notPageUrlOrTitle={func:function(t,i,n){for(var r=0,o=0;o<n.exclusions.length;o++){var a=n.exclusions[o];switch(a.type){case"url":for(var s=0;s<a.values.length;s++)if(!F(e.url,a.operator,a.values[s])){r++;break}break;case"title":for(var c=0;c<a.values.length;c++)if(!F(e.pageTitle,a.operator,a.values[c])){r++;break}}}return r!==n.exclusions.length}}}function Fn(e){this.siteRules=null,this.concierge=e,this.actionQueue=new Pn,this.rulesSucceeded={},this.categorySucceeded={notify:{},addWidget:{},removeWidget:{},tagProfile:{},removeProfileTag:{}}}Dn.prototype.add=function(e){this.callbacks.push(e)},Dn.prototype.doCallbacksAsync=function(e){for(var t=A.resolve(e),i=0;i<this.callbacks.length;i++)t=An(t,this.callbacks[i]);return t},Dn.prototype.doCallbacksSync=function(e){for(var t=0;t<this.callbacks.length;t++)try{var i=this.callbacks[t](e);void 0!==i&&(e=i)}catch(e){kt.error("Error in callback function: "+e)}return e},Rn.prototype.getServiceLines=function(){var e,t;return this.linesPromise||(this.linesPromise=(e=this.concierge,t=e.serviceUrl.connector+"/connector/channels/service_lines",e.httpGet(t).then((function(e){for(var t={},i=e.response,n=0;n<i.length;n+=1)t[i[n].id]=i[n].name;return t})).catch((function(e){throw kt.log("Error in fetchServiceLines"+e),e})))),this.linesPromise},Rn.prototype.setName=function(e,t){this.names[e]=A.resolve(t)},Rn.prototype.getName=function(e){return this.names[e]?this.names[e]:this.getServiceLines().then((function(t){return t[e]})).catch((function(){}))},Pn.prototype={done:function(){return 0===this.queue.length?(this.isRunning=!1,this.finishedRunning&&this.finishedRunning(!0),!0):this.next()},enqueue:function(e){return this.queue.unshift(e),this.run()},next:function(){var e=this,t=this.queue.pop();return Mi((function(){var e=A.resolve(t.func(t.params.rule,t.params.parameters,t.params.type));return t.postAction?t.postAction(e):e})).catch((function(e){kt.log("ActionQueue: Error thrown while executing action, "+t.label+"; "+e.message+"; "+JSON.stringify(e))})).finally((function(){return e.done()}))},run:function(){var e=this;return!e.isRunning&&e.queue.length>0&&(e.isRunning=!0,e.whenDone=new A((function(t){e.finishedRunning=t})),setTimeout((function(){return e.isRunning?e.next().catch(jn):null}))),this.whenDone}},Fn.prototype.ActionLibrary=Vn,Fn.prototype.CriteriaLibrary=Jn,Fn.prototype.ScopeLibrary=qn;var $n=function(e,t,i){try{return e.definition.func(e,e.operator,e.parameters)}catch(e){return kt.log('Moxie Concierge Client: Critieria Eval Error ("'+i.name+'" criteria:'+t+"): "+e.message),!1}};function Un(e,t){var i=t.definition;if(i&&"string"==typeof i){var n=i.split(".");if(2===n.length){var r=e[n[0]][n[1]];void 0!==r&&(t.definition=r)}}var o=t.operator;if(o&&"string"==typeof o){var a=o.split(".");if(3===a.length){var s=D[a[2]];void 0!==s&&(t.operator=s)}}if(t.parameters&&t.parameters.exclusions&&t.parameters.exclusions.length>0)for(var c=t.parameters.exclusions,u=0;u<c.length;u++)Un(e,c[u])}function Hn(e,t){t=t||{},this.concierge=e,this.isValid=this.validateParams(t),this.config=t}function Bn(e,t){t&&(t.conciergeV2=this,e.isTestMode&&(this.root=e)),this.broadcast=Bn.broadcast,this.transactionComplete=function(t){return e.ready.then((function(){var i,n,r,o;return i=e.cacheManager,(r=i.getDataClone("profileJSON")).last_updated=Date.now(),r.session.transaction_completed=!0,void 0!==t&&(r=xi(r,t,e),o=t.vendorTxnId),n=U(H(r,1),1),e.contextMonitor.stop(),i.setData("profileJSON",JSON.stringify(r),!0).then((function(){return ki("transactionCompleted",{transactionTotal:r.session.end_cart_value,cart:{value:n.current_cart_value,items:n.current_cart_items}}),hi(e,r.session.end_cart_value,o),e.contextMonitor.initTracking().then((function(){e.contextMonitor.start()}))}))}))},this.updateSession=function(t){return e.ready.then((function(){var i,n;return t=t||{},n=xi((i=e.cacheManager).getDataClone("profileJSON"),t,e),i.setData("profileJSON",JSON.stringify(n))}))},this.startEngagement=function(t){return e.ready.then((function(){var i=e.widgetManager;if(!t||"string"!=typeof t.widget)throw kt.log("GoMoxie.concierge.startEngagement: missing required configuration parameter"),new Error("GoMoxie.concierge.startEngagement: missing required configuration parameter");if(Li(t.widget))return A.reject(new Error("The engagement type is not allowed: "+t.widget));if(!i.engagementWidgets.widgets[t.widget])throw kt.log('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"'),new Error('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"');if(!i.isValidEngagementConfig(t))throw kt.log("GoMoxie.concierge.startEngagement: invalid widget configuration"),new Error("GoMoxie.concierge.startEngagement: invalid widget configuration");return i.startExternal("externalAPI",t)}))},this.closeNotification=function(t){return e.ready.then((function(){var i=e.widgetManager;i.notificationDisplayed()&&i.closeNotification(!t)}))},this.startTrackingEngagement=function(t){return e.ready.then((function(){new Hn(e,t).startEngagement()}))},this.updatePage=function(t,i){var n=null;return e.ready.catch((function(){return!1})).then((function(){return e.eventService.clearHistoryStub||(n=e.eventService),e.contextMonitor.stop(),e.cacheManager&&e.cacheManager.cleanup(),e.widgetManager.destroy(),null})).then((function(){return e.prepare(t,i,{eventService:n}),e.init()})).then((function(){return function(e){delete e._clearingHistoryPromise}(e),null}))},this.clearHistory=function(){var t=e.loadState;if("READY"!==t&&"LOADING"!==t)return A.reject(new Error("Invalid State: "+t+". Can only be invoked in READY or LOADING states."));function i(){return e.loadState="CLEARING",an(e)}return e.loadState="CLEARING",("READY"===t?i():e.apiReady.then(i)).then((function(){return e.loadState="CLEARED",null}))};var i={},n=function(e){return e.status},r=function(e){return kt.log("checkAvailability error thrown: "+e.message),!1};this.checkAvailability=function(t,o){return e.ready.then((function(){if("chat"===t&&void 0===o.portalId)return e.rulesEngine.actionQueue.whenDone})).then((function(){var a={parameters:o},s=e.widgetManager,c="availability";if("chat"===t){if(void 0===o.portalId){var u=s.engagementWidgets.widgets.chat.portalId;if(void 0===u)throw new Error("No Moxie portal/mailbox ID specified for engagement.");a.parameters.portalId=u}a.ruleSettings=e.rulesEngine.getSiteSettings(),c+="|"+o.portalId+"|"+s.device}var l=s.engagementWidgets.widgets[t],d=Date.now(),g=i[c];return g&&g.timeout>d?g.value:(g={timeout:d+5e3,value:l.checkAvailability(a).then(n,r)},i[c]=g,g.value)}))},this.customData=function(t){return e.ready.then((function(){var i=e.cacheManager,n=i.getDataClone("profileJSON");if(void 0===n)throw new Error("Could not find visitor profile.");if(void 0===t)return n.customData;if(!JSON.stringify(t))throw new Error("Could not stringify customData");return n.customData=t,i.setData("profileJSON",JSON.stringify(n)).then((function(){return t}))}))},this.channelsData=function(t){return e.ready.then((function(){var i=e.cacheManager;return void 0===t?i.getVolatileData("moxie_channels_custom_data"):i.setVolatileData("moxie_channels_custom_data",t)}))},this.channelsFormData=function(t){return e.ready.then((function(){var i=e.cacheManager;return void 0===t?i.getVolatileData("moxie_channels_form_data"):i.setVolatileData("moxie_channels_form_data",t)}))},this.onQuestionnaireLoaded=function(t){e.onQuestionnaireLoadedCallbacks.add(t)},this.onQuestionnaireSubmit=function(t){e.onQuestionnaireSubmitCallbacks.add(t)}}function Gn(){function e(e){return e.status}function t(e){return kt.log("checkAvailability error thrown: "+e.message),"false"}this.broadcast=Gn.broadcast,this.transactionComplete=function(e,t){var i,n,r;return i=e.cacheManager,(r=i.getDataClone("profileJSON")).last_updated=Date.now(),r.session.transaction_completed=!0,void 0!==t&&(r=xi(r,t,e)),n=U(H(r,1),1),e.contextMonitor.stop(),i.setData("profileJSON",JSON.stringify(r),!0).then((function(){return Gn.broadcast("transactionCompleted",{transactionTotal:r.session.end_cart_value,cart:{value:n.current_cart_value,items:n.current_cart_items}}),hi(e,r.session.end_cart_value),e.contextMonitor.initTracking().then((function(){e.contextMonitor.start()}))}))},this.updateSession=function(e,t){var i,n;t=t||{},n=xi((i=e.cacheManager).getDataClone("profileJSON"),t,e),i.setData("profileJSON",JSON.stringify(n))},this.startEngagement=function(e,t){var i,n,r={};if(n=e.widgetManager,t&&"string"==typeof t.widget){if(Li(t.widget))throw new Error("The engagement type is not allowed: "+t.widget);if(n.engagementWidgets.widgets[t.widget]){if(n.isValidEngagementConfig(t)){for(i in z(t,"enableChatDeflection")&&!0===t.enableChatDeflection&&(t.widget="kbot"),t)z(t,i)&&(r[i]=t[i]);var o={name:t.ruleName,source:"externalAPI",id:-2,action:"success"};return r.rule=o,n.addWidget(t,o).then((function(){!1!==n.openWidget&&n.openWidget!==t.widget&&n.hideWidget(!0),n.notificationDisplayed()&&n.closeNotification(),n.showWidget(t.widget,r),n.showConcierge(),n.widgetsType.openConcierge()}))}kt.log("GoMoxie.concierge.startEngagement: invalid widget configuration")}else kt.log('GoMoxie.concierge.startEngagement: invalid value for configuration parameter "widget"')}else kt.log("GoMoxie.concierge.startEngagement: missing required configuration parameter")},this.closeNotification=function(e,t){var i=e.widgetManager;i.notificationDisplayed()&&i.closeNotification(!t)},this.startTrackingEngagement=function(e,t){new Hn(e,t).startEngagement()},this.updatePage=function(e,t,i){var n;return e.ready.catch((function(){return!1})).then((function(){return e.eventService.stub||(n=e.eventService),e.contextMonitor.stop(),e.cacheManager.cleanup(),e.widgetManager.destroy(),null})).then((function(){return e.init(t,i,{eventService:n})}))},this.checkAvailability=function(i,n,r,o){var a,s,c,u,l,d,g,h,f,p;if(a={parameters:r},s=i.cacheManager,c=i.widgetManager,h=r.portalId,u="availability",l="availability-timestamp","chat"===n){if(void 0===h){if(void 0===(g=c.engagementWidgets.widgets.chat.portalId))return void kt.log("No Moxie portal/mailbox ID specified for engagement.");h=g,a.parameters.portalId=h}a.ruleSettings=i.rulesEngine.getSiteSettings(),u+="|"+h+"|"+c.device,l+="|"+h+"|"+c.device}return d=c.engagementWidgets.widgets[n],p=1e5,(f=s.getWidgetCache(n,l,!1))&&(p=(Date.now()-f)/1e3),(f&&p<=5&&s.getWidgetCache(n,u,!1)?A.resolve(s.getWidgetCache(u)):d.checkAvailability(a).then(e,t).then((function(e){return A.all([s.setWidgetCache(n,u,e,!1),s.setWidgetCache(n,l,Date.now(),!1)]).then((function(){return e}))}))).then((function(e){return o(e),e}))},this.customData=function(e,t){var i,n;return n=(i=e.cacheManager).getDataClone("profileJSON"),void 0===t?void 0!==n?n.customData:void 0:!!JSON.stringify(t)&&(n.customData=t,i.setData("profileJSON",JSON.stringify(n)),!0)},this.channelsData=function(e,t){var i=e.cacheManager;if(void 0===t)return i.getVolatileData("moxie_channels_custom_data");try{i.setVolatileData("moxie_channels_custom_data",t)}catch(e){return kt.log("channelsData: "+e),!1}return!0},this.channelsFormData=function(e,t){var i=e.cacheManager;if(void 0===t)return i.getVolatileData("moxie_channels_form_data");try{i.setVolatileData("moxie_channels_form_data",t)}catch(e){return kt.log("Error: "+e),!1}return!0},this.onQuestionnaireLoaded=function(e,t){e.onQuestionnaireLoadedCallbacks.add(t)},this.onQuestionnaireSubmit=function(e,t){e.onQuestionnaireSubmitCallbacks.add(t)},this.registerMethods=function(e,t){void 0!==t&&void 0!==t.concierge&&(t.concierge.updateSession=this.updateSession.bind(void 0,e),t.concierge.transactionComplete=this.transactionComplete.bind(void 0,e),t.concierge.startEngagement=this.startEngagement.bind(void 0,e),t.concierge.checkAvailability=this.checkAvailability.bind(void 0,e),t.concierge.customData=this.customData.bind(void 0,e),t.concierge.closeNotification=this.closeNotification.bind(void 0,e),t.concierge.channelsData=this.channelsData.bind(void 0,e),t.concierge.channelsFormData=this.channelsFormData.bind(void 0,e),t.concierge.startTrackingEngagement=this.startTrackingEngagement.bind(void 0,e),t.concierge.onQuestionnaireLoaded=this.onQuestionnaireLoaded.bind(void 0,e),t.concierge.onQuestionnaireSubmit=this.onQuestionnaireSubmit.bind(void 0,e),t.concierge.updatePage=this.updatePage.bind(void 0,e),e.isTestMode&&(t.concierge.root=e))}}function zn(e){return e.signature="moxie_concierge",e}Fn.prototype.init=function(e){this.siteRules=e,this.actionLibrary=new Vn(this.concierge),this.criteriaLibrary=new Jn(this.concierge),this.scopeLibrary=new qn(this.concierge);for(var t=0;t<this.siteRules.rules.length;t++)for(var i=this.siteRules.rules[t],n=0;n<i.criteria.length;n++){var r=i.criteria[n];Un(this,r);for(var o=!0,a=0;a<i.scope.length;a++)Un(this,i.scope[a]),$n(i.scope[a])||(o=!1);var s=Date.now();if((void 0!==i.start&&i.start>s||void 0!==i.end&&i.end<s)&&(o=!1),o&&(i.monitor&&this.concierge.contextMonitor.register(i),r.definition.event)){var c=function(e){var t=r.definition.event[e],n={ruleset:i,rule:r};Gt(_e(r.parameters.element)).on(e,(function(e){e.data=n,t(e)}))};for(var u in r.definition.event)c(u)}}},Fn.prototype.getSiteRules=function(){return this.siteRules||{}},Fn.prototype.getSiteSettings=function(){return this.siteRules.settings||{}},Fn.prototype.queueWaitTime=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.queue_wait_time>=0?this.siteRules.settings.queue_wait_time:5},Fn.prototype.minTimeBetween=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.min_time_between>=0?this.siteRules.settings.min_time_between:60},Fn.prototype.hideWhenServiceLineClosed=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.hide_on_demand_chat_when_service_line_is_closed},Fn.prototype.checkQueueWaitTimeForReactive=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.use_min_time_between_for_on_demand_chat},Fn.prototype.checkQueueWaitTimeForProactive=function(){return this.siteRules&&this.siteRules.settings&&this.siteRules.settings.use_min_time_between_for_proactive_chat},Fn.prototype.run=function(){var e,t,i;for(e=[],t=0;t<this.siteRules.rules.length;t++){var n=this.siteRules.rules[t];i=this.evalRule(n),e.push({ruleset:n,success:i}),i&&n.action.success&&this.queueActions(n)}return e},Fn.prototype.evalRule=function(e){var t,i;if(this.rulesSucceeded[e.id])return!1;if(i=Date.now(),void 0!==e.start&&e.start>i||void 0!==e.end&&e.end<i)return!1;for(t=0;t<e.scope.length;t++)if(!$n(e.scope[t]))return!1;for(t=0;t<e.criteria.length;t++)if(!$n(e.criteria[t],t,e))return!1;return e.action.success&&(this.rulesSucceeded[e.id]=!0),!0},Fn.prototype.isRedundantAction=function(e,t,i,n){if("tagProfile"===e||"removeProfileTag"===e)return!1;if(n)return!1;for(var r=0;r<i.length;r++)if(i[r].definition&&i[r].definition.event)return!1;return this.categorySucceeded[e][t]||this.categorySucceeded.removeWidget[t]},Fn.prototype.isRemoveOk=function(e){return this.categorySucceeded.addWidget[e]||this.categorySucceeded.notify[e]},Fn.prototype.queueActions=function(e){var t,i,n,r=e.criteria,o=void 0!==e.monitorId,a=this.concierge.cacheManager.getDataClone("profileJSON"),s=["addWidget","notify","tagProfile","removeProfileTag"];if(e.action&&e.action.success)for(var c=0;c<e.action.success.length;c++)if(i=(t=e.action.success[c]).actionFunc,n=-1!==s.indexOf(i)&&function(e,t,i,n,r,o){return o.then((function(i){if(i&&i.status)if("addWidget"===t||"notify"===t){var o=null;i.parameters&&i.parameters.serviceLineId&&(o=i.parameters.serviceLineId);var a=null;i.parameters&&i.parameters.widget&&(a=i.parameters.widget);var s="reactive";"notify"===t&&(s="proactive"),Oi(e,n,r,o,a,s)}else if("tagProfile"===t||"removeProfileTag"===t){Ei("tagProfile"===t,e,i.tags,n,r)}return null}))}.bind(void 0,this.concierge,i,a,e.id,c),!(this.isRedundantAction(i,t.parameters.widget,r,o)||"removeWidget"===i&&this.isRemoveOk(t.parameters.widget)))try{this.actionQueue.enqueue({label:e.name+":"+c+":"+i,func:this.actionLibrary[i],params:{rule:e,parameters:this.concierge.contextMonitor.parseMappedContext(t.parameters),type:"success"},postAction:n}),this.categorySucceeded[i][t.parameters.widget]=!0}catch(t){kt.log('Moxie Concierge Client: Action Function Error ("'+e.name+'" action:'+c+"): "+t.message)}},Hn.prototype.createEngagementRecord=function(e){var t,i;for(t in i={chat:null,decision_type:"",email:null,id:$i(),kb:null,name:e.engagementType,proactive:!1,rule:{name:e.ruleName,source:"externalAPI",id:-2,ruleAction:"success"},time:Date.now(),type:2},e)"engagementType"!==t&&"ruleName"!==t&&z(e,t)&&(i[t]=e[t]);return i},Hn.prototype.setEngagementRecord=function(e){var t,i,n,r;n=(r=(t=this.concierge.cacheManager).getDataClone("profileJSON")).session.visits.length-1,i=r.session.visits[n].journey.length-1,r.session.visits[n].journey[i].engagements||(r.session.visits[n].journey[i].engagements=[]),r.session.visits[n].journey[i].engagements.push(e),t.setData("profileJSON",JSON.stringify(r))},Hn.prototype.startEngagement=function(){return this.isValid?(this.setEngagementRecord(this.createEngagementRecord(this.config)),!0):(kt.log("GoMoxie.concierge.startTrackingEngagement: unable to start engagement that had an invalid configuration"),!1)},Hn.prototype.validateParams=function(e){var t,i;for(t in i=!0,"object"==typeof e&&e.engagementType&&e.ruleName||(kt.log("GoMoxie.concierge.TrackingEngagement.validateParams: missing required configuration parameter"),i=!1),e)z(e,t)&&"string"!=typeof e[t]&&(kt.log("GoMoxie.concierge.TrackingEngagement.validateParams: invalid engagement parameter: "+t),i=!1);return i},Bn.broadcast=ki,Gn.broadcast=ki;var Kn=[" ","\n","\t"];function Qn(){this.outputRaw=[],this.outputSub=[],this.currentSub=null,this.state=1,this.compiled=[],this.actions=[]}function Xn(e){var t=new Qn;return t.compile(e),function(e){return t.evaluate(e)}}function Yn(e){return 9===e}function Zn(e){return 13===e}function er(e){return 32===e}function tr(e){return 38===e}function ir(e){return 40===e}function nr(e){return"chat"===e}function rr(e){return"kbot"===e}function or(e){return nr(e)||rr(e)}function ar(e){return rr(e)?"chat":e}Qn.prototype.compile=function(e){var t,i;for(t=0;t!==e.length;t++)switch(i=e[t],this.state){case 1:this.handleStateInput(i);break;case 2:this.handleStateOpen(i);break;case 4:this.handleStateSubOperator(i);break;case 3:this.handleStateSubInit(i);break;case 5:this.handleStateSub(i);break;case 6:this.handleStateSubFinal(i);break;case 7:this.handleStateClose(i)}var n=[],r=null;for(t=0;t!==this.outputRaw.length;t++)null===(i=this.outputRaw[t])?null!==r&&(n.push([r,t]),r=null):null===r&&(r=t);null!==r&&n.push([r,this.outputRaw.length]),this.outputSub.reduce((function(e,t){return null!==t&&e.push(t),e}),[]);var o=0;for(t=0;t!==n.length;t++){r=n[t][0];for(var a=n[t][1];o!==r;o++)this.actions.push(2),this.compiled.push(this.outputSub[o]);this.compiled.push(this.outputRaw.slice(r,a).join("")),o=a,this.actions.push(1)}this.outputRaw=null,this.outputSub=null},Qn.prototype.evaluate=function(e){for(var t,i=[],n=0;n!==this.actions.length;n++){switch(this.actions[n]){case 1:i.push(this.compiled[n]);break;case 2:null!=(t=e[this.compiled[n]])&&i.push(t)}}return i.join("")},Qn.prototype.handleStateInput=function(e){"<"===e?this.state=2:(this.outputRaw.push(e),this.outputSub.push(null))},Qn.prototype.handleStateOpen=function(e){"%"===e?this.state=4:(this.outputRaw.push("<"),this.outputRaw.push(e),this.outputSub.push(null),this.outputSub.push(null),this.state=1)},Qn.prototype.handleStateSubOperator=function(e){if("="!==e)throw new Error("Operator for the template must be '=', not '"+e+"'");this.state=3},Qn.prototype.handleStateSubInit=function(e){-1===Kn.indexOf(e)&&(this.currentSub=[e],this.state=5)},Qn.prototype.handleStateSub=function(e){if(-1===Kn.indexOf(e))return"%"===e?(this.finishSub(),void(this.state=7)):void this.currentSub.push(e);this.finishSub(),this.state=6},Qn.prototype.finishSub=function(){this.outputSub.push(this.currentSub.join("")),this.outputRaw.push(null),this.currentSub=null},Qn.prototype.handleStateSubFinal=function(e){if(-1===Kn.indexOf(e)){if("%"!==e)throw new Error("Stray character '"+e+"' after substitution");this.state=7}},Qn.prototype.handleStateClose=function(e){if(">"!==e)throw new Error("Invalid sequence '"+e+"' after closing percent sign");this.state=1};var sr=function(e){e.$notifAnimate&&(e.$notifAnimate.stop(!0,!0),delete e.$notifAnimate),e.$areaAnimate&&(e.$areaAnimate.stop(!0,!0),delete e.$areaAnimate),e.conciergePendingUpdate&&($t(e.conciergePendingUpdate),delete e.conciergePendingUpdate)},cr=function(e){return 0===e.tabStyle.cascade},ur=function(e){return!!e.engagementWidgets.globalSettings.singleChannelMode},lr=function(e,t){var i=t.index();if(i<0)return 0;cr(e)||(i=t.parent().children("li").length-(i+1));return i+1},dr=function(e,t,i){var n=e.widgetsType.getNotification(),r=t.children("ul").first(),o=r.height(),a=r.children("li").length,s={display:"block",height:o+65},c={opacity:1},u={opacity:0};if(cr(e)?(c.top=40,u.top=-(50*a-10),s.top=25):(c.bottom=-10,u.bottom=-(o+30),s.bottom=25),r.data("animating")?(r.stop(),n.stop()):(r.css(c),t.addClass("con-animating")),t.css(s),r.data("animating",!0).animate(u,{label:"desktopWidgetsClose",done:function(){t.removeAttr("style"),t.removeClass("con-animating"),r.removeAttr("style").data("animating",!1)}}),e.widgetsType.notificationDisplayed){sr(i);var l={};l[cr(e)?"top":"bottom"]=0,n.animate(l,{label:"desktopNotificationSlideClosed"})}},gr=function(e,t,i){var n=t.find(".con-notch"),r={},o=lr(e,i);return r[cr(e)?"top":"bottom"]=function(e,t){return ur(e)?13:65*t+13}(e,o),"tab-widgets-content"===e.state?(n.animate(r,{label:"adjustNotch"}),!1):(n.css(r),!0)},hr=function(e){var t=e.$concierge;e.engagementWidgets.globalSettings.hideMoxieBranding&&t.addClass("hide-moxie")},fr=function(e,t){"object"==typeof window.visualViewport&&e.widgetsType.resetKeyboardOffset();var i=e.$concierge.find("#concierge-widget-area");"tab-widgets-content"===e.state&&(i.hasClass("con-animating")?i.stop():i.css({opacity:1,right:75,display:"block"}),t.css({display:"block"}),i.addClass("con-animating").removeClass("con-open").animate({opacity:0,right:50},{label:"desktopCloseArea",done:function(){delete e.widgetsType.$areaAnimate,i.removeAttr("style"),i.removeClass("con-animating"),t.removeAttr("style")}}),e.state="tab-widgets",e.widgetsType.$areaAnimate=i)},pr=function(e){var t=e.$concierge.find("#concierge-widgets"),i=e.$concierge.find("#concierge-tab");"tab"===e.state?(e.$concierge.addClass("with-widgets").removeClass("con-closed"),i.addClass("con-pressed"),i.attr("aria-expanded","true"),e.state="tab-widgets",function(e,t,i){var n=null;e.widgetsType.notificationDisplayed&&(n=e.widgetsType.getNotification());var r=t.children("ul").first(),o=r.height(),a=r.children("li").length,s={height:o+50+15},c={opacity:0},u={opacity:1};if(cr(e)?(c.top=-(50*a-10),u.top=40,s.top=25):(c.bottom=-(o+30),u.bottom=-10,s.bottom=25),r.data("animating")?(r.stop(),n.stop()):(r.css(c),t.css(s),t.addClass("con-animating")),r.data("animating",!0).animate(u,{label:"desktopWidgetsOpen",done:function(){t.removeAttr("style"),t.removeClass("con-animating"),r.removeAttr("style").data("animating",!1)}}),n){var l={},d=n.data("parameters"),g=e.$concierge.find("#concierge-widgets ul li[data-widget="+d.widget+"]"),h=65*lr(e,g);1===g.length&&(l[cr(e)?"top":"bottom"]=h),n.animate(l,{label:"desktopNotificationSlideOpen",done:function(){delete i.$notifAnimate}}),i.$notifAnimate=n}}(e,t,this)):"tab-widgets-content"===e.state?(e.$concierge.find("#concierge-widget-area").removeClass("con-open"),i.removeClass("con-pressed"),i.attr("aria-expanded","false"),e.$concierge.removeClass("with-widgets"),vr(e),e.state="tab",dr(e,t,this),e.$concierge.addClass("con-closed")):(i.removeClass("con-pressed"),i.attr("aria-expanded","false"),e.$concierge.removeClass("with-widgets"),e.state="tab",dr(e,t,this),e.$concierge.addClass("con-closed"))},vr=function(e){var t=e.$concierge.find("#concierge-widgets li.con-active");t.removeClass("con-active").removeClass("con-pressed"),t.find(".con-notch").remove(),t.find(".con-icon").attr("aria-expanded","false");var i=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active");e.openWidget&&e.hideWidget(!1),fr(e,i)},mr=function(e,t,i,n,r){if(i||(i=e.$concierge.find("#concierge-widgets li[data-widget="+t+"]")),!i.hasClass("con-active")){i.addClass("con-active").addClass("con-pressed"),i.find(".con-icon").attr("aria-expanded","true");var o=n.rule.source;return r&&"offer"!==o&&"notification"!==o&&(n.rule.source="internal"),A.resolve(e.showWidget(t,n,r))}e.openWidget&&e.hideWidget(!1)},wr=function(){var e=Gt(this);e.addClass("con-pressed"),e.data("pressing",1),"concierge-tab"===e.attr("id")&&e.attr("aria-expanded","true"),e.find(".con-icon")&&e.find(".con-icon").attr("aria-expanded","true")},yr=function(){var e=Gt(this);1===e.data("pressing")&&(e.data("pressing",0),e.removeClass("con-pressed"),e.find(".con-icon")&&e.find(".con-icon").attr("aria-expanded","false"),"concierge-tab"===e.attr("id")&&e.attr("aria-expanded","false"))},br=function(){return'<div id="concierge" class="con-right con-closed<%= CON_CLOSED %>">\n  <button id="concierge-tab" type="button" aria-label="<%= CONCIERGE %>" aria-expanded="false" aria-haspopup="true">\n    <%= CONCIERGE_TAB_ICON_SVG %>\n  </button>\n  <div id="concierge-widgets"><ul id="concierge-widgets-ul"<%= CON_ROLE_ATTRIBUTE %>></ul></div>\n  <div id="concierge-widget-area" tabindex="0" role="dialog" aria-live="assertive" aria-label=""><div class="con-notch"><div class="con-notch-inner"></div></div></div>\n\n  <div id="con-notification" class="con-inactive" role="alert" aria-live="assertive">\n  \x3c!--\n    CON-5221: Don\'t include (causes JAWS and NVDA to read twice):\n    aria-labelledby="con-notification-title" aria-describedby="con-notification-body"\n  --\x3e\n    <div class="con-notch"><div class="con-notch-inner"></div></div>\n    <h2 id="con-notification-title" class="concierge-notification-title" aria-hidden="true" tabindex="0">Live Chat</h2>\n    <div class="con-notification-content">\n      <div class="con-notification-icon" aria-live="off" aria-hidden="true"></div>\n      <div id="con-notification-body" aria-hidden="true">\n      \x3c!--\n        CON-5221: Don\'t include (causes JAWS to skip reading):\n        aria-live="polite" aria-atomic="true"\n      --\x3e\n        <div class="con-notification-body" tabindex="0"></div>\n        <div class="con-notification-helptext"><%=NOTIFICATION_ANNOUNCE%></div>\n      </div>\n      <div class="con-notification-calltoaction" role="link" tabindex="0"></div>\n    </div>\n    <button class="con-x" aria-label="<%= CLOSE_ICON %>">\n      <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n        <title><%= CLOSE_ICON %></title>\n        <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n      </svg>\n    </button>\n  </div>\n</div>\n'};function Sr(e){this.html=br,this.cssType="desktop",this.notificationDisplayed=!1,this.visualViewportHasScroll=!1,this.visualViewportHasResize=!1,this.start=function(){var n=this,r=e.$concierge.find("#concierge-tab"),o=e.$concierge.find("#concierge-widgets");r.on("mousedown",wr),r.onPassive("touchstart",wr),r.on("mouseleave",yr);var a=function(t){("click"===t.type||Zn(t.which))&&("click"===t.type&&r.removeClass("highlight"),Gt(this).removeClass("con-pressed").data("pressing",0).attr("aria-expanded","false"),Si(e.concierge,!1),ki("bellClicked",{}),e.toggleWindow())};r.on("click",a),r.on("keypress",a),r.on("keyup",(function(e){Yn(e.which)?Gt(this).addClass("highlight"):tr(e.which)?t(Gt(this)):ir(e.which)&&i(Gt(this))})),r.on("blur",(function(){Gt(this).removeClass("highlight")})),rt(o,"mousedown",st("li"),wr),rt(o,"touchstart",st("li"),wr,!0),rt(o,"mouseleave",st("li"),yr);var s=function(t){("click"===t.type||Zn(t.which))&&(Gt(this).removeClass("con-pressed").data("pressing",0),Gt(this).find(".con-icon").attr("aria-expanded","false"),e.closeNotification(!0),Mi((function(){return function(e,t){var i=Gt(t.target).closest("li"),n=i.data("widget"),r=ar(n),o=function(e,t,i){var n=e.engagementWidgets.widgets[t];return n&&0!==n.state&&n.proactive&&i.data("parameters.proactive")?i.data("parameters.proactive"):i.data("parameters.reactive")||i.data("parameters.proactive")}(e,n,i);return i.removeClass("highlight"),(o=o||{}).rule=o.rule||{},o.rule.source="button",Mi((function(){if(!i.hasClass("con-active"))return mr(e,n,i,o);e.hideWidget(!1)})).then((function(){return Si(e.concierge,!0,o.widget),ki("buttonClicked",{buttonName:r}),null}))}(e,t)})).catch((function(e){kt.log((e.stack,e.stack))})))};rt(o,"click",st("li"),s),rt(o,"keypress",st("li"),s);var c=function(t){if("click"===t.type||Zn(t.which)||er(t.which)){var i=Gt(t.target);if(i.hasClass("con-x")||i.closest(".con-x").length>0)e.closeNotification(!1);else{n.closeNotification(!0);var r=n.getNotification(),o=r.data("parameters"),a=r.data("engagementId"),s=e.engagementWidgets.widgets[o.widget];s&&s.shouldDisplayBell()&&e.$concierge.hasClass("con-closed")&&(e.toggleWindow(),e.state="tab-widgets"),void 0===s.execute?(o.rule?e.broadcastCloseProactiveNotification(o,"accepted"):o.rule={source:"notification"},e.showWidget(o.widget,o,a),e.$concierge.find("#concierge-tab").focus()):s.execute(e,o)}}};e.$concierge.find("#con-notification").on("click",c).on("keypress",c)},this.toggleWindow=function(){pr.call(this,e)},this.focusWidgetButton=function(t){e.$concierge.find("#concierge-widgets li[data-widget="+t+"] .con-icon").focus()};this.makeWidgetActive=function(e){e.addClass("con-active")},this.makeWidgetInactive=function(e){e.removeClass("con-active")},this.openWidget=function(t){var i=e.$concierge.find("#concierge-widget-area");!function(e,t){var i={kb:"K B Engagement Widget",chat:"Live Chat",kbot:"Live Chat",email:"Email Engagement Widget"}[e]||"";t.attr("aria-label",i)}(t,i);var n=e.$concierge.find("#concierge-widget-"+t),r=i.children(".concierge-widget.con-active").not(n);function o(){Gt(this).removeAttr("style")}this.makeWidgetInactive(r),this.makeWidgetActive(n),e.$concierge.find("#concierge-widgets li.con-active").removeClass("con-active").removeClass("con-pressed"),e.$concierge.find("#concierge-widgets li.con-active .con-icon").attr("aria-expanded","false"),"Tablet"===e.device&&n.find("iframe.widget-content").css({overflow:"auto"});var a=e.$concierge.find("#concierge-widgets li[data-widget="+t+"]");a.addClass("con-active").addClass("con-pressed"),a.find(".con-icon").attr("aria-expanded","true"),"tab-widgets-content"===e.state&&r.length>0&&(kt.log("openWidget(): invoked and willHide sent to already opened widget -"+r.data("widget")),hr(e),e.postMessageToWidget(r.data("widget"),"willHide"),n.css({opacity:.3}).animate({opacity:1},{label:"desktopOpenWidget",done:o}),r.css({display:"block",position:"absolute",top:2,height:"calc(100% - 4px)",width:"100%","padding-right":"4px",opacity:1,"z-index":100}).animate({opacity:0},{label:"desktopCloseWidget",done:o})),function(e,t){var i=e.$concierge.find("#concierge-widget-area");gr(e,i,t)&&(i.hasClass("con-animating")?i.stop():i.css({opacity:0,right:50,display:"inline-block"}),hr(e),i.addClass("con-animating").addClass("con-open").animate({opacity:1,right:75},{label:"desktopOpenArea",done:function(t,n){delete e.widgetsType.$areaAnimate,i.removeAttr("style"),i.removeClass("con-animating"),n||"object"!=typeof window.visualViewport||e.widgetsType.applyKeyboardOffset()}})),e.state="tab-widgets-content",e.widgetsType.$areaAnimate=i}(e,a)},this.closeWidgets=function(){e.$concierge.find("#concierge-widgets li.con-active").removeClass("con-active").removeClass("con-pressed"),e.$concierge.find("#concierge-widgets li.con-active .con-icon").attr("aria-expanded","false");var t=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active");this.makeWidgetInactive(t),t.removeAttr("style"),fr(e,t),e.$concierge.find("#concierge-widget-area").removeClass("con-open"),e.state="tab"},this.getNotification=function(){return e.$concierge.find("#con-notification")},this.getNotificationBody=function(){return e.$concierge.find("#con-notification-body")},this.getNotificationTitle=function(){return e.$concierge.find("#con-notification-title")},this.setNotificationFreeFloating=function(e){return e.addClass("free-floating")},this.removeNotificationFreeFloating=function(e){return e.removeClass("free-floating")},this.setAriaHidden=function(e){this.getNotificationBody().attr("aria-hidden",e),this.getNotificationTitle().attr("aria-hidden",e)},this.canDisplayNotification=function(){return!this.notificationDisplayed&&!e.$concierge.hasClass("con-open-widget")},this.viewportHandler=function(){var t=ye("concierge");t&&!this.conciergePendingUpdate&&(this.conciergePendingUpdate=Ft(function(){var i;delete this.conciergePendingUpdate,0===e.tabStyle.verticalAnchor?i=window.visualViewport.offsetTop:(i=0,oe()>window.visualViewport.height&&(i=window.visualViewport.height-oe()+window.visualViewport.offsetTop)>0&&(i=0)),t.style.transform="translateY("+i+"px) scale("+1/window.visualViewport.scale+")"}.bind(this),"desktopViewportHandler"))}.bind(this),this.applyKeyboardOffset=function(){this.visualViewportHasScroll||(window.visualViewport.addEventListener("scroll",this.viewportHandler),this.visualViewportHasScroll=!0),this.visualViewportHasResize||(window.visualViewport.addEventListener("resize",this.viewportHandler),this.visualViewportHasResize=!0)},this.resetKeyboardOffset=function(){this.visualViewportHasScroll&&(window.visualViewport.removeEventListener("scroll",this.viewportHandler),this.visualViewportHasScroll=!1),this.visualViewportHasResize&&(window.visualViewport.removeEventListener("resize",this.viewportHandler),this.visualViewportHasResize=!1)},this.displayNotification=function(t,i){var n=this;this.notificationDisplayed=!0;var r=this.getNotification();r.data("parameters",t),r.data("engagementId",i),r.addClass("con-active").removeClass("con-inactive"),this.setAriaHidden("false"),r.removeAttr("style");var o={opacity:0},a=t.widget;e.engagementWidgets.widgets[a].shouldDisplayBell()?this.removeNotificationFreeFloating(r):this.setNotificationFreeFloating(r);var s=e.$concierge.find("#concierge-widgets ul li[data-widget="+t.widget+"]"),c=0;s.length>0&&!ur(e)&&e.$concierge.hasClass("with-widgets")&&(c=65*lr(e,s)),o[cr(e)?"top":"bottom"]=c,r.css(o),r.animate({opacity:1},{label:"desktopShowNotification",done:function(e,t){delete n.$notifAnimate,t||"object"!=typeof window.visualViewport||n.applyKeyboardOffset()}}),n.$notifAnimate=r},this.closeNotification=function(t){"object"==typeof window.visualViewport&&this.resetKeyboardOffset();var i,n,r,o,a,s,c=this,u=A.resolve();if(this.notificationDisplayed=!1,e.setNotificationType(0),s=this.getNotification()){if(!0!==t)if("chat"===(n=s.data("parameters")).widget){if(i=s.data("engagementId"),(r=e.getEngagementRecord(i)).proactive&&n.rule){o=new Date(r.time).getTime(),r.chat.time_to_decide=Math.round(((new Date).getTime()-o)/1e3),r.decision_type="Declined",e.setEngagementRecord(i,r),e.broadcastCloseProactiveNotification(n,"declined");var l=n.kbotParameters;l&&(kt.log("widgets.closeNotification, about to remove the existing widget with parameters: ",n),e.removeWidget(n,!0),u=u.then((function(){return kt.log("widgets.closeNotification, about to add disabled kbot rule back with parameters: ",l),e.addWidget(l,l.rule,void 0)})))}}else i=s.data("engagementId"),null!==(a=e.getEngagementRecord(i))&&a.proactive&&(a.decision_type="Declined",e.setEngagementRecord(i,a),e.broadcastCloseProactiveNotification(n,"declined"));return s.animate({opacity:0},{label:"desktopHideNotification",done:function(){delete c.$notifAnimate,s.addClass("con-inactive").removeClass("con-active").removeAttr("style"),c.setAriaHidden("true")}}),c.$notifAnimate=s,u}},this.openConcierge=function(t,i,n){"tab-widgets-content"!==e.state&&(e.state="tab-widgets");var r=e.$concierge.find("#concierge-widgets");e.$concierge.addClass("with-widgets").removeClass("con-closed");var o=e.$concierge.find("#concierge-tab");if(o.addClass("con-pressed"),o.attr("aria-expanded","true"),r.addClass("con-visible"),t)return mr(e,t,null,i,n)};var t=function(t){if(!ur(e)){var i=null;1===(i="concierge-tab"===t.attr("id")?Gt("#concierge-widgets-ul li").last():t.prev()).length?(i.find(".con-icon").focus(),i.addClass("highlight")):Gt("#concierge-tab").focus().addClass("highlight")}},i=function(t){if(!ur(e)){var i=null;1===(i="concierge-tab"===t.attr("id")?Gt("#concierge-widgets-ul li").first():t.next()).length?(i.find(".con-icon").focus(),i.addClass("highlight")):Gt("#concierge-tab").focus().addClass("highlight")}};this.addWidget=function(n,r){kt.log("DesktopWidgets: addWidget:",n,r);var o=Gt("#concierge-widgets ul"),a=e.concierge.getTranslation(ar(r.name),"title"),s=Gt('<li data-widget="'+n+'"'+(ur(e)?"":' role="menuitem"')+'><button type="button" aria-expanded="false" class="con-icon" aria-label="'+a+'">'+r.icon.svg+"</button></li>");if(ur(e)&&o.children("li").length>=1)return kt.log("DesktopWidgets: Not adding widget, "+n+", due to singleChannelMode"),s;cr(e)?o.append(s[0]):o.prepend(s[0]);var c=o.children("li");c.sort((function(t,i){var n=t.getAttribute("data-widget"),r=i.getAttribute("data-widget"),o=e.engagementWidgets.widgets[n].sortKey,a=e.engagementWidgets.widgets[r].sortKey;return o>a?1:o<a?-1:0})),c.detach().appendTo(o);var u=e.$concierge.find("#concierge-widget-area"),l=u.find(".con-active");if(l.length>0){var d=e.$concierge.find("#concierge-widgets ul li[data-widget="+l.data("widget")+"]");d.addClass("con-pressed"),d.find(".con-icon").attr("aria-expanded","true"),gr(e,u,d)}ur(e)&&"tab"===e.state&&(e.$concierge.addClass("with-widgets").removeClass("con-closed"),e.$concierge.find("#concierge-tab").addClass("con-pressed").attr("aria-expanded","true"),e.state="tab-widgets");var g=s.find(".con-icon");return g.on("keyup",(function(e){Yn(e.which)?s.addClass("highlight"):tr(e.which)?t(s):ir(e.which)&&i(s)})),g.on("blur",(function(){s.removeClass("highlight")})),s};var n=function(t){var i={right:e.tabStyle.horizontalOffset,bottom:""},n=window.pageYOffset;0===e.tabStyle.verticalAnchor?i.top=e.tabStyle.verticalOffset+n:i.top=n+oe()-(e.tabStyle.verticalOffset+50),t.css(i)},r=function(t){var i={right:e.tabStyle.horizontalOffset};0===e.tabStyle.verticalAnchor?i.top=e.tabStyle.verticalOffset:i.bottom=e.tabStyle.verticalOffset,t.css(i)};this.fixPosition=function(e,t){"javascript"===e?(t.addClass("position-method-javascript"),kt.log("Concierge Client: PositionMethod - Javascript"),this.scrollHandler||(this.scrollHandler=function(){n(t)},tt(window,"scroll",this.scrollHandler)),n(t)):r(t)},this.beforeAppend=function(t){var i=[],n={right:e.tabStyle.horizontalOffset};r(t),cr(e)?i.push("con-top"):i.push("con-bottom"),t.addClass(i.join(" ")),t.css(n)},this.destroy=function(){sr(this),this.scrollHandler&&it(window,"scroll",this.scrollHandler),Gt("#concierge-style-desktop").remove(),this.resetKeyboardOffset()}}var Cr=function(e){return!!e.engagementWidgets.globalSettings.singleChannelMode},_r=function(e,t,i){var n=e.engagementWidgets.widgets[t];return n&&0!==n.state&&n.proactive&&i.data("parameters.proactive")?i.data("parameters.proactive"):i.data("parameters.reactive")||i.data("parameters.proactive")};function Nr(e){this.html=function(){return'<div id="concierge" class="con-right con-closed /DEVICE/">\n    <div id="concierge-backdrop"></div>\n    <button id="concierge-tab" type="button" aria-label="<%= CONCIERGE %>" aria-expanded="false">\n        <%= CONCIERGE_TAB_ICON_SVG %>\n    </button>\n    <div id="concierge-widgets">\n      <div class="con-widgets"><ul id="concierge-widgets-ul"<%= CON_ROLE_ATTRIBUTE %>></ul></div>\n      <div class="con-notch con-notch1"></div>\n      <div class="con-notch con-notch2"></div>\n    </div>\n    <div id="concierge-widget-area" role="dialog" aria-live="assertive" aria-label=""></div>\n\n    <div id="con-notification" role="alert" aria-live="assertive" class="con-inactive">\n    \x3c!--\n      CON-5221: Don\'t include (causes JAWS and NVDA to read twice):\n      aria-labelledby=" con-notification-title" aria-describedby="con-notification-body"\n    --\x3e\n      <h2 id="con-notification-title" class="concierge-notification-title" aria-hidden="true" tabindex="0">Notification</h2>\n      <div class="con-notification-content">\n        <div class="con-notification-icon" aria-live="off" aria-hidden="true"></div>\n        <div id="con-notification-body" class="con-notification-body" tabindex="0" aria-hidden="true"></div>\n        \x3c!--\n          CON-5221: Don\'t include (causes JAWS to skip reading):\n          aria-live="polite" aria-atomic="true"\n        --\x3e\n        <div class="con-notification-calltoaction" role="link" tabindex="0"></div>\n      </div>\n      <button class="con-x" aria-label="<%= CLOSE_ICON %>">\n        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n          <title><%= CLOSE_ICON %></title>\n          <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n        </svg>\n      </button>\n    </div>\n</div>\n'},this.cssType="mobile",this.openWidgetCount=0,this.bodyOrigStyle="",this.bodyOrigClasses="",this.htmlOrigStyle="",this.htmlOrigClasses="",this.start=function(){var t=this;navigator.userAgent.match(/instagram/i)&&navigator.userAgent.match(/iphone/i)&&(e.$concierge.addClass("instagram"),e.$concierge.find("#concierge-widget-area").css("height",window.innerHeight+"px")),e.$concierge.find("#concierge-tab").onPassive("touchstart",(function(){Gt(this).addClass("con-pressed").attr("aria-expanded","true"),Or(e)})).on("touchend",(function(){Gt(this).removeClass("con-pressed")})),e.$concierge.onPassive("touchstart",".con-widgets li",(function(){Gt(this).addClass("con-pressed"),Gt(this).find(".con-icon").attr("aria-expanded","true")})).on("touchend",".con-widgets li",(function(){var t=Gt(this);t.removeClass("con-pressed"),t.find(".con-icon");var i=t.data("widget"),n=_r(e,i,t);n.rule.source="button",kt.log("widget "+i+" clicked"),e.closeNotification(!0);var r=ar(i);return e.showWidget(i,n).then((function(){return Si(e.concierge,!0,n.widget),ki("buttonClicked",{buttonName:r}),!1}))})),e.$concierge.find("#concierge-backdrop").on("click",(function(){return Or(e)}));var i=function(i){if("click"===i.type||Zn(i.which)||er(i.which)){var n=Gt(i.target);if(n.hasClass("con-x")||n.closest(".con-x").length>0)e.closeNotification(!1);else{e.closeNotification(!0);var r=t.getNotification(),o=r.data("parameters"),a=r.data("engagementId"),s=e.engagementWidgets.widgets[o.widget];if(s&&s.shouldDisplayBell()&&Or(e,o.widget,o),void 0!==s.execute)return void s.execute(e,o);o.rule?e.broadcastCloseProactiveNotification(o,"accepted"):o.rule={source:"notification"},Cr(e)||e.showWidget(o.widget,o,a)}}};e.$concierge.find("#con-notification").on("click",i),e.$concierge.find("#con-notification").on("keypress",i);var n=!1;this.orientationListener=function(){if(t.notificationDisplayed){var e=t.getNotification();n&&clearTimeout(n),n=setTimeout((function(){n=!1,e.css({width:ae()})}),500)}},window.addEventListener("orientationchange",this.orientationListener)},this.focusWidgetButton=function(t){Cr(e)?e.$concierge.find("#concierge-tab").focus():e.$concierge.find("#concierge-widgets li[data-widget="+t+"]").focus()};this.addScrollFix=function(){var e=Gt("html");this.htmlOrigStyle=e.attr("style"),this.htmlOrigClasses=e.attr("class"),e.attr("style",""),e.attr("class",""),e.addClass("concierge-modal-displayed");var t=Gt("body");this.bodyOrigStyle=t.attr("style"),this.bodyOrigClasses=t.attr("class"),t.attr("style",""),t.attr("class",""),t.addClass("concierge-modal-displayed"),this.scrollFixApplied=!0},this.removeScrollFix=function(){if(this.scrollFixApplied){var e=Gt("html");e.removeClass("concierge-modal-displayed"),e.attr("style",this.htmlOrigStyle),delete this.htmlOrigStyle,e.attr("class",this.htmlOrigClasses),delete this.htmlOrigClasses;var t=Gt("body");t.removeClass("concierge-modal-displayed"),t.attr("style",this.bodyOrigStyle),delete this.bodyStyleRemoved,t.attr("class",this.bodyOrigClasses),delete this.bodyOrigClasses,Gt("#concierge-widget-area").css({top:""}),delete this.scrollFixApplied}},this.makeWidgetActive=function(e){e.length>0&&(0===this.openWidgetCount&&this.addScrollFix(),e.addClass("con-active"),this.openWidgetCount+=e.length)},this.makeWidgetInactive=function(e){e.length>0&&(e.removeClass("con-active"),this.openWidgetCount-=e.length,0===this.openWidgetCount&&this.removeScrollFix())};this.openWidget=function(t){!function(e,t){var i={kb:"K B Engagement Widget",chat:"Live Chat",kbot:"Live Chat",email:"Email Engagement Widget"}[e]||"";t.attr("aria-label",i)}(t,e.$concierge.find("#concierge-widget-area"));var i=e.$concierge.find("#concierge-widget-"+t),n=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active").not(i),r=this;this.makeWidgetActive(i),this.$widgetAnimating=i,function(e){var t=e.$concierge;e.engagementWidgets.globalSettings.hideMoxieBranding&&t.addClass("hide-moxie")}(e),i.attr("aria-expanded","true"),i.css({"z-index":1,opacity:0}).animate({opacity:1},{label:"mobileOpenWidget",done:function(){delete r.$widgetAnimating,r.makeWidgetInactive(n),n.attr("aria-expanded","false"),i.removeAttr("style")}}),Er(e)},this.closeWidgets=function(){var t=e.$concierge.find("#concierge-widget-area .concierge-widget.con-active"),i=this;t.css({opacity:1}).animate({opacity:0},{label:"mobileCloseWidgets",done:function(){kt.log("close complete"),i.makeWidgetInactive(t),t.removeAttr("style").attr("aria-expanded","false")}})},this.getNotification=function(){return e.$concierge.find("#con-notification")},this.getNotificationBody=function(){return e.$concierge.find("#con-notification-body")},this.getNotificationTitle=function(){return e.$concierge.find("#con-notification-title")},this.setAriaHidden=function(e){this.getNotificationBody().attr("aria-hidden",e),this.getNotificationTitle().attr("aria-hidden",e)},this.canDisplayNotification=function(){return!this.notificationDisplayed&&!e.$concierge.hasClass("con-open-widget")},this.fixPosition=function(e,t){if("javascript"===e){t.addClass("position-method-javascript"),kt.log("Concierge Client: PositionMethod - Javascript");var i=function(){var e=oe();t.css({top:e})};window.addEventListener("scroll",i),i()}};var t=!1,i=this;this.fixNotificationsUsingVisualViewport=function(){var e=ye("con-notification");e&&(t=!1,e.style.transform="translateY("+window.visualViewport.offsetTop+"px) scale("+1/window.visualViewport.scale+")")},this.viewportHandler=function(){t||(t=!0,Ft(i.fixNotificationsUsingVisualViewport,"mobileNotifScrollFix"))},this.applyNotificationKeyboardOffset=function(){window.visualViewport.addEventListener("scroll",this.viewportHandler),window.visualViewport.addEventListener("resize",this.viewportHandler),this.viewportHandler()},this.resetNotificationKeyboardOffset=function(){window.visualViewport.removeEventListener("scroll",this.viewportHandler),window.visualViewport.removeEventListener("resize",this.viewportHandler)},this.displayNotification=function(t,i){var n=this;this.notificationDisplayed=!0,kt.log("opening notification.");var r=this.getNotification();r.data("parameters",t),r.data("engagementId",i),r.addClass("con-active").removeClass("con-inactive"),this.setAriaHidden("false");var o="0px";e.engagementWidgets.globalSettings.notificationMobileVerticalOffset&&(o=e.engagementWidgets.globalSettings.notificationMobileVerticalOffset.toString()+"px"),n.$notifAnimating=r,r.css({top:"-150px"}).animate({top:o},{label:"mobileShowNotification",done:function(){n.$notifAnimating=!1;var e=ae();r.css({width:e}),"object"==typeof window.visualViewport&&n.applyNotificationKeyboardOffset()}})},this.closeNotification=function(t){var i;"object"==typeof window.visualViewport&&this.resetNotificationKeyboardOffset();var n=this,r=A.resolve();this.notificationDisplayed=!1,e.setNotificationType(0);var o=this.getNotification();if(o){if(!0!==t){var a=o.data("parameters");if("chat"===a.widget){i=o.data("engagementId");var s=e.getEngagementRecord(i);if(s.proactive&&a.rule){var c=new Date(s.time).getTime();s.chat.time_to_decide=Math.round(((new Date).getTime()-c)/1e3),s.decision_type="Declined",e.setEngagementRecord(i,s),e.broadcastCloseProactiveNotification(a,"declined");var u=a.kbotParameters;u&&(e.removeWidget(a,!0),r=r.then((function(){return kt.log("widgets.closeNotification, about to add disabled kbot rule back with parameters: ",u),e.addWidget(u,u.rule,void 0)})))}}else{i=o.data("engagementId");var l=e.getEngagementRecord(i);null!==l&&l.proactive&&(l.decision_type="Declined",e.setEngagementRecord(i,l),e.broadcastCloseProactiveNotification(a,"declined"))}}o.animate({opacity:0},{label:"mobileHideNotification",done:function(){o.addClass("con-inactive").removeClass("con-active").removeAttr("style"),n.setAriaHidden("true")}})}return r},this.openConcierge=function(){},this.destroy=function(){this.$notifAnimating&&(this.$notifAnimating.stop(!0,!0),delete this.$notifAnimating),this.$widgetAnimating&&(this.$widgetAnimating.stop(!0,!0),delete this.$widgetAnimating),this.orientationListener&&(window.removeEventListener("orientationchange",this.orientationListener),delete this.orientationListener),this.removeScrollFix(),Gt("#concierge-style-mobile").remove()},this.addWidget=function(t,i){kt.log("MobileWidgets: addWidget:",t,i);var n=Gt("#concierge-widgets ul"),r=e.concierge.getTranslation(ar(i.name),"title"),o=Gt('<li data-widget="'+t+'"'+(Cr(e)?"":' role="menuitem"')+'><button type="button" aria-expanded="false" class="con-icon" aria-label="'+r+'">'+i.icon.svg+'</button><span class="con-mobile-primary-menu">'+r+"</span></li>");if(Cr(e)&&n.children("li").length>=1)kt.log("MobileWidgets: Not adding widget, "+t+", due to singleChannelMode");else{n.append(o[0]);var a=n.children("li");a.sort((function(t,i){var n=t.getAttribute("data-widget"),r=i.getAttribute("data-widget"),o=e.engagementWidgets.widgets[n].sortKey,a=e.engagementWidgets.widgets[r].sortKey;return o>a?1:o<a?-1:0})),a.detach().appendTo(n)}if(Cr(e)){var s=Gt("#concierge-tab");return s.html(i.icon.svg),s.data("widget",t),s}return o}}function Ir(e,t){var i=t.data("animation");return i&&("opening"===i?(t.stop(),e.$concierge.addClass("con-open")):"closing"===i&&t.stop(),t.data("animation",!1)),i}function Er(e){var t=e.$concierge.find("#concierge-widgets");(e.$concierge.find("#concierge-tab").attr("aria-expanded","false"),e.$concierge.hasClass("con-closed"))||"closing"!==t.data("animation")&&(Ir(e,t),t.data("animation","closing"),e.$concierge.removeClass("con-pressed").removeClass("con-open"),t.css({overflow:"hidden"}),t.animate({opacity:0,height:0},{label:"mobileCloseMenu",done:function(){t.data("animation",!1),t.removeAttr("style"),e.$concierge.addClass("con-closed")}}))}function Or(e,t,i){var n=e.$concierge.find("#concierge-widgets");if(Ir(e,n),Cr(e)){e.closeNotification(!0);var r=e.$concierge.find("#concierge-tab");t=t||r.data("widget"),kt.log("widget "+t+" clicked"),i=i||_r(e,t,r);var o=e.engagementWidgets.widgets[i.widget],a=ar(t);Si(e.concierge,!0,i.widget),ki("buttonClicked",{buttonName:a}),void 0===o.execute&&(i.rule=i.rule||{},i.rule.source="button",e.showWidget(t,i))}else e.$concierge.hasClass("con-open")||!e.shouldDisplayBell?Er(e):function(e){var t=e.$concierge.find("#concierge-widgets");e.$concierge.find("#concierge-tab").attr("aria-expanded","true"),Ir(e,t),t.data("animation","opening"),e.$concierge.removeClass("con-pressed").removeClass("con-closed");var i=t.attr("style");t.removeAttr("style");var n=t.height();void 0===i||!1===i?t.css({overflow:"hidden",opacity:0,height:0}):t.attr("style",i),t.animate({height:n,opacity:1},{label:"mobileOpenMenu",done:function(){t.data("animation",!1),t.removeAttr("style"),e.$concierge.addClass("con-open")}})}(e);return!1}function Tr(){}Tr.prototype.markChat=function(e,t,i){var n=Date.now();return e.transient_data?(e.transient_data.vp_data.chat.session_id=Math.abs(parseInt(t)),"start"===i&&(e.transient_data.vp_data.chat.start_time=n),"end"===i&&(e.transient_data.vp_data.chat.end_time=n)):e.transient_data={vp_data:{chat:{session_id:t,start_time:n}}},kt.log("Marking chat "+t+" as "+i),e};function kr(e,t,i,n,r,o,a,s){Object.defineProperty(this,"name",{value:t,enumerable:!0,writable:!1}),Object.defineProperty(this,"maxLength",{value:i,enumerable:!0,writable:!1}),Object.defineProperty(this,"required",{value:n,enumerable:!0,writable:!1}),Object.defineProperty(this,"label",{value:r,enumerable:!0,writable:!1}),Object.defineProperty(this,"type",{value:o,enumerable:!0,writable:!1}),Object.defineProperty(this,"defaultvalue",{value:a,enumerable:!0,writable:!1}),Object.defineProperty(this,"options",{value:s,enumerable:!0,writable:!1}),this.hide=e}function xr(){this.hide=!1,this.questions=[]}function Lr(e,t){ut(this,t),this.configuration=this.configuration||{},this.configuration.connectorUrl=e.serviceUrl.connector}function Wr(e,t){return(e=e||{}).status=t,e}function Mr(e,t){Lr.call(this,e,t),function(e,t){var i=t.widgetManager,n=t.cacheManager,r=function(e){var t=n.getVolatileData("moxie_channels_custom_data");if(function(e,t){for(var i=t.split("&"),n=0;n<i.length;n++){var r=i[n].split("=");0===n&&((r=r[0].split("?"))[0]=r[1]),e&&z(e,r[0])&&delete e[r[0]]}}(t,e),t){if("object"!=typeof t)try{t=JSON.parse(t)}catch(e){kt.log("Error parsing "+t+": err")}"object"!=typeof t||ee(t)||(e=e+"&"+mt(t))}return e};e.getRemoteURL=function(){var t,n=this.remoteURL,o=i.widgetLoadParameters[e.name||"chat"].portalId;return t="object"==typeof n?n[o]:n,r(t)},e.beforeAdd=function(r){var o,a,s=r.ref,c=r.parameters,u=Dr(i.device),l=n.getWidgetCache("chat","engagement_id",!0),d=n.getWidgetCache("chat","suspended_session",!0),g=n.getWidgetCache("chat","active_session");if(!r.ruleSettings)throw new Error("obj.ruleSettings is missing");return a=r.ruleSettings.skip_chat_queue_status_check?t.serviceUrl.connector+"/connector/channels/portal_with_service_line/"+c.portalId+"/device/"+u:t.serviceUrl.connector+"/connector/channels/portals_with_queue_status/"+c.portalId+"/device/"+u,t.httpGet(a).then((function(a){var u;if(r.ruleSettings.skip_chat_queue_status_check)c.serviceLineId||(c.serviceLineId=a.response.serviceLineId,c.serviceLine=a.response.serviceLineName),t.serviceLines.setName(c.serviceLineId,c.serviceLine),u=a.response;else{if(c.serviceLineId||(c.serviceLineId=a.response.queueStatus.id,c.serviceLine=a.response.queueStatus.name),t.serviceLines.setName(c.serviceLineId,c.serviceLine),!a.response)throw new Error("status.response evaluates to false");var h=c.rule&&c.rule.source?c.rule.source:"internal";if("externalLink"!==h&&"externalAPI"!==h&&r.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==a.response.queueStatus.queueopen)throw new Error("service line is closed");if(o="true"===a.response.queueStatus.slotavailable,"externalLink"!==h&&"externalAPI"!==h&&r.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&!o&&!d&&!g&&!r.engagementId)throw new Error("slot not available");if(r.ruleSettings.check_queue_wait_time_for_on_demand_chat&&parseInt(a.response.queueStatus.holdtime,10)>r.ruleSettings.queue_wait_time)throw new Error("queue wait time is too long");u=a.response.portalData}c.widgetpath=t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/",c.langOptions=t.langOptions;var f=0;u.deviceList.length>1&&(f=Dr(i.device));var p="<%=host %>/netagent/cimlogin.aspx?questid=<%=questId %>&portid=<%=portalId %>&defaultStyleId=<%=styleId %>&widgetpath=<%=widgetpath %>&flyout=1";p=Xn(p)({host:c.host,questId:u.deviceList[f].questid,styleId:u.deviceList[f].styleid,portalId:u.deviceList[f].styleid,widgetpath:t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/"}),("string"==typeof s.remoteURL||s.remoteURL instanceof String)&&(s.remoteURL={}),s.portalId=c.portalId,s.remoteURL[c.portalId]=p,s.oldRemoteUrl=p,navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?s.remoteURL[c.portalId]+="&fullScreen=false":"Mobile"!==i.device&&"Tablet"!==i.device||(s.remoteURL[c.portalId]+="&fullScreen=true"),r.engagementId&&r.engagementId!==l&&(l=!1);var v=0!==i.notificationType;return c.questId=u.deviceList[f].questid,c.styleId=u.deviceList[f].styleid,e.shouldReplaceIframeSrc=!0,d&&l?(v&&i.widgetsType.closeNotification(),n.removeWidgetCache("chat","suspended_session",!0),i.widgetsType.openConcierge("chat",c,l)):i.loadingActiveWidgets&&g&&l?(s.origRemoteURL=s.remoteURL,s.oldRemoteUrl=s.remoteURL[c.portalId],s.remoteURL[c.portalId]=Xn(g)({host:c.host,widgetpath:t.scriptLocation+"/widgets/chat/"+t.assetVersion.widgets+"/"}),navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?s.remoteURL[c.portalId]+="&fullScreen=false":"Mobile"!==i.device&&"Tablet"!==i.device||(s.remoteURL[c.portalId]+="&fullScreen=true"),t.cacheManager.getWidgetCache("chat","widget-closed")||v?i.loadWidget("chat",c,l,!0):i.widgetsType.openConcierge("chat",c,l)):void 0})).then((function(){return r.status=!0,r}))},e.beforeNotify=function(e){var n=t.rulesEngine,r=Dr(i.device),o=60;n.queueWaitTime&&(o=n.queueWaitTime());var a=e.rule,s=null;a&&a.id?s=a.id:kt.log("Chat Widget:beforeNotify: rule id missing from obj:",e);var c=e.parameters,u=t.serviceUrl.connector+"/connector/channels/queue_status/"+c.portalId+"/device/"+r;return t.httpGet(u).then((function(n){var r=n.response.id;if(c.serviceLineId=n.response.id,c.serviceLine=n.response.name,t.serviceLines.setName(c.serviceLineId,c.serviceLine),t.cacheManager.getWidgetCache("chat","suspended_session",!0))return e.status=!1,i.removeEngagementRecord(e.engagementId),e;var a=parseInt(n.response.holdtime||"0",10);if("true"===n.response.slotavailable&&"true"===n.response.queueopen&&"true"===n.response.agentavailable&&a<o)e.status=!0;else{var u=ft({},i.getEngagementRecord(e.engagementId));"false"===n.response.queueopen?(u.chat.missed_reason=2,bi(t,"service-line-closed",r,s,"proactive")):a>=o?(u.chat.missed_reason=3,bi(t,"wait-too-long",r,s,"proactive")):"false"===n.response.agentavailable&&(u.chat.missed_reason=1,bi(t,"no-agent-available",r,s,"proactive")),i.setEngagementRecord(e.engagementId,u),e.status=!1}return e}))},e.startNewSession=function(){var i=t.widgetManager,n=Dr(i.device),o=t.serviceUrl.connector+"/connector/channels/queue_status/"+e.widgetParameters.portalId+"/device/"+n;return t.httpGet(o).then((function(n){if(e.shouldReplaceIframeSrc){var o=e.getRemoteURL();"true"!==n.response.slotavailable&&(o=r(e.oldRemoteUrl)),navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?o+="&fullScreen=false":"Mobile"!==i.device&&"Tablet"!==i.device||(o+="&fullScreen=true"),Gt("#concierge-widget-chat .widget-content").attr("src",o)}else Gt("#concierge-widget-chat iframe.widget-content").replaceWith('<iframe frameborder="no" class="widget-content"></iframe>'),t.widgetManager.writeSrcToIframe("chat")}))},e.checkAvailability=function(e){var n=e.parameters,r=Dr(i.device);if(!e.ruleSettings)return A.resolve({status:!1});var o=t.serviceUrl.connector+"/connector/channels/queue_status/"+n.portalId+"/device/"+r;return t.httpGet(o).then((function(t){return t.response?e.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==t.response.queueopen?{status:!1}:e.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&"true"!==t.response.slotavailable?{status:!1}:e.ruleSettings.check_queue_wait_time_for_on_demand_chat&&parseInt(t.response.holdtime,10)>e.ruleSettings.queue_wait_time?{status:!1}:{status:!0}:{status:!1}})).catch((function(e){return kt.log("checkAvailability error thrown: "+e),{status:!1}}))},e.updateBroadcastPayload=function(e,i){if(this&&this.widgetParameters){var n=this.widgetParameters;if(n.portalId&&(i.portalId=Number(n.portalId)),n.serviceLineId){var r=n.serviceLineId;return i.serviceLineId=r,t.serviceLines.getName(r).then((function(e){return i.serviceLine=e,i}))}}return A.resolve(i)},e&&e.titleBar&&(e.titleBar.onclick=function(){i.hideWidget(!1),ki("widgetMinimized",{widgetName:"chat"})})}(this,e)}kr.prototype.setAnswer=function(e){var t=void 0!==e.hide?e.hide:this.hide;if("16"===this.type||"15"===this.type||"4"===this.type||"6"===this.type){for(var i=0;i<this.options.length;i++)if(this.options[i].value===e.value){this.answer=e.value,this.hide=t;break}}else this.answer=e.value,this.hide=t},xr.prototype.getQuestionByName=function(e){for(var t=0;t<this.questions.length;t++)if(this.questions[t].name===e)return this.questions[t];return null},xr.prototype.loadQuestions=function(e){for(var t=0;t!==e.length;t++){var i=e[t],n=new kr(!1,i.formatParameters.elementname,i.formatParameters.elementmaxlength,i.formatParameters.elementrequired,i.actualquestion,i.type,i.formatParameters.elementdefaultvalue||i.formatParameters.elementchecked,i.options);"14"===n.type?n.answer="true"===i.formatParameters.elementchecked:n.answer=n.defaultvalue,this.questions.push(n)}},xr.load=function(e){var t=new xr;t.hide=!0===e.hide;for(var i=e.questions?e.questions.length:0,n=0;n<i;n++){var r=e.questions[n],o=new kr(r.hide,r.name,r.maxLength,r.required,r.label,r.type,r.defaultvalue,r.options);o.answer=r.answer,t.questions.push(o)}return void 0!==e.sendChatTranscript&&(t.sendChatTranscript=e.sendChatTranscript),t},xr.prototype.toJson=function(){return JSON.stringify(this)},ut(Lr.prototype,{checkAvailability:function(){return A.resolve({status:!0})},shouldDisplayBell:function(){return!0},beforeNotify:function(e){return(e=e||{}).status=!0,A.resolve(Wr(e,!0))},beforeAdd:function(e){return A.resolve(Wr(e,!0))},getRemoteURL:function(){if(this.remoteURL)return this.remoteURL}}),Mr.prototype=Object.create(Lr.prototype),Object.defineProperty(Mr.prototype,"constructor",{value:Mr,enumerable:!1,writable:!0});var Ar={Mobile:1,Tablet:2,Desktop:3},Dr=function(e){var t=Ar[e];return t||(t=0),t};function Rr(e,t){Lr.call(this,e,t)}function Pr(e,t){Lr.call(this,e,t),function(e,t){var i=t.widgetManager,n=t.cacheManager;e.getRemoteURL=function(){var e,t,i,r=this.remoteURL,o=this.portalId;if(t="object"==typeof r?r[o]:r,"moxie_channels_custom_data",e="",function(e,t){for(var i=t.split("&"),n=0;n<i.length;n++){var r=i[n].split("=");0===n&&((r=r[0].split("?"))[0]=r[1]),e&&z(e,r[0])&&delete e[r[0]]}}(i=n.getVolatileData("moxie_channels_custom_data"),t),i){if("object"!=typeof i)try{i=JSON.parse(i)}catch(e){kt.log("Error parsing "+i+": err")}"object"!=typeof i||ee(i)||(e="&"+mt(i))}return t+=e},e.titleBar.onclick=function(){sessionStorage.getItem("kbot-disableTitleClick")||(i.hideWidget(!1),i.publicAPI.broadcast("widgetMinimized",{widgetName:"kbot"}),n.setWidgetCache("kbot","shouldReopen",!1,!1))},e.sendSearchGuid=function(e,i){var r={chat_session_id:e},o=i.kbPortalId,a=n.getWidgetCache("kbot","search-guid",!1);if(o&&a){var s=new XMLHttpRequest,c=t.serviceUrl.connector+"/connector/kb/suggestions/"+o+"/"+a;s.open("PUT",c,!0),s.setRequestHeader("Content-Type","application/json"),s.withCredentials=!1,s.onerror=function(){kt.log("Received failure response from connector endpoint for kb search_guid")},s.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&200===this.status&&(kt.log("Sent to kb: "+JSON.stringify(r)),n.removeWidgetCache("kbot","search-guid",!1))},s.send(JSON.stringify(r))}};var r={Mobile:1,Tablet:2,Desktop:3},o=function(e){var t=r[e];return t||(t=0),t};e.prepareToLoad=function(r){var o,a=r.parameters,s="questionnaire-"+r.parameters.questId,c=t.serviceUrl.connector+"/connector/channels/questionnaire/"+a.questId+"/"+a.styleId;return t.httpGet(c).then((function(e){return r.parameters.parameters=e.response.parameters,(o=new xr).loadQuestions(e.response.questions),t.onQuestionnaireLoadedCallbacks.doCallbacksAsync(o)})).then((function(){return n.setWidgetCache("kbot",s,o.toJson())})).then((function(){var t;return sessionStorage.getItem("MoxieFlyout.chatInProgress")?(t=n.getWidgetCache("kbot","engagement_id",!0),i.widgetsType.openConcierge("kbot",r.parameters,t)):n.getWidgetCache("kbot","shouldReopen",!1)&&"null"===sessionStorage.getItem("MoxieFlyout.chatInProgress")&&(t=n.getWidgetCache("kbot","engagement_id",!0),i.widgetsType.openConcierge("kbot",r.parameters,t)),e})).catch((function(t){kt.log("kbot failed in prepare to load:"+JSON.stringify(t)),i.removeWidget(e.widgetParameters)}))},e.shouldRebuildIframe=function(){var e=n.getWidgetCache(this.name,"active_session");return n.getWidgetCache(this.name,"rebuildIframe",!1)&&!e},e.beforeAdd=function(r){var a,s,c=r.ref,u=r.parameters,l=o(i.device),d=n.getWidgetCache("kbot","engagement_id",!0),g=n.getWidgetCache("kbot","suspended_session",!0),h=n.getWidgetCache("kbot","active_session"),f=n.getWidgetCache("kbot","active_kb_session");if(!r.ruleSettings)throw new Error("obj.ruleSettings is missing");return s=r.ruleSettings.skip_chat_queue_status_check?t.serviceUrl.connector+"/connector/channels/portal_with_service_line/"+u.portalId+"/device/"+l:t.serviceUrl.connector+"/connector/channels/queue_status/"+u.portalId+"/device/"+l,t.httpGet(s).then((function(e){if(r.ruleSettings.skip_chat_queue_status_check)u.serviceLineId||(u.serviceLineId=e.response.serviceLineId,u.serviceLine=e.response.serviceLineName),t.serviceLines.setName(u.serviceLineId,u.serviceLine);else{if(u.serviceLineId||(u.serviceLineId=e.response.id,u.serviceLine=e.response.name),t.serviceLines.setName(u.serviceLineId,u.serviceLine),u.serviceLineStatus={open:"true"===e.response.queueopen,slotAvailable:"true"===e.response.slotavailable},!e.response)throw new Error("status.response evaluates to false");if("externalLink"!==u.rule.source&&"externalAPI"!==u.rule.source&&r.ruleSettings.hide_on_demand_chat_when_service_line_is_closed&&"true"!==e.response.queueopen)throw new Error("service line is closed");if(a="true"===e.response.slotavailable,"externalLink"!==u.rule.source&&"externalAPI"!==u.rule.source&&r.ruleSettings.hide_on_demand_chat_when_no_available_agent_slots&&!a&&!g&&!h&&!r.engagementId)throw new Error("slot not available");if(r.ruleSettings.check_queue_wait_time_for_on_demand_chat&&parseInt(e.response.holdtime,10)>r.ruleSettings.queue_wait_time)throw new Error("queue wait time is too long")}if(u.widgetpath=t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/",u.langOptions=t.langOptions,r.ruleSettings.skip_chat_queue_status_check)return e;var i=t.serviceUrl.connector+"/connector/channels/portals/"+u.portalId;return t.httpGet(i)})).then((function(a){var s=0;a.response.deviceList.length>1&&(s=o(i.device));(!c.remoteURL||"string"==typeof c.remoteURL||c.remoteURL instanceof String)&&(c.remoteURL={}),c.portalId=u.portalId,c.remoteURL[u.portalId]=Xn("<%=host %>/netagent/cimlogin.aspx?questid=<%=questId %>&portid=<%=portalId %>&defaultStyleId=<%=styleId %>&widgetpath=<%=widgetpath %>&flyout=1")({host:u.host,questId:a.response.deviceList[s].questid,styleId:a.response.deviceList[s].styleid,portalId:a.response.deviceList[s].styleid,widgetpath:t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/"}),c.hashedQuestId=a.response.deviceList[s].questid,c.hashedPortalId=a.response.deviceList[s].styleid,navigator.appVersion&&-1!==navigator.appVersion.indexOf("MSIE 10")?(u.fullScreen=!1,c.remoteURL[u.portalId]+="&fullScreen=false"):"Mobile"!==i.device&&"Tablet"!==i.device||(u.fullScreen=!0,c.remoteURL[u.portalId]+="&fullScreen=true"),r.engagementId&&r.engagementId!==d&&(d=!1);var l=0!==i.notificationType;if(u.questId=a.response.deviceList[s].questid,u.styleId=a.response.deviceList[s].styleid,n.getWidgetCache("kbot","suspended_session",!0)&&d)return l&&i.widgetsType.closeNotification(),e.shouldReplaceIframeSrc=!0,n.removeWidgetCache("kbot","suspended_session",!0),i.widgetsType.openConcierge("kbot",u,d);var g=n.getWidgetCache("kbot","widget-closed");if(i.loadingActiveWidgets&&h&&d)return e.shouldReplaceIframeSrc=!0,c.origRemoteURL=c.remoteURL,c.oldRemoteUrl=c.remoteURL[u.portalId],c.remoteURL[u.portalId]=Xn(h)({host:u.host,widgetpath:t.scriptLocation+"/widgets/kbot/"+t.assetVersion.widgets+"/"}),g||l?i.loadWidget("kbot",u,d,!0):i.widgetsType.openConcierge("kbot",u,d);if(i.loadingActiveWidgets&&f&&d){var p=n.getWidgetCache("kbot","shouldReopen",!1);return g||l||!p?i.loadWidget("kbot",u,d,!0):i.widgetsType.openConcierge("kbot",u,d)}})).then((function(){return r.status=!0,r}))},e.startNewSession=function(){var i=t.widgetManager.createEngagementRecord("kb",this.widgetParameters.rule);n.setWidgetCache("kbot","engagement_id",i,!0),n.removeWidgetCache("kbot","active_session"),Gt("#concierge-widget-kbot iframe.widget-content").replaceWith('<iframe frameborder="no" class="widget-content"></iframe>'),t.widgetManager.writeSrcToIframe("kbot"),t.widgetManager.setupBridge("kbot",e.widgetParameters),delete this.shouldReplaceIframeSrc},e.createChatEngagementRecord=function(){var e=t.widgetManager.createEngagementRecord("chat",this.widgetParameters.rule);return n.setWidgetCache("kbot","engagement_id",e,!0),{id:e,data:t.widgetManager.getEngagementRecord(e)}},e.updateBroadcastPayload=function(e,i){if(this&&this.widgetParameters){var n=this.widgetParameters;if(n.portalId&&(i.portalId=Number(n.portalId)),n.serviceLineId){var r=n.serviceLineId;return i.serviceLineId=r,t.serviceLines.getName(r).then((function(e){return i.serviceLine=e,i}))}}return A.resolve(i)}}(this,e)}Rr.prototype=Object.create(Lr.prototype),Object.defineProperty(Rr.prototype,"constructor",{value:Rr,enumerable:!1,writable:!0}),Pr.prototype=Object.create(Lr.prototype),Object.defineProperty(Pr.prototype,"constructor",{value:Pr,enumerable:!1,writable:!0});function jr(e,t){Lr.call(this,e,t),function(e,t){e.beforeAdd=function(e){return e.parameters.langOptions=t.langOptions,e.status=!0,A.resolve(e)}}(this,e)}function Vr(e,t){Lr.call(this,e,t),function(e,t){e.shouldDisplayBell=function(){return!1},e.execute=function(e,i){var n=this;this.isExecuting||(this.isExecuting=!0,i.rule&&e.broadcastCloseProactiveNotification(i,"accepted"),"_blank"===i.linkStrategy?(Jr(t,i),this._openTimeout=setTimeout((function(){this.isExecuting=!1,delete n._openTimeout}),1e3),window.open(i.url,i.linkStrategy,"noopener")):t.logDisabled?window.open(i.url,i.linkStrategy,"noopener"):(window.addEventListener("GoMoxie:PriorityEvents",(function(){window.open(i.url,i.linkStrategy,"noopener")}),!1),this._openTimeout=setTimeout((function(){delete n._openTimeout,window.open(i.url,i.linkStrategy,"noopener")}),3e3),Jr(t,i)))},e.destroy=function(){this._openTimeout&&clearTimeout(this._openTimeout)}}(this,e)}function Jr(e,t){ki("linkFollowed",{strategy:t.linkStrategy,url:t.url}),Ti(e,t.url,t.linkStrategy,t.rule.id)}function qr(e){this.shouldDisplayBell=!1,this.KNOWN_WIDGETS={chat:{requires:["portalId","host"]},email:{requires:["mailboxId"]},kb:{requires:["articleLimit","portalId","searchText"]},kbot:{requires:["portalId","host"]}},this.notificationType=0;var t=navigator;this.concierge=e,this.BaseWidget=Lr,this.publicAPI=this.concierge.publicApiV2,this.journeyViewManager=new Tr(e),this.stashedConciergeCss={top:"",bottom:""},this.needsForceBlur=!1,this.state="tab",this.device=ei(t),this.openWidget=!1,this.widgetLoadPromises={},this.widgetLoadParameters={},this.widgetsAdded=[],kt.log("WidgetManager constructor: device="+this.device),"Mobile"===this.device?this.widgetsType=new Nr(this):this.widgetsType=new Sr(this),this.bridgeListener={},this.widgetClones={}}jr.prototype=Object.create(Lr.prototype),Object.defineProperty(jr.prototype,"constructor",{value:jr,enumerable:!1,writable:!0}),Vr.prototype=Object.create(Lr.prototype),Vr.prototype.engagement_type=5,Object.defineProperty(Vr.prototype,"constructor",{value:Vr,enumerable:!1,writable:!0});var Fr={status:!1};function $r(e){var t,i=e.concierge.cacheManager;return e.tabStyle=e.tabStyle||{verticalOffset:"100",verticalAnchor:1,horizontalOffset:"20",cascade:1},i&&e.engagementWidgets&&(t=e.engagementWidgets).conciergeTab&&t.conciergeTab.tabStyle&&(void 0!==t.conciergeTab.tabStyle.verticalOffset&&(e.tabStyle.verticalOffset=t.conciergeTab.tabStyle.verticalOffset),void 0!==t.conciergeTab.tabStyle.verticalAnchor&&(e.tabStyle.verticalAnchor=t.conciergeTab.tabStyle.verticalAnchor),void 0!==t.conciergeTab.tabStyle.horizontalOffset&&(e.tabStyle.horizontalOffset=t.conciergeTab.tabStyle.horizontalOffset),void 0!==t.conciergeTab.tabStyle.cascade&&(e.tabStyle.cascade=t.conciergeTab.tabStyle.cascade)),e.tabStyle}function Ur(e,t){if(void 0!==t){var i,n;try{i=t.width.animVal.value,n=t.height.animVal.value}catch(e){return!1}t.getAttribute("viewBox")||t.setAttribute("viewBox","0 0 "+i+" "+n),t.setAttribute("height",25),t.setAttribute("width",25)}}function Hr(e,t){var i={name:t.ruleName,source:t.ruleSource,id:t.ruleId,action:t.action},n=A.resolve();return n=n.then((function(){return function(){if(e.notificationDisplayed())return kt.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): is closing the notification"),e.closeNotification()}()})).then((function(){return e.addWidget(t,i)})).then((function(i){if(!i||void 0===i.status||!1!==i.status)return!1!==e.openWidget&&e.openWidget!==t.widget&&e.hideWidget(!0),e.showWidget(t.widget,t);kt.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): halted because addWidget failed")})).then((function(){return e.showConcierge(),e.widgetsType.openConcierge(),{status:!0}})).catch((function(e){return kt.log("WidgetManager.displayWidget("+t.widget+":"+t.ruleName+"): failed: "+e),kt.log(e.stack),Fr}))}function Br(e){e.initEngagementWidgets(),$r(e),function(e){var t=e.widgetsType.html();t=(t=t.replace(/\/SCRIPT_LOCATION\//g,e.concierge.scriptLocation+"/")).replace(/\/DEVICE\//g,e.device);var i=!1;if(e.concierge.cacheManager&&e.engagementWidgets&&(i=e.engagementWidgets).conciergeTab&&i.conciergeTab.icon&&i.conciergeTab.icon.svg){var n=i.conciergeTab.icon.svg;t=t.replace(/<!-- replace: ICON -->/g,n)}var r=Gt(t=Xn(t)({concierge:e.concierge,CONCIERGE_TAB_ICON_SVG:e.engagementWidgets.conciergeTab.icon.svg,CON_CLOSED:e.isSingleChannelMode()?" single-channel":"",CON_ROLE_ATTRIBUTE:e.isSingleChannelMode()?"":' role="menu"',CLOSE_ICON:e.concierge.getTranslation("common","CLOSE_ICON"),CONCIERGE:e.concierge.getTranslation("common","CONCIERGE"),NOTIFICATION_ANNOUNCE:e.concierge.getTranslation("common","NOTIFICATION_ANNOUNCE")})),o=function(t){if("click"===t.type||13===t.which||32===t.which)return e.closeWidget(!1),!1};rt(r,"click",at("con-close-area"),o),rt(r,"keypress",at("con-close-area"),o);var a=at("con-widget-title-section");rt(r,"keyup",a,(function(){return He(this,{outline:"-webkit-focus-ring-color auto 5px"}),!1})),rt(r,"blur",a,(function(){return He(this,{outline:"none"}),!1}));var s=function(){if("click"===event.type&&He(this,{outline:"none"}),"click"===event.type||13===event.which||32===event.which){var t=Gt(this).closest(".concierge-widget").data("widget");e.postMessageToWidget(t,"titleClicked");var i=e.engagementWidgets.widgets[t];return i.titleBar.onclick&&i.titleBar.onclick(e),!1}};rt(r,"click",a,s),rt(r,"keypress",a,s),e.widgetsType.beforeAppend&&e.widgetsType.beforeAppend(r),Gt("body").append(r[0]),r.hide()}(e);var t=Gt("#concierge .con-icon svg");void 0!==t&&t.length>0&&Ur(0,t[0]);e.$concierge=Gt("#concierge"),e.widgetsType.start()}function Gr(e){return Gt('#concierge-widgets ul li[data-widget="'+e+'"]')}function zr(e){return!!e.data("parameters.proactive")}function Kr(e){return!!e.data("parameters.reactive")}function Qr(e,t){var i=Gt("#concierge-widget-area");i.removeClass("con-open"),e.widgetsType.closeWidgets&&e.widgetsType.closeWidgets();var n=A.resolve(),r=e.openWidget;e.$concierge.find("#concierge-widgets li[data-widget="+r+"] .con-icon").attr("aria-expanded","false"),"Tablet"===e.device&&(i.hasClass("con-animating")&&(n=n.then((function(){return i.promise()}))),n=n.then((function(){e.makePositionFixed(),e.forceBlur()}))),e.$concierge.removeClass("con-open-widget");var o=e.openWidget;return e.openWidget=!1,n.then((function(){if(e.widgetsType.focusWidgetButton(r),t)return ki("widgetClosed",{widgetName:o})})).catch((function(e){kt.log("Error Closing Widget:"+e)}))}qr.prototype.extendWidgetParameters=function(e){var t,i,n,r,o,a=e.widget,s={},c=this.engagementWidgets.widgets[a].widgetParameters;return"email"===a?(n="mailboxId",i="mailbox ID"):(n="portalId",i="portal ID"),c&&(o=c[n],t=c.host),(r=e[n]||o)||kt.log("No Moxie "+i+" specified for engagement."),s[n]=r,or(a)&&function(e,t,i){var n=e||t;n||kt.log("No Moxie chat host specified for engagement.");i.host=n}(e.host,t,s),s},qr.prototype.startExternal=function(e,t){var i=!0===t.enableChatDeflection||"true"===t.enableChatDeflection;null!==t.widget&&void 0!==t.widget||(t.widget=t.startEngagement),"chat"===t.widget&&i&&(t.widget="kbot"),delete t.startEngagement,delete t.enableChatDeflection,t.ruleSource=e;if(t.ruleId=-1*(1+["externalLink","externalAPI"].indexOf(e)),t.action="success",null!==t.widget&&void 0!==t.widget&&""!==t.widget){var n=this;return ut(t,this.extendWidgetParameters(t)),Hr(this,t).then((function(e){return e&&!0===e.status&&("kbot"===t.widget?(kt.log("WidgetManager.startExternal removing previous chat widget if one exists."),n.removeWidget({widget:"chat"},!0)):"chat"===t.widget&&(kt.log("WidgetManager.startExternal removing previous kbot widget if one exists."),n.removeWidget({widget:"kbot"},!0))),e}))}kt.log("WidgetManager.startExternal invoked with improper widget specification")},qr.prototype.addEventListeners=function(){var e=this;window.MOXIE_CONCIERGE=window.MOXIE_CONCIERGE||{},window.MOXIE_CONCIERGE.startEngagement=function(t){return e.startExternal("externalAPI",t)},this.dataStartListener&&ot(document,"click",this.dataStartListener),this.dataStartListener=rt(document,"click",nt(je,"data-moxie-start-engagement"),(function(t){var i=function(e){var t=/^moxie(.*)/,i={};for(var n in e)if(z(e,n)&&t.test(n)){var r=n.replace(t,"$1");i[r=r.charAt(0).toLowerCase()+r.slice(1)]=e[n]}return i}(Gt(this).data());return e.startExternal("externalLink",i),!1}))},qr.prototype.isSingleChannelMode=function(){return this.engagementWidgets.globalSettings.singleChannelMode},qr.prototype.isMobile=function(){return"Mobile"===this.device},qr.prototype.createEngagementRecord=function(e,t,i){var n,r,o=this.engagementWidgets.widgets[e];n=rr(e)?"kb":e,r=4===o.engagement_type?2:o.engagement_type;var a={id:$i(),dirty:!0,time:Date.now(),type:r,name:n,proactive:void 0!==i&&i,rule:void 0!==t?t:null,decision_type:"",kb:null,chat:null,email:null};nr(e)?a.chat={agents:[],missed_reason:0}:"email"===e&&(a.email={sent:!1});var s=this.concierge.cacheManager,c=s.getDataClone("profileJSON"),u=c.session.visits.length-1,l=c.session.visits[u].journey.length-1;return c.session.visits[u].journey[l].engagements||(c.session.visits[u].journey[l].engagements=[]),c.session.visits[u].journey[l].engagements.push(a),s.setData("profileJSON",JSON.stringify(c)),a.id},qr.prototype.getEngagementRecord=function(e){for(var t=this.concierge.cacheManager.getDataObject("profileJSON"),i=t.session.visits.length-1,n=0;n<t.session.visits[i].journey.length;n++)if(t.session.visits[i].journey[n].engagements)for(var r=0;r<t.session.visits[i].journey[n].engagements.length;r++)if(t.session.visits[i].journey[n].engagements[r].id===e)return B(t.session.visits[i].journey[n].engagements[r]);return null},qr.prototype.setEngagementRecord=function(e,t){for(var i=this.concierge.cacheManager,n=i.getData("profileJSON"),r=n.session.visits[n.session.visits.length-1].journey,o=r.length-1,a=JSON.stringify(t),s=o;s>=0;s--){var c=r[s].engagements;if(c)for(var u=c.length-1;u>=0;u--){var l=c[u];if(l.id===e){if(JSON.stringify(l)===a)return A.resolve();if(t.dirty=!0,s===o)c[u]=t;else{c.splice(u,1),0===c.length&&delete r[s].engagements;var d=r[o];d.engagements?d.engagements.push(t):d.engagements=[t]}return i.setData("profileJSON",JSON.stringify(n))}}}return A.resolve()},qr.prototype.removeEngagementRecord=function(e){for(var t=this.concierge.cacheManager,i=t.getData("profileJSON"),n=i.session.visits.length-1,r=0;r<i.session.visits[n].journey.length;r++)if(i.session.visits[n].journey[r].engagements)for(var o=0;o<i.session.visits[n].journey[r].engagements.length;o++)if(i.session.visits[n].journey[r].engagements[o].id===e)return i.session.visits[n].journey[r].engagements.splice(o,1),t.setData("profileJSON",JSON.stringify(i))},qr.prototype.getWidgetParameters=function(e){return this.widgetParameters[e]},qr.prototype.toggleWindow=function(){this.widgetsType.toggleWindow()},qr.prototype.knownWidgets={chat:Mr,kbot:Pr,kb:jr,email:Rr},qr.prototype.simpleWidgets={link:Vr},qr.prototype.initEngagementWidgets=function(){var e=this.concierge,t=JSON.parse(JSON.stringify(e.configuration.widgets));for(var i in t.widgets)this.knownWidgets[i]?t.widgets[i]=new this.knownWidgets[i](e,t.widgets[i]):t.widgets[i]=new Lr(e,t.widgets[i]),t.widgets[i].name=i;for(var n in this.simpleWidgets)t.widgets[n]=new this.simpleWidgets[n](e,{}),t.widgets[n].name=n;this.engagementWidgets=t},qr.prototype.addWidget=function(e,t,i){kt.log("WidgetManager.addWidget called with:",e,t,i);var n,r,o=e.widget;e=e||{};var a={widgetParameters:JSON.parse(JSON.stringify(e)),widget:null,finalize:function(){kt.log('WidgetManager.addWidget::widgetClone:finalize: Finalizing changes from beforeAdd for widget "'+o+'"'),ft(e,this.widgetParameters),"string"==typeof c.remoteURL&&"string"!=typeof this.widget.remoteURL&&delete c.remoteURL,ft(c,this.widget)}};a.finalize=a.finalize.bind(a),a.widgetParameters.rule=t,a.widgetParameters.proactive=a.widgetParameters.proactive||!1;var s=o+(t&&t.name?":"+t.name:"");kt.log("WidgetManager.addWidget("+s+"): invoked.");var c=this.engagementWidgets.widgets[o];c.shouldDisplayBell()&&(this.shouldDisplayBell=!0),delete c.prepareToLoadPromise,a.widget=JSON.parse(JSON.stringify(c));var u,l=this,d=function(e){return l._disabled?Fr:e},g={status:!0,ref:a.widget,parameters:a.widgetParameters,proactive:a.widgetParameters.proactive,engagementId:i,ruleSettings:this.concierge.rulesEngine.getSiteSettings()};c&&"function"==typeof c.beforeAdd?(l.widgetClones[o]=a,u=c.beforeAdd(g).finally((function(){l.widgetClones[o]=null}))):u=A.resolve(g);var h=a.widgetParameters.ruleSource;return u.then(d).then((function(t){var i,u,d,g=t.proactive;if("externalAPI"!==h&&"externalLink"!==h){if(kt.log("WidgetManager.addWidget("+s+"): ruleSource is not externalAPI or externalLink"),!t.status)return kt.log("WidgetManager.addWidget("+s+"): beforeAdd returns status of false, not adding"),Fr;if((u=function(e,t,i){if(i)return kt.log("WidgetManager.shouldSkipAdd("+t+"), allowing add because it is proactive and we should add the widget"),{skip:!1,saveForLater:null};for(var n=or(t),r=0;r<e.widgetsAdded.length;r++){var o=e.widgetsAdded[r];if(or(o)){var a=Gr(o),s=zr(a),c=Kr(a);if(o===t&&s&&!c)return{skip:!1,saveForLater:null};if(0===a.length)return kt.log("WidgetManager.shouldSkipAdd("+t+"), widget "+o+" should be added but was not found in the DOM. Skipping add"),{skip:!0,saveForLater:!1};if(n){if(s)return i?(kt.log("WidgetManager.shouldSkipAdd("+t+"), skipping add because proactive "+o+"  already on page"),{skip:!0,saveForLater:!1}):(kt.log("WidgetManager.shouldSkipAdd("+t+"), skipping add because "+o+" already on page. Saving params for later"),{skip:!0,saveForLater:!0});if(!i)return kt.log("WidgetManager.shouldSkipAdd("+t+"), skipping add because reactive "+o+"  already on page"),{skip:!0,saveForLater:!1}}}}return{skip:!1,saveForLater:null}}(l,o,g)).saveForLater&&or(o)&&function(e,t){var i=e.widgetsType.getNotification();if(i&&i.length){var n=i.data("parameters");n?(n.kbotParameters=t.parameters,kt.log("WidgetManager.saveWidgetParameters(): saved parameters from skipped KBOT")):kt.log("WidgetManager.saveWidgetParameters():parameters from skipped KBOT could not be saved. KBOT is not added later")}else kt.log("WidgetManager.saveWidgetParameters():parameters from skipped KBOT could not be saved because the notification could not be found to save the widget params. KBOT is not added later")}(l,t),u&&u.skip)return Fr}(a.finalize(),t.ref=c,t.parameters=e,t.proactive=e.proactive,void 0!==c.prepareToLoad&&(c.prepareToLoadPromise=c.prepareToLoad(t)),c.widgetParameters=t.parameters,c.shouldDisplayBell())?(r=Gr(o),n=r.length?r:l.widgetsType.addWidget(o,c),d=g?"parameters.proactive":"parameters.reactive",kt.log("WidgetManager.addWidget("+s+"): setting "+d),n.data(d,e),r.length||(void 0!==(i=n.find("svg"))&&i.length>0&&Ur(0,i[0]),l.widgetsAdded.push(o))):l.widgetsAdded.push(o);Gt("#concierge").show();var f=Gt("#concierge-tab");return l.isSingleChannelMode()&&l.isMobile()&&l.shouldDisplayBell?f.show():l.shouldDisplayBell&&!l.isSingleChannelMode()?f.show():f.hide(),t})).then(d).then((function(e){return e.status?(kt.log("WidgetManager.addWidget("+s+"): complete OK",e),ki("widgetAdded",{widgetName:ar(o),rule:{id:Ot(e,"parameters","rule","id"),name:Ot(e,"parameters","rule","name")}}),e):(kt.log("WidgetManager.addWidget("+s+"): did not add widget"),e)})).catch((function(e){return l.removeWidgetFromArray(o),kt.log("WidgetManager.addWidget("+s+"): failed: "+e),kt.log(e.stack),Fr}))},qr.prototype.removeWidgetFromArray=function(e){var t=this.widgetsAdded.indexOf(e);return t>-1&&(this.widgetsAdded.splice(t,1),!0)},qr.prototype.removeWidget=function(e,t){var i=e.widget;kt.log('WidgetManager.removeWidget("'+i+'"): invoked.'),this.removeWidgetFromArray(i);var n=Gt('#concierge-widgets ul li[data-widget="'+i+'"]');n&&n.remove(),this.$concierge.find("#concierge-widget-"+i).remove();var r=this.engagementWidgets.widgets[i];r&&(r.state=0),t||Gt("#concierge-widgets ul li").length||Gt("#concierge").hide()},qr.prototype.widgetWasAdded=function(e){return Gt('#concierge-widgets ul li[data-widget="'+e+'"]').length>0},qr.prototype.updateWidgetTitle=function(e,t){var i=Gt("#concierge-widget-"+e),n=i.find(".concierge-widget-header .con-widget-title"),r=t.text;n.text(r&&this.concierge.getTranslation(e,r,""));var o="";switch(t.buttonType||""){case"minimizeIcon":o=this.concierge.getTranslation("common","MINIMIZE_ICON");break;case"searchIcon":o=this.concierge.getTranslation("common","SEARCH_ICON");break;case"backIcon":o=this.concierge.getTranslation("common","BACK_ICON");break;default:o=""}var a=i.find(".concierge-widget-header .con-widget-icon");a.empty();var s=t.graphic||"";if(s.length){if("<"===s.charAt(0))a.html(s);else{var c=this.concierge.scriptLocation+"/widgets/"+e+"/"+s;a.html('<img src="'+c+'" />')}a.attr("title",o)}var u=i.find(".concierge-widget-header .con-widget-title-section");t.hasCallback?u.addClass("clickable-title").addClass(".clickable-title"):u.removeClass("clickable-title").addClass(".clickable-title")},qr.prototype.makePositionAbsolute=function(){var e;"absolute"!==this.$concierge.css("position")&&(this.stashedConciergeCss=this.$concierge.css(["top","bottom"]),e=this.$concierge.offset().top,this.$concierge.css({position:"absolute",top:e,bottom:""}))},qr.prototype.makePositionFixed=function(){var e,t;"fixed"!==this.$concierge.css("position")&&this.stashedConciergeCss&&(t="auto"!==this.stashedConciergeCss.top?"top":"bottom",e=this.$concierge.offset().top-document.body.scrollTop,this.$concierge.css({position:"fixed",top:e,bottom:"auto"}),"top"===t?this.$concierge.animate({top:this.stashedConciergeCss.top},{label:"makePositionFixedTop"}):this.$concierge.animate({top:oe()-parseInt(this.stashedConciergeCss.bottom,10)-this.$concierge.height()},{label:"makePositionFixedBottom",done:function(){this.$concierge.css({top:"auto",bottom:this.stashedConciergeCss.bottom})}.bind(this)}))},qr.prototype.handleGetTabInfo=function(e,t){var i=this.concierge.cacheManager.getWidgetCache(t,"cookieId",!0);i||(i=Math.ceil(1e5*Math.random()),this.concierge.cacheManager.setWidgetCache(t,"cookieId",i,!0)),e.source.postMessage(JSON.stringify(zn({origWindowName:window.name,cookieID:i,currentOrigin:window.location.protocol+window.location.host,previousOrigin:window.location.protocol+window.location.host,sessionId:this.concierge.cacheManager.getWidgetCache(t,"sessionId")})),e.origin)},qr.prototype.handleSetChatInProgress=function(e,t,i){var n=this.engagementWidgets.widgets[t];n&&void 0!==n.sendSearchGuid&&n.sendSearchGuid(e,i),this.concierge.cacheManager.setWidgetCache(t,"sessionId",Math.abs(parseInt(e))),e>0?this.markChat(e,"start"):e<0&&this.markChat(e,"end")},qr.prototype.setNotificationType=function(e){return e>=0&&e<=2&&(this.notificationType=e,!0)},qr.prototype.handleBroadcast=function(e,t,i){if(this[e+"HandleBroadcast"]&&this[e+"HandleBroadcast"](e,t,i))return A.resolve(!0);var n=this,r=this.engagementWidgets.widgets[e],o="widget:"+ar(e)+":"+t;return(r&&r.updateBroadcastPayload?r.updateBroadcastPayload(o,i):A.resolve(i)).then((function(t){return function(e,t,i,n){try{switch(i){case"widget:chat:agentJoinedSession":ui(e.concierge,!0,t,n.agentId,n.agentName,n.sessionId,n.serviceLine,n.serviceLineId);break;case"widget:chat:agentLeftSession":n.agentId&&ui(e.concierge,!1,t,n.agentId,n.agentName,n.sessionId,n.serviceLine,n.serviceLineId);break;case"widget:chat:articleViewed":case"widget:kb:articleViewed":di(e.concierge,t,n.articleId,n.articleTitle);break;case"widget:chat:chatSessionStarted":li(e.concierge,!0,t,n.sessionId,n.serviceLine,n.serviceLineId);break;case"widget:chat:chatSessionEnded":li(e.concierge,!1,t,n.sessionId,n.serviceLine,n.serviceLineId),function(e,t){var i=t.sessionId;i&&e.concierge.cacheManager.setWidgetCache("kbot","lastChatSessionEnded",i,!1)}(e,n);break;case"widget:email:emailSent":gi(e.concierge,t,n.mailboxId);break;case"widget:kb:portalSearched":case"widget:chat:portalSearched":wi(e.concierge,t,n.searchText,n.portalId,n.articlesList);break;case"widget:chat:prechatQuestionnaireComplete":yi(e.concierge,t,n.serviceLine,n.serviceLineId)}}catch(e){kt.log("Error in processBroadcast"+e)}}(n,e,o,t),ki(o,t),null})).catch((function(e){kt.log("handleBroadcast Error:"+e)}))},qr.prototype.markChat=function(e,t){var i=this.concierge.cacheManager.getData("profileJSON"),n=this.journeyViewManager.markChat(i,e,t);this.concierge.cacheManager.setData("profileJSON",JSON.stringify(n))},qr.prototype.showNotification=function(e,t){kt.log("WidgetManager.showNotification called:",e,t),this.notificationDisplayed()&&this.closeNotification(!0);var i="other";2===t.notificationType?i="widgetMessage":1===t.notificationType&&(i="proactiveOffer"),function(e,t,i,n){var r=t.title,o=t.message,a=t.icon,s=t.callToAction,c=e.widgetsType.getNotification();c.data("parameters",t),c.data("engagementId",i),c.data("notificationType",n),c.find(".concierge-notification-title").html(r||""),c.find(".con-notification-body").html(o||"");var u=c.find(".con-notification-calltoaction");s&&s.length?(u.show(),u.html(s||""),u.attr("tabindex","0")):(u.hide(),u.attr("tabindex","-1"));var l=c.find(".con-notification-icon"),d="";if(a){l.show();var g=e.concierge.scriptLocation+"";V(g,"/")||(g+="/"),d='<img alt="" tabindex="-1" src="'+(a=(a=a.replace(/\/SCRIPT_LOCATION\//g,g)).replace(/^http:/,""))+'" role="presentation">'}else l.hide();l.html(d)}(this,e,t.engagementId,i),this.widgetsType.displayNotification(e,t.engagementId),this.setNotificationType(t.notificationType);var n=ar(e.widget);ki("notification",{engagementId:t.engagementId,notificationType:i,widgetName:n,status:"displayed",rule:e.rule}),1===t.notificationType&&(this.setLastNotified((new Date).getTime()),ki("proactiveOffer",{widgetName:n,status:"displayed",rule:e.rule}),this.concierge.currentOfferCreatedAt=Date.now(),pi(this.concierge,n,e.rule))},qr.prototype.notificationDisplayed=function(){return this.widgetsType.notificationDisplayed},qr.prototype.closeNotification=function(e){var t=A.resolve(),i=this.widgetsType.getNotification();if(i){var n=i.data("notificationType");if(n){var r=i.data("parameters"),o=i.data("engagementId"),a=this.widgetsType;t=t.then((function(){return kt.log("wm.closeNotification called. about to call closeNotification on widgetsType"),a.closeNotification(e)})).then((function(){i.data("notificationType",!1);var e={engagementId:o,notificationType:n,status:"closed"};r&&(e.widgetName=ar(r.widget),e.rule=r.rule),ki("notification",e)}))}}return t},qr.prototype.broadcastCloseProactiveNotification=function(e,t){ki("proactiveOffer",{widgetName:e.widget,status:t,rule:e.rule}),"accepted"===t?vi(this.concierge,e.widget,e.rule):"declined"===t&&mi(this.concierge,e.widget,e.rule)},qr.prototype.setupBridge=function(e,t){var i=this,n=this.engagementWidgets.widgets[e],r=function(e){return parseInt(e)};n&&(this.bridgeListener[e]&&window.removeEventListener("message",this.bridgeListener[e],!1),this.bridgeListener[e]=function(o){var a,s,c,u,l={};if("string"==typeof o.data&&"SessionCleared"!==o.data)try{l=JSON.parse(o.data)}catch(e){kt.log("WidgetBridge received invalid JSON: ",e),kt.log("Payload was:"+o.data)}else l=o.data;if(l&&l.call&&or(e))switch(kt.log("Event: "+l.call+" URL: "+l.url+" DATA: "+o.data),l.call){case"openSurvey":i.handleBroadcast(e,"surveyLoaded",{sessionId:r(i.concierge.cacheManager.getWidgetCache(e,"sessionId"))}),Gt("#concierge-widget-"+e+" iframe").attr("src",l.url);break;case"setReturnFromSurvey":i.handleBroadcast(e,"surveyCompleted",{sessionId:r(i.concierge.cacheManager.getWidgetCache(e,"sessionId"))}),i.hideWidget(!1);break;case"setFlyoutContent":Gt("#concierge-widget-"+e+" iframe").attr("src",l.url);break;case"chatFocus":"Tablet"===i.device&&"object"!=typeof window.visualViewport&&(i.makePositionAbsolute(),i.needsForceBlur=!0);break;case"chatBlur":break;case"getTabInfo":i.handleGetTabInfo(o,e);break;case"setChatInProgress":var d=parseInt(l.sessionId);0===l.sessionId&&"Tablet"===i.device&&"object"!=typeof window.visualViewport&&(i.makePositionAbsolute(),i.needsForceBlur=!0),i.handleSetChatInProgress(d,e,t),d>0&&i.handleBroadcast(e,"chatSessionStarted",{sessionId:d})}if(o.data.widget===e){if(!rr(e)){var g=or(e)&&"object"==typeof n.remoteURL?n.remoteURL[n.portalId]:n.remoteURL;if(void 0!==n.shouldReplaceIframeSrc&&g&&o.origin.toLowerCase()!==g.match(/^https?:\/\/[^/]+/)[0].toLowerCase()&&(o.origin!=="http://"+window.location.hostname||o.origin!=="https://"+window.location.hostname))return}a=o.data,s=o.data.parameters,kt.log("["+a.type+"] message accepted from: "+o.origin),c={},u=null;var h=i.concierge.cacheManager.getWidgetCache(e,"engagement_id",!0),f=function(e,t){e&&e.source&&e.source.postMessage(zn(t),e.origin)};switch(a.type){case"focusEvent":"Tablet"===i.device&&"object"!=typeof window.visualViewport&&(i.makePositionAbsolute(),i.needsForceBlur=!0);break;case"blurEvent":"Tablet"===i.device&&"object"!=typeof window.visualViewport&&(i.needsForceBlur=!1);break;case"resetConcierge":Qr(i,!0),i.removeWidget(t,!0),i.addWidget(t,t.rule);break;case"getVisitorProfile":u="profileJSON",c={type:"getVisitorProfileResponse",replyForMsgId:a.msgId,parameters:{data:i.concierge.cacheManager.getData(u)}},f(o,c);break;case"setVisitorProfile":u="profileJSON",i.concierge.cacheManager.setData(u,JSON.stringify(s.data));break;case"getEngagementRecord":c={type:"getEngagementRecordResponse",replyForMsgId:a.msgId,parameters:{id:h,data:i.getEngagementRecord(h)}},f(o,c);break;case"onQuestionnaireSubmit":c={type:"onQuestionnaireSubmitResponse",replyForMsgId:a.msgId},i.concierge.onQuestionnaireSubmitCallbacks?i.concierge.onQuestionnaireSubmitCallbacks.doCallbacksAsync(xr.load(s.data)).then((function(e){c.parameters=e.toJson(),f(o,c)})):(c.parameters=JSON.stringify(s),f(o,c));break;case"getParameters":c={type:"getParametersResponse",replyForMsgId:a.msgId,parameters:{data:t}},f(o,c);break;case"setEngagementRecord":i.setEngagementRecord(h,s.data);break;case"createEngagementRecord":h=i.createEngagementRecord(e,s.rule),i.concierge.cacheManager.setWidgetCache(e,"engagement_id",h,!0),c={type:"createEngagementRecordResponse",replyForMsgId:a.msgId,parameters:{id:h,data:i.getEngagementRecord(h)}},f(o,c);break;case"getWidgetInitData":c={type:"getWidgetInitDataResponse",replyForMsgId:a.msgId,parameters:{data:{clientHref:window.location.href,parameters:n.widgetParameters,configuration:n.configuration,translation:i.concierge.localization.data}}},f(o,c);break;case"getConfiguration":c={type:"getConfigurationResponse",replyForMsgId:a.msgId,parameters:{data:n.configuration}},f(o,c);break;case"getCache":c={type:"getCacheResponse",replyForMsgId:a.msgId,parameters:{key:s.key,value:i.concierge.cacheManager.getWidgetCache(e,s.key,s.persist)}},f(o,c);break;case"getCacheData":c={type:"getCacheDataResponse",replyForMsgId:a.msgId,parameters:{key:s.key,value:i.concierge.cacheManager.getData(s.key)}},f(o,c);break;case"getTranslation":c={type:"getTranslationResponse",replyForMsgId:a.msgId,parameters:{value:i.concierge.localization.data}},f(o,c);break;case"getOtherCache":c={type:"getOtherCacheResponse",replyForMsgId:a.msgId,parameters:{key:s.key,value:i.concierge.cacheManager.getWidgetCache(e,s.key,s.persist)}},f(o,c);break;case"setCache":i.concierge.cacheManager.setWidgetCache(e,s.key,s.value,s.persist);break;case"removeCache":i.concierge.cacheManager.removeWidgetCache(e,s.key,s.persist);break;case"notificationMessage":if(i.widgetsType.notificationDisplayed&&1===i.notificationType)return;if(Gt("#concierge").hasClass("con-open-widget"))return;s.widget=e,s.title&&(s.title=i.concierge.getTranslation(ar(e),s.title)),i.showNotification(s,{engagementId:h,notificationType:2});break;case"updateWidgetTitle":i.updateWidgetTitle(e,s);break;case"updateTabText":Gt("#concierge .con_tab_text").text(s.text);break;case"hideWidget":i.hideWidget(!1);break;case"setServiceLineId":i.setServiceLineId(s,e);break;case"setActive":i.setActive(s,e);break;case"handleClose":i.concierge.cacheManager.setWidgetCache(e,"willHandleClose",s.value,!0);break;case"callFunction":c={type:"callFunctionResponse",replyForMsgId:a.msgId,parameters:{}},n[s.funcName]&&(c.parameters.result=n[s.funcName](s.funcArgs)),f(o,c);break;case"broadcast":i.handleBroadcast(e,s.eventType,s.data)}}},window.addEventListener("message",this.bridgeListener[e],!1))},qr.prototype.postMessageToWidget=function(e,t,i){var n,r,o=this.engagementWidgets.widgets[e],a=this.concierge.cacheManager.getWidgetCache(e,"active_session");"willClose"!==t&&"willTerminate"!==t||(this.setActive({active:!1},e),this.concierge.cacheManager.setWidgetCache(e,"active",!1)),a&&o.remoteURL&&i?(r=or(e)&&"object"==typeof o.remoteURL?o.remoteURL[o.portalId]:o.remoteURL,n=r.match(/^https?:\/\/[^/]+/)[0]):n="*";var s=Gt("#concierge-widget-"+e+" iframe");if(s.length){var c=s[0].contentWindow,u={widget:e,type:t,parameters:i},l=function(){c.postMessage(zn(u),n),kt.log(u.type+" message posted to : "+n)},d=s.data("loadPromise");return d?d.then(l):Mi(l)}return A.resolve()},qr.prototype.callWidgetFunction=function(e,t,i){var n,r,o=this.engagementWidgets.widgets[e];o.remoteURL?(r=or(e)&&"object"==typeof o.remoteURL?o.remoteURL[o.portalId]:o.remoteURL,n=r.match(/^https?:\/\/[^/]+/)[0]):n="*";var a=Gt("#concierge-widget-"+e+" iframe"),s=a[0].contentWindow,c={widget:e,type:"functionCall",parameters:{functionName:t,functionData:i}},u=function(){s.postMessage(zn(c),n),kt.log(c.type+" message posted to : "+n)};return a.data("loaded")?A.resolve(u()):(a.data("loadPromise")||A.resolve()).then(u)},qr.prototype.writeSrcToIframe=function(e){var t=Gt("#concierge-widget-"+e+" iframe");if(t.length>0){var i=this.concierge.scriptLocation+"/widgets/"+e+"/"+this.concierge.assetVersion.widgets+"/index.html";t.attr("src",i)}},qr.prototype.loadWidget=function(e,t,i){if(kt.log('WidgetManager.loadWidget("'+e+'", "'+JSON.stringify(t)+'", '+i+'"): invoked.'),!this._disabled){var n=i,r=this.engagementWidgets.widgets[e];if(r){if(!r.state){e&&this.widgetClones[e]&&(kt.log('WidgetManager.loadWidget("'+e+'") called with active clone'),this.widgetClones[e].finalize()),"externalAPI"!==t.rule.source&&(r.widgetParameters=t),this.widgetLoadParameters[e]=t;var o=Gt("#concierge-widget-area");if(0===this.$concierge.find("#concierge-widget-"+e).length){var a={widget:r,widgetName:e,CLOSE_ICON:this.concierge.getTranslation("common","CLOSE_ICON"),FOOTER:this.concierge.getTranslation("common","FOOTER")},s="";this.engagementWidgets.globalSettings&&!this.engagementWidgets.globalSettings.hideMoxieBranding&&(s=Xn('<div class="concierge-widget-footer">\n  <span class="powered" aria-label="<%= FOOTER %> go moxie.com"><%=FOOTER%></span>\n  <svg focusable="false" version="1.1" id="black" xmlns="http://www.w3.org/2000/svg"\n    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 547.2 91"\n    enable-background="new 0 0 547.2 91" xml:space="preserve">\n    <g>\n      <path d="M87.4,27.7c-1.8-0.2-3.1-0.3-4.3-0.1c-0.9,0.2-2.9,0.1-4.3,3.1c-0.4,0.9,1,1.5,2.3,1.3s3.9-0.1,5.6,1.4\n              c2,1.7,2.6,8.8-3.5,13.7c-5.7,4.6-17.5,3.5-20.1-3.3c-2.5-6.4,0.5-11.2,2.6-13.1c2.4-2.1,5-3.9,10.6-4.3c0.6,0,2.1-1.3,2.7-3.6\n              c0.2-1-1.2-1.9-1.9-1.9c-4.7-0.1-7.4,0.4-11.6,2.2c-4.4,1.8-10.7,5.9-11.7,14.5c-2.3,2.9-5.7,5.9-9.4,8.9c0,0-0.4,0.3-0.5,0.2\n              c-0.2-0.1-0.1-0.5-0.1-0.5c0.1-4.4-0.1-7.8-0.1-8.7c-0.1-2.3-0.3-3.6-0.5-5.3c-0.1-0.5-0.1-1.7-1.3-2.7c-1.3-1-1.8-1-2.1-0.9\n              c-0.6,0.3-0.5,1.6-0.8,2.7c-0.2,0.7-0.7,2.2-1.1,3c-0.5,1.3-1.4,2.7-2.5,4.4c-3.7,5.5-18.2,14.4-24.1,11.8\n              c-5.5-2.4-1.6-9.3-0.2-11.8s11.5-13.2,26.7-13c1.4,0,7.6,1.3,8.3,1.5c1-0.2,1.8-0.9,1.3-2.3c-0.8-2.2-0.6-3-6.1-4.2\n              c-7.2-1.6-34.1,0.1-40.6,22.2c-1.4,4.8,0.8,9,2.8,10.9c3.4,3.3,9.7,4.1,15.4,2.5c6-1.7,11.5-5.1,16.6-10.1c0.2-0.2,0.5-0.5,0.7-0.7\n              c0.4-0.4,1.4-1,1.3,0.9c-0.1,1-0.2,2.1-0.4,3.1c-0.1,1-0.2,2-0.4,3c-1.9,1.4-3.8,2.7-5.6,4c-4.1,2.9-7.5,4.8-11,7.1\n              c-3.7,2.4-7.1,5.4-8.8,7c-3.3,3.1-6.1,7-5.9,12c0.3,5,2,8.7,11.8,8.6c10.7-0.1,19.2-8.8,23.6-21.8c1.5-4.6,2.3-10.2,2.7-15.4\n              c4.8-3.5,8.3-6.7,10.2-8.7c0,0,0.4-0.3,0.6-0.2s0.4,0.7,0.4,0.7c2.8,7.1,11,10.6,19.7,10c12-0.8,20.8-8.4,21.1-16.6\n              C95.4,38,95.5,28.7,87.4,27.7z M28.4,77.9c-3.1,4.1-7.1,7.6-10.9,7.6c-3.9,0-5.3-2.1-4.7-4.7c0.6-2.9,3-6.1,4.8-7.8\n              c1.2-1.1,3.2-2.8,4.5-3.9c3.2-2.6,7.5-5.9,12.6-9.4c0.4-0.3,0.9-0.3,0.8,0.8c-0.2,1.5-0.5,2.9-0.7,4.1C34.2,67.2,32,73.1,28.4,77.9\n              z" />\n      <path\n        d="M359.1,47.2c-3.7-1.2-5.9,0.9-6.6,2.6c-0.7,1.6-0.8,4.6,2.5,5.6c3.3,1.1,6,0.1,7.1-2.8C363.2,49.7,361.3,47.9,359.1,47.2z" />\n      <path d="M546.4,54.7c-0.2,0.2-2.5,0.8-3.4,0.9c-2.1,0.1-7.5-0.2-13.3-6c-5.8-5.8-9.8-19.8-15.4-27.2c-1.5-1.9-3-3.3-4.8-3.9\n              c-1.3-0.5-3.1-0.4-4.3-0.2c-3.7,0.6-5.6,2.5-10.1,8.6c-3.7,5-5.8,10.2-6.7,12.5c-1.3-10.7-3.8-17.1-9.7-15.1\n              c-3.6,1.2-8.7,9.6-10.3,13.3c0-1.3-0.1-3.3-0.2-6.1c-0.4-6.8-1.7-10.1-5.1-11.6c-4.6-2.1-10.7-1.8-19.1,2.1\n              c-4.5,2.1-8,3.8-10.3,5.6c-2.4,1.9-3.7,7-0.7,6c4.8-1.5,5.7,0.3,6.1,3.7c0.1,1.1,0.1,2.1-0.1,3.1c-0.7,4.8-7.1,9.8-14.2,9.1\n              c-7-0.7-11.1-3.7-11.3-10.5c-0.2-6.7,4.9-10.2,6.7-11.2c2.6-1.5,7.4-2.6,7.4-2.6c0.9-1,2.1-3.5-0.5-3.8\n              c-4.4-0.6-16.5,1.2-20.3,11.1c-1.4,3.8-1.4,7.6-0.3,11c-3.3,2.4-10.2,6.4-19.8,6.4c-10.1,0-13-5.2-12.8-13\n              c0.2-7.3,6.9-11.1,13.4-11.3c6.6-0.2,8.3,1.9,10.4,3.1c1.9,0.2,3.7-1.6,3.2-3.3c-0.5-1.5-1.7-5-12.8-5.4\n              c-13.9-0.4-23.1,8.1-23.1,19.9c0.1,11.5,11,16.1,20.5,16c10.7-0.1,18.9-4.8,23.1-8.2c3.2,4.8,8.9,8,16,8\n              c15.7-0.2,20.8-10,20.7-17.4c-0.1-3.4-0.6-5.7-1.3-7.2c-0.7-1.5,0.6-3.2,1.6-3.8c3.2-1.9,6.5-3.4,10.4-3.2\n              c5.9,0.3,6.2,15.1,5.6,22.8c-0.6,7.7,1.3,7.7,2.9,7.7c0.7,0,2.6-1.6,3.1-2.8c0.5-1.2,0.8-2.4,1-2.9c2.9-7.5,8.9-16.7,9.3-17\n              c0.4-0.2,2.9-1.5,3.5,3c0.5,3.3,1.4,14,3.6,15c0.1,0.1,1.1,0.5,1.7,0.5c1.3,0.1,2.6-0.4,3.1-0.9c0.6-0.7,2.3-6.2,5.3-11.8\n              c3-5.5,7.9-12.4,10.6-12.7c2.9-0.4,5.4,6.9,9.1,15.2c2.3,5.1,4.9,10.7,8.7,14.6c3.5,3.6,7.7,5,12.3,5.2c6.1,0.2,10-1.8,11.1-3.2\n              C547.7,55.7,546.9,54.3,546.4,54.7z" />\n      <path d="M177.5,58.2c-0.3-0.1-0.8-0.1-1.1-0.1c-3.6,0-4.3-2.9-4.8-4.9c-0.8-3.3-0.7-7.7-0.9-12.1c-0.1-6.1,0.4-31.6,0.4-34.3\n              c0-1.4-1.5-2.4-2.7-2.8c-2-0.7-5-1.2-6.6,0.5c-2.2,2.3-8.4,10.4-14,21.3c-4.8,9.3-7.9,17.2-8.9,19.3c-0.3,0.6-0.7,0.6-0.9,0.4\n              c-1.6-1.8-9.5-18.4-13.7-33.8c-1.9-6.9-1.6-10.1-3.4-11.2c-1.2-0.7-2.5-0.5-6.3-0.1c-0.3,0-0.5,0.1-0.7,0.2\n              c-1.3,0.3-2.5,0.7-3.4,1.3c-1.6,1.2-1.6,3.2-1.8,4.4c-0.2,1.2-4.2,20.2-5.8,32.3c-1.6,12.1-3.5,28-2.6,31.4\n              c0.5,2.1,2.5,3.6,4.5,3.9c2,0.4,3.5-0.2,4.2-0.5c0.2-0.1,0.5-0.2,0.6-0.9c0-0.7-0.3-0.5-0.6-3.4c-0.4-3.8,1.3-23.3,2.1-31.7\n              c0.9-8.3,3.3-19.1,4.3-22.6c2.3,7.8,10.8,27.6,19,39.5c0.3,0.5,1.1,0.8,1.9,1c5.9,1.3,6-0.8,7.5-5.2c1.5-4.4,10.7-23.4,13.4-28.3\n              c1.6-2.9,3.9-6.4,6.2-8.7c-0.6,6.2-1.4,26.5-1,34.8c0.3,9.2,0.7,13.1,7,14.4c1.4,0.3,4.3,0.1,6.7-1.2\n              C178.8,59.7,178.3,58.6,177.5,58.2z" />\n      <path\n        d="M277,18c3.4-0.3,5.5-2.3,5.4-5.3c-0.1-3-2.6-3.9-4.9-3.7c-3.8,0.3-5,3.1-5,4.9C272.6,15.7,273.6,18.4,277,18z" />\n      <path\n        d="M345.7,46c-2.5,0.4-6,4.8-16.5,6.3c-6.3,0.9-11.9,0-15.4-2.6c-4.8-3.4-6.6-9.4-5.3-11.2c0.3-0.5,1.1-0.4,2,0.1\n              c1.9,1,5.8,2.7,11.2,2.3c9-0.7,15.2-4.9,14.5-11.8c-0.6-6-6.2-9.1-14-9.1c-11.7,0-22.2,8.4-22.4,19.6c0,0.4,0,0.8,0,1.1\n              c-8.5,7.8-15.8,9.6-18.9,7.4c-3-2.1-0.5-13.4,0-16.9c0.5-3.4,0.6-5.6-1.2-7.4c-1.9-1.8-4.6-1.4-5.6-1.2c-1,0.2-0.9,2.4-1,3.5\n              c-0.1,1.1-0.6,3.2-1.1,12.2c-0.3,4.5-0.2,9.3,2,12.6c2.2,3.3,6.3,4.6,11.4,3.7c5.6-1,11.4-5,15.6-8.4c3.2,8.1,12.6,12.1,22.8,12\n              c12.2-0.1,20-4.9,21.8-6.4c0.5-0.4,1.4-2.3,1.6-3.3C347.1,47.3,346.9,45.8,345.7,46z M311.1,30.5c1.4-2.5,4.6-4.4,7.4-4.9\n              c5-0.9,9.4,0.6,9.8,4.3c0.6,4.7-5.8,7.4-12.8,5.6c-1.1-0.3-2.5-0.8-3.5-1.5C310.7,32.8,310.8,31.2,311.1,30.5z" />\n      <path d="M269.5,58.3c-4.8,0.3-8.9-3.7-11.4-6.5c-1.3-1.5-6.5-7.5-8.7-10.9c-0.2-0.2-0.1-0.4,0.2-0.7c10.5-8.3,11.8-8.8,15.5-12.7\n              c4.2-4.5,2.9-7.1-0.6-9.2c-0.7-0.4-1.9-0.2-1.9,0.6c-0.2,3.1-4.4,6.9-14.2,15.3c-1.2,1-3.3,0.7-3.8,0c-0.3-0.4-0.8-1.2-1.2-1.8\n              c-4-6.3-7.3-8.3-9.4-8.8c-3.2-0.8-7.3-1.2-13.3,0.1c-6,1.3-12.8,2.5-13.7,3c-0.9,0.5-2.5,2.3-2.3,3.1c0.2,1,1.5,1,2.5,0.8\n              c1.3-0.1,3-0.2,4.4,1.3c2,2.1,4.1,8.1-2.4,13.7c-6.5,5.6-19.2,5.6-21.4-3c-1.9-7.5,3.1-12.2,5.7-13.8c1-0.6,2-1.1,3.1-1.6\n              c0.6-0.2,1.2-0.5,1.8-0.6c0.7-0.2,2-0.5,2.7-0.8c0.5-0.2,2.2-3,2.1-3.5c-0.1-0.4-0.3-0.8-0.7-1.1c-0.6-0.6-2.6-0.9-7.5,0.3\n              C190,22.9,179,27,178.3,39.1c-0.7,11,9.1,17.3,20.7,16.3c12.5-1.1,20-8,20.3-17c0-1.1,0-2.6-0.2-4.1c-0.3-2-0.6-3.9,0.2-4.6\n              c1.6-1.4,5.3-1.7,5.8-1.8c5.8-0.8,9.3,5.8,11.8,9c0.7,0.8,2,2.6,2.8,3.7c0.2,0.3-0.1,0.7-0.7,1.3c-9.6,8.2-13.3,11.8-15.1,14\n              c-1.9,2.4-4.8,6.9-2.1,9.6c1.4,1.4,3.7,1.5,4.2,0.4c1.2-2.7,4-9,15.4-19.1c0.8-0.7,2.1-1,2.5-0.7c3.1,4.2,6.6,8.6,9.3,11.6\n              c5.6,6.1,13.9,5,17.8,3C272.8,59.8,272.3,58.2,269.5,58.3z" />\n      <path d="M532.8,21.4h-2v-1.3h5.5v1.3h-2V27h-1.6V21.4z M543.1,20.1l-1.8,3.8l-1.8-3.8h-2.1v7h1.6v-4.4l1.9,3.8h0.9l1.9-3.8V27h1.6\n              v-7H543.1z" />\n    </g>\n  </svg>\n</div>')(a)),a.moxieBranding=s;var c=Xn('<div class="concierge-widget" id="concierge-widget-<%= widgetName %>" data-widget="<%= widgetName %>">\n  <header class="concierge-widget-header">\n    <div class="con-widget-title-section">\n      <div class="con-widget-icon"></div>\n      <h2 class="con-widget-title" tabindex="0"><%= widget.title %></h2>\n    </div>\n    <div class="con-close-area">\n      <button type="button" class="con-close-widget" aria-label="<%= CLOSE_ICON %>">\n        <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" enable-background="new 0 0 20 20" stroke-width="0">\n          <title><%= CLOSE_ICON %></title>\n          <polygon points="17.3,1.1 10.2,8.3 3.1,1.1 1.3,2.9 8.4,10 1.3,17.1 3.1,18.9 10.2,11.8 17.3,18.9 19.1,17.1 11.9,10 19.1,2.9 "/>\n        </svg>\n      </button>\n    </div>\n  </header>\n\n  <iframe allow="geolocation" frameborder="no" class="widget-content" aria-live="polite" aria-atomic="true"></iframe>\n  <%= moxieBranding %>\n</div>\n')(a);c=c.replace(/\/SCRIPT_LOCATION\//g,this.concierge.scriptLocation+"/"),o.append(c)}void 0===i&&(i=this.createEngagementRecord(e,void 0!==t?t.rule:null),n=i),r.state=1,r.proactive=t&&t.proactive||!1,kt.log("WidgetManager.loadWidget("+e+"): set widget.proactive="+r.proactive);var u=this,l=this.concierge.cacheManager.getWidgetCache(e,"active_session");if(l||r.shouldReplaceIframeSrc){var d=Gt("#concierge-widget-"+e+" iframe"),g=r.getRemoteURL();kt.log("WidgetManager.loadWidget("+e+"): requests iframe src="+g,"hasActive:",l,"shouldReplace:",r.shouldReplaceIframeSrc),d.data("loadPromise",i=new A((function(e){d.attr("src",g),d.on("load",(function(){d.data("loaded")||(d.data("loaded",!0),e(n))}))})))}else void 0!==r.prepareToLoadPromise?r.prepareToLoadPromise.then((function(){u.writeSrcToIframe(e)})):this.writeSrcToIframe(e);this.setupBridge(e,t),this.updateWidgetTitle(e,{text:r.titleBar&&r.titleBar.text?"title":"",graphic:r.titleBar&&r.titleBar.graphic?r.titleBar.graphic:null})}var h=this.concierge.getTranslation(e,"title","Concierge");Gt("#concierge-widget-"+e).find("iframe").attr("title",h)}return i}},qr.prototype.shouldReplaceWidget=function(e,t){return!!this.widgetLoadParameters[e]&&(!this.isActive(e)&&(!!t&&!!this.widgetLoadParametersDiffer(this.widgetLoadParameters[e],t)))},qr.prototype.widgetLoadParametersDiffer=function(e,t){var i,n;if(!(e&&e.widget&&t&&t.widget))return!0;if(i=e.parameters||e,n=t.parameters||t,""+e.widget!=""+t.widget)return!0;switch(e.widget){case"chat":if(parseInt(i.portalId,10)!==parseInt(n.portalId,10))return!0;break;case"kb":if(parseInt(i.portalId,10)!==parseInt(n.portalId,10))return!0;if(""+i.searchText!=""+n.searchText)return!0;if(""+i.articleId!=""+n.articleId)return!0;break;case"email":if(parseInt(i.mailboxId,10)!==parseInt(n.mailboxId,10))return!0}return!1},qr.prototype.replaceWidget=function(e,t,i,n){t.state=0,this.$concierge.find("#concierge-widget-"+e).remove();var r=this.engagementWidgets.widgets[e],o=this,a={status:!0,ref:r,parameters:i.parameters||i,ruleSettings:this.concierge.rulesEngine.getSiteSettings(),engagementId:n};return("function"==typeof r.beforeAdd?r.beforeAdd(a):A.resolve(a)).then((function(e){return o.finishReplaceWidget(e),e}))},qr.prototype.finishReplaceWidget=function(e){var t,i;i=Gt('#concierge-widgets ul li[data-widget="'+e.widgetName+'"]'),e.parameters.proactive?i.data("parameters.proactive",e.parameters):i.data("parameters.reactive",e.parameters),void 0!==(t=i.find("svg"))&&t.length>0&&Ur(0,t[0]),void 0!==e.replacementInstance&&(e.replacementInstance.state=1),Gt("#concierge").show()},qr.prototype.getSeenChannelsHosts=function(){return this.seenChannelsHosts||(this.seenChannelsHosts=this.concierge.cacheManager.getClientCache("channelsHosts")||[]),this.seenChannelsHosts},qr.prototype.registerChatHost=function(e){var t=this.getSeenChannelsHosts();P(t,e)<0&&(t.push(e),this.seenChannelsHosts=t,this.concierge.cacheManager.setClientCache("channelsHosts",t,!1))},qr.prototype.showWidget=function(e,t,i){kt.log("WidgetManager.showWidget("+e+", "+JSON.stringify(t)+", "+i+"): invoked.");var n=A.resolve(),r=this.engagementWidgets.widgets[e];if(r){var o=this,a=Gt("#concierge-widget-area"),s=Gt('#concierge-widgets ul li[data-widget="'+e+'"]');or(e)&&t.host&&this.registerChatHost(t.host),n=n.then((function(){if(o.shouldReplaceWidget(e,t))return o.replaceWidget(e,r,t,i);if(r.state&&!o.isActive(e)&&i&&s.data("parameters.reactive")){var n=s.data("parameters.proactive")||s.data("parameters.reactive")||t;return o.replaceWidget(e,r,n,i)}return"function"==typeof r.shouldRebuildIframe&&r.shouldRebuildIframe()?(Gt("#concierge-widget-"+e+" iframe").replaceWith('<iframe frameborder="no" class="widget-content" allow="geolocation"></iframe>'),Mi((function(){o.writeSrcToIframe(e)})).then((function(){return o.concierge.cacheManager.removeWidgetCache(e,"rebuildIframe",!1)}))):void 0})).then((function(){r.proactive=t&&t.proactive||!1,kt.log("WidgetManager.showWidget("+e+"): set widget.proactive="+r.proactive)})).then((function(){return r.state?A.resolve(o.postMessageToWidget(e,"willShow",t)).then((function(){return o.concierge.cacheManager.getWidgetCache(e,"engagement_id",!0)})):o.loadWidget(e,t,i,"chat"===e)})).then((function(n){return n&&null!==o.getEngagementRecord(n)||(n=o.createEngagementRecord(e,void 0!==t?t.rule:null)),i=n,o.concierge.cacheManager.setWidgetCache(e,"engagement_id",i,!0)})).then((function(){var t,n=o.getEngagementRecord(i);if(or(e)){if(null===n)kt.log('WidgetManager.showWidget("'+i+'"): was null.');else if(n.proactive&&void 0===n.chat.time_to_decide){var r=new Date(n.time).getTime();n.chat.time_to_decide=Math.round(((new Date).getTime()-r)/1e3),n.chat.missed_reason=0,n.decision_type="Accepted",t=o.setEngagementRecord(i,n)}}else null!==n&&n.proactive&&(n.decision_type="Accepted",t=o.setEngagementRecord(i,n));return t||(t=A.resolve()),t.then((function(){return o.concierge.contextMonitor.recordEngagementValue()}))})).then((function(){if(o.notificationDisplayed())return kt.log("WidgetManager.showWidget("+e+"): is closing the notification"),o.closeNotification()})).then((function(){return a.addClass("con-open"),o.$concierge.addClass("con-open-widget"),o.openWidget!==e?(o.widgetsType.openWidget(e),ki("widgetOpened",{widgetName:e,source:t.rule.source}),o.openWidget=e):o.widgetsType.makeWidgetActive(Gt("#concierge-widget-"+e)),null}))}return n},qr.prototype.forceBlur=function(){if(this.needsForceBlur){Gt("#concierge").append('<input type="text" id="fakefocus" style="width:1px; height:1px" />');var e=Gt("#fakefocus");e.focus(),e.blur(),e.remove(),this.needsForceBlur=!1}},qr.prototype.hideWidget=function(e){var t=this,i=t.postMessageToWidget(t.openWidget,"willHide");return e||(i=i.then((function(){return Qr(t,!1)}))),i},qr.prototype.closeWidget=function(e){var t=this,i=t.postMessageToWidget(t.openWidget,"willClose");return e||t.concierge.cacheManager.getWidgetCache(t.openWidget,"willHandleClose",!0)||(i=i.then((function(){return Qr(t,!0)}))),i},qr.prototype.fixPosition=function(e){this.widgetsType.fixPosition&&this.widgetsType.fixPosition(e,this.$concierge)},qr.prototype.expandConcierge=function(){kt.log("WidgetManager.expandConcierge(): invoked.")},qr.prototype.collapseConcierge=function(){kt.log("WidgetManager.collapseConcierge(): invoked.")},qr.prototype.preloadCSS=function(){return $r(this),function(e){var t="concierge-style-"+e.widgetsType.cssType;return 0===Gt("#"+t).length?new A((function(i){var n=e.concierge.scriptLocation+"/widgets/"+e.concierge.assetVersion.widgets+"/"+e.widgetsType.cssType+".css",r=document.getElementsByTagName("head")[0],o=document.createElement("link");o.onload=function(){i(!0)},o.id=t,o.rel="stylesheet",o.type="text/css",o.href=n,o.media="all",r.appendChild(o)})):A.resolve(!0)}(this)},qr.prototype.init=function(){kt.log("WidgetManager.init(): invoked."),this.$concierge=Gt("#concierge"),0===this.$concierge.length&&Br(this)},qr.prototype.showConcierge=function(){kt.log("WidgetManager.showConcierge(): invoked."),Gt("#concierge-widgets ul li").length>0&&Gt("#concierge").show()},qr.prototype.hideConcierge=function(){kt.log("WidgetManager.hideConcierge(): invoked."),Gt("#concierge").hide()},qr.prototype.getWidgetPath=function(e){return this.concierge.widgetPath+e+"/"},qr.prototype.isOpen=function(e){var t=this.engagementWidgets.widgets[e];return t&&t.state&&0!==t.state},qr.prototype.isActive=function(e){var t,i=this.concierge.cacheManager.getClientCache("activeWidgets")||[];for(t=0;t<i.length;t++)if(i[t].widgetName===e)return!0;return!1},qr.prototype.setServiceLineId=function(e,t){var i=this,n=this.engagementWidgets.widgets[t];n&&n.widgetParameters&&n.widgetParameters.serviceLineId!==e.serviceLineId&&(n.widgetParameters.serviceLineId=e.serviceLineId,this.concierge.serviceLines.getName(e.serviceLineId).then((function(r){var o=i.widgetLoadParameters[t];return n.widgetParameters.serviceLine=r,o.serviceLine=r,o.serviceLineId=e.serviceLineId,o.parameters&&o.parameters.queue&&(o.parameters.queue=e.serviceLineId),i.setActive({active:!0},t),null})).catch((function(i){kt.log('setServiceLineId("'+t+'", '+JSON.stringify(e)+"): ERROR: "+i)})))},qr.prototype.setActive=function(e,t){var i,n=this.concierge.cacheManager.getClientCache("activeWidgets")||[],r=-1;for(i=0;i<n.length;i++)if(n[i].widgetName===t){r=i,n[i].loadParams=this.widgetLoadParameters[t];break}-1===r&&e.active?(n.push({widgetName:t,loadParams:this.widgetLoadParameters[t]}),ki("widgetActivated",{widgetName:t})):-1===r||e.active||n.splice(r,1),this.concierge.cacheManager.setClientCache("activeWidgets",n,!1)},qr.prototype.setLastNotified=function(e){this.concierge.cacheManager.setClientCache("lastNotified",e)},qr.prototype.getLastNotified=function(){return parseInt(this.concierge.cacheManager.getClientCache("lastNotified"),10)||0},qr.prototype.tooSoonToNotify=function(){var e,t;return e=1e3*this.concierge.rulesEngine.minTimeBetween(),t=(new Date).getTime(),!(e<=0)&&t<this.getLastNotified()+e},qr.prototype.loadActiveWidgets=function(){var e=this,t=e.concierge.cacheManager.getClientCache("activeWidgets")||[],i=null,n=[];e.loadingActiveWidgets=!0;for(var r=0;r<t.length;r++)t[r].loadParams&&(i=this.concierge.cacheManager.getWidgetCache(t[r].widgetName,"engagement_id",!0),n.push(this.addWidget(t[r].loadParams,t[r].loadParams.rule,i)));return A.all(n).finally((function(){delete e.loadingActiveWidgets}))},qr.prototype.notify=function(e,t){kt.log("WidgetManager.notify called with:",e,t);var i=e.widget,n=i+(t&&t.name?":"+t.name:"");if(this.tooSoonToNotify())return kt.log("WidgetManager.notify("+n+"): notified too soon"),A.resolve(Fr);if(!this.widgetsType.canDisplayNotification(e,t))return kt.log("WidgetManager.notify("+n+"): cannot display notification"),A.resolve(Fr);e.rule=t||{},e.proactive=!0;for(var r=this.engagementWidgets.widgets[i],o=this.concierge.cacheManager.getClientCache("activeWidgets")||[],a=0;a<o.length;a++)if(this.engagementWidgets.widgets[o[a].widgetName].configuration.blockOffersWhileActive)return kt.log("WidgetManager.notify("+n+"): blockOffersWhileActive true"),A.resolve(Fr);kt.log("WidgetManager.notify("+n+"): invoked.");var s=this,c=s.createEngagementRecord(e.widget,t,!0),u={status:!0,ref:r,parameters:e,engagementId:c,rule:t},l=function(e){return s._disabled?Fr:e};return("function"==typeof r.beforeNotify?r.beforeNotify(u):A.resolve(u)).then(l).then((function(e){if(e.status){if(s.isSingleChannelMode()&&e.parameters.widget&&r.shouldDisplayBell()){var i=s.$concierge.find("#concierge-widgets li[data-widget]");i&&i.length&&(kt.log("WidgetManager.notify("+n+"): Have an existing widget ("+i.data().widget+") already, so remove it."),s.removeWidget({widget:i.data().widget}))}return s.addWidget(e.parameters,t,e.engagementId)}return e})).then(l).then((function(i){if(!i||!i.status)return Fr;if(!s.widgetsType.canDisplayNotification(e,t))return kt.log("WidgetManager.notify("+n+"): cannot display notification after beforeNotify is complete"),Fr;if("chat"===i.parameters.widget){var o=s.$concierge.find('#concierge-widgets li[data-widget="kbot"]');o&&o.length&&(e.kbotParameters=o.data("parameters.reactive"),s.removeWidget({widget:"kbot"}))}s.showNotification(e,{engagementId:c,notificationType:1});var a=s.getEngagementRecord(c);return null!==a&&(a.decision_type="Ignored",s.setEngagementRecord(c,a)),{status:!0,ref:r,parameters:e,engagementId:c}})).then(l).then((function(e){return e.status&&kt.log("WidgetManager.notify("+n+"): ready to notify."),e})).catch((function(e){var t=e.message?e.message:e;return kt.log("WidgetManager.notify("+n+"): error: "+t+"\n"+e.stack),Fr}))},qr.prototype.terminateWidget=function(e){var t=this;if(!or(e))return A.resolve(!0);if(!t.isActive(e)||!t.isOpen(e))return A.resolve(!0);var i=new A((function(i){t[e+"HandleBroadcast"]=function(n,r){return n===e&&"widgetTerminated"===r&&(delete t[e+"HandleBroadcast"],i(!0),!0)}}));return t.postMessageToWidget(e,"willTerminate").then((function(){return i}))},qr.prototype.disable=function(){this._disabled=!0},qr.prototype.enable=function(){this._disabled&&delete this._disabled},qr.prototype.clearHistory=function(){for(var e=this,t={},i=this.getSeenChannelsHosts(),n=0;n<i.length;n++)t[i[n]]=!0;var r=A.resolve(!0);e.disable();for(var o=function(t){return function(){return e.removeWidget({widget:t},!1)}},a=function(t){return function(){return e.terminateWidget(t)}},s=function(e){return function(){var t=document.createElement("iframe");t.setAttribute("id","concierge.clear.history"),t.setAttribute("tabindex","-1"),t.setAttribute("style","display: none; height: 400px; width: 300px;");var i,n=e+"/netagent/ClearChatSession.aspx";return t.setAttribute("src",n),new A((function(n){var r=function(e){"SessionCleared"===e.data&&(window.removeEventListener("message",r,!1),e.fromTimeout?n(!1):n(!0))};window.addEventListener("message",r,!1),document.body.appendChild(t),i=window.setTimeout((function(){kt.log("WidgetManager.clearHistory("+e+'): timeout waiting for "SessionCleared" event. Proceeding with clearHistory process.'),r({data:"SessionCleared",fromTimeout:!0})}),1e3)})).then((function(e){e&&i&&clearTimeout(i),t.remove?t.remove():null!==t.parentNode&&t.parentNode.removeChild(t)}))}},c=Object.keys(e.KNOWN_WIDGETS),u=0;u<c.length;u+=1){var l=c[u],d=e.engagementWidgets.widgets[l];d&&d.widgetParameters&&d.widgetParameters.host&&(t[d.widgetParameters.host]=!0),r=r.then(a(l)).then(o(l))}for(var g=Object.keys(t),h=0;h<g.length;h+=1)r=r.then(s(g[h]));return r},qr.prototype.destroy=function(){if(function(e){for(var t in window.MOXIE_CONCIERGE&&delete window.MOXIE_CONCIERGE.startEngagement,e.dataStartListener&&(ot(document,"click",e.dataStartListener),delete e.dataStartListener),e.bridgeListener)window.removeEventListener("message",e.bridgeListener[t],!1),delete e.bridgeListener[t]}(this),this.widgetsType.destroy&&this.widgetsType.destroy(),this.engagementWidgets)for(var e in this.simpleWidgets){var t=this.engagementWidgets.widgets[e];t&&"function"==typeof t.destroy&&t.destroy()}},qr.prototype.isValidEngagementConfig=function(e){var t;if(void 0===e||!e.widget||!this.KNOWN_WIDGETS[e.widget])return!1;for(t=0;t<this.KNOWN_WIDGETS[e.widget].requires.length;t++)if(void 0===e[this.KNOWN_WIDGETS[e.widget].requires[t]])return!1;return!0};var Xr=function(e){var t,i=e.Symbol;return"function"==typeof i?i.observable?t=i.observable:(t=i("observable"),i.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),Yr=function(){return Math.random().toString(36).substring(7).split("").join(".")},Zr={INIT:"@@redux/INIT"+Yr(),REPLACE:"@@redux/REPLACE"+Yr(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Yr()}};function eo(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function to(e,t,i){var n;if("function"==typeof t&&"function"==typeof i||"function"==typeof i&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof t&&void 0===i&&(i=t,t=void 0),void 0!==i){if("function"!=typeof i)throw new Error("Expected the enhancer to be a function.");return i(to)(e,t)}if("function"!=typeof e)throw new Error("Expected the reducer to be a function.");var r=e,o=t,a=[],s=a,c=!1;function u(){s===a&&(s=a.slice())}function l(){if(c)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return o}function d(e){if("function"!=typeof e)throw new Error("Expected the listener to be a function.");if(c)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribelistener for more details.");var t=!0;return u(),s.push(e),function(){if(t){if(c)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribelistener for more details.");t=!1,u();var i=s.indexOf(e);s.splice(i,1),a=null}}}function g(e){if(!eo(e))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(c)throw new Error("Reducers may not dispatch actions.");try{c=!0,o=r(o,e)}finally{c=!1}for(var t=a=s,i=0;i<t.length;i++){(0,t[i])()}return e}function h(e){if("function"!=typeof e)throw new Error("Expected the nextReducer to be a function.");r=e,g({type:Zr.REPLACE})}function f(){var e,t=d;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function i(){e.next&&e.next(l())}return i(),{unsubscribe:t(i)}}})[Xr]=function(){return this},e}return g({type:Zr.INIT}),(n={dispatch:g,subscribe:d,getState:l,replaceReducer:h})[Xr]=f,n}function io(e,t){var i=t&&t.type;return"Given "+(i&&'action "'+String(i)+'"'||"an action")+', reducer "'+e+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function no(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ro(e,t){var i=Object.keys(e);return Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(e)),t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i}function oo(e){for(var t=arguments,i=1;i<arguments.length;i++){var n=null!=t[i]?t[i]:{};i%2?ro(n,!0).forEach((function(t){no(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ro(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ao(){for(var e=arguments,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=e[n];return 0===i.length?function(e){return e}:1===i.length?i[0]:i.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}function so(e){return function(t){var i=t.dispatch,n=t.getState;return function(t){return function(r){return"function"==typeof r?r(i,n,e):t(r)}}}}var co=so();co.withExtraArgument=so;var uo=function(e,t){return function(e){for(var t=Object.keys(e),i=t.length,n=new Array(i);i--;)n[i]=[t[i],e[t[i]]];return n}(t).filter((function(t){var i=t[0];t[1];return i!==e})).reduce((function(e,t){var i,n=t[0],r=t[1];return ut(e,((i={})[n]=r,i))}),{})},lo="function"==typeof CustomEvent?function(e,t){return new CustomEvent(e,{detail:t})}:function(e,t){var i=document.createEvent("CustomEvent");return i.initCustomEvent(e,!1,!1,t),i},go=function(e,t,i){var n=lo("GoMoxie:"+e,t);return n.version=i,n},ho=["u","w","W","p","q","V","v","$"],fo={events:[],eventsCount:0,sending:[],batchTimerState:"INITIALIZED",lastServerCallOK:!0,priorityEventAdded:!1,prevState:{},terminating:!1,failureStreak:0};var po=function(e){for(var t=Object.keys(e),i={},n=0;n<t.length;n++){var r=t[n];"function"==typeof e[r]&&(i[r]=e[r])}var o,a=Object.keys(i);try{!function(e){Object.keys(e).forEach((function(t){var i=e[t];if(void 0===i(void 0,{type:Zr.INIT}))throw new Error('Reducer "'+t+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===i(void 0,{type:Zr.PROBE_UNKNOWN_ACTION()}))throw new Error('Reducer "'+t+"\" returned undefined when probed with a random type. Don't try to handle "+Zr.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')}))}(i)}catch(e){o=e}return function(e,t){if(void 0===e&&(e={}),o)throw o;for(var n=!1,r={},s=0;s<a.length;s++){var c=a[s],u=i[c],l=e[c],d=u(l,t);if(void 0===d){var g=io(c,t);throw new Error(g)}r[c]=d,n=n||d!==l}return(n=n||a.length!==Object.keys(e).length)?r:e}}({schemaVersion:function(e,t){return void 0===e&&(e=1),e},eventService:function(e,t){void 0===e&&(e=fo);var i=uo("prevState",e),n=JSON.parse(JSON.stringify(i));if(!e.terminating)switch(t.type){case"ADD_EVENT":return ut(i,{prevState:n},{events:e.events.concat([uo("type",t)]),eventsCount:e.eventsCount+1});case"ADD_PRIORITY_EVENT":return ut(i,{prevState:n},{events:e.events.concat([uo("type",t)]),eventsCount:e.eventsCount+1,priorityEventAdded:!0})}switch(t.type){case"SEND_EVENTS":return ut(i,{prevState:n},{events:[],eventsCount:0,sending:e.events});case"SEND_PRIORITY_EVENTS":return ut(i,{prevState:n},{events:[],eventsCount:0,sending:e.events,priorityEventAdded:!1});case"CLEAR_SENT":return ut(i,{prevState:n},{sending:[],lastServerCallOK:!0,failureStreak:0});case"RETRY_SENT":return ut(i,{prevState:n},{events:e.sending.concat(e.events),eventsCount:e.eventsCount+e.sending.length,sending:[],lastServerCallOK:!1,failureStreak:e.failureStreak+1});case"SET_TIMER_STATE":return ut(i,{prevState:n},{batchTimerState:t.value||!1});case"TERMINATING":return ut(i,{prevState:n},{terminating:!0})}return e}});function vo(e,t,i){var n=3e4;return i>0&&(n+=1333*Math.pow(i,2),n=Math.min(3e5,n)),new A((function(i,r){var o=new XMLHttpRequest;o.timeout=n,o.open("POST",t.serverEndpoint),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.onload=function(e){return i({status:o.status,body:o.response})},o.onerror=function(e){return i({status:o.status,message:"Could not read error response, probably because CORS headers are missing."})},o.send(JSON.stringify(function(e){for(var t={e:[]},i={},n=JSON.parse(JSON.stringify(e)),r=0;r<ho.length;r++){var o=ho[r],a=mo(n.map((function(e){return e.payload[o]})));if(1===a.length&&void 0!==a[0]){i[o]=a[0];for(var s=0;s<n.length;s++){delete n[s].payload[o]}}}return(t=ut(i,t)).e=n.map((function(e){return e.payload})),t.d=Date.now(),t}(e)))}))}function mo(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];-1===wo(t,n)&&t.push(n)}return t}function wo(e,t,i){var n=isFinite(i)?Math.floor(i):0,r=e instanceof Object?e:new Object(e),o=isFinite(r.length)?Math.floor(r.length):0;if(n>=o)return-1;if(n<0&&(n=Math.max(o+n,0)),void 0===t){do{if(n in r&&void 0===r[n])return n}while(++n<o)}else do{if(r[n]===t)return n}while(++n<o);return-1}var yo=function(e,t){if("SEND_PRIORITY_EVENTS"===e){var i=new go("PriorityEvents",{status:t});window.dispatchEvent(i)}},bo=function(e,t){return function(i,n){if(n().eventService.events.length>0){i({type:e});var r=n().eventService.failureStreak;vo(n().eventService.sending,t,r).then((function(t){n().eventService.terminating||(t.status>=200&&t.status<300||t.status>=400&&t.status<500?(yo(e,!0),i(Co())):r>=8640?(yo(e,!1),i(Co())):(yo(e,!1),i({type:"RETRY_SENT"})))}))}}};function So(e){return bo("SEND_EVENTS",e)}function Co(){return{type:"CLEAR_SENT"}}var _o=function(e,t){void 0===t&&(t=function(e){return e}),this.timeout_in_ms=e,this.stateChangeCallbackFn=t,this.timerState="INITIALIZED"};_o.prototype.timerInternalState=function(){return this.timerState},_o.prototype.startTimer=function(e){var t=this;void 0===e&&(e=this.timeout_in_ms);this.timer=setTimeout((function(){t.timerState="EXPIRED",t.stateChangeCallbackFn("EXPIRED")}),e),this.timerState="RUNNING",this.stateChangeCallbackFn("RUNNING")},_o.prototype.cancelTimer=function(){clearTimeout(this.timer),this.timerState="CANCELLED",this.stateChangeCallbackFn("CANCELLED")};var No=[function(e){var t={schemaVersion:1,eventService:ut({},e.eventService,{terminating:!1})};return ut({},e,t)}],Io=function(){try{var e=localStorage.getItem("moxieState");if(null===e)return;return function(e,t){void 0===t&&(t=No);var i=e.schemaVersion||0,n=t.length;i<n&&t.slice(i,n).forEach((function(t){return e=t(e)}));return e}(JSON.parse(e))}catch(e){return}};function Eo(e,t,i){e.subscribe((function(){var n=e.getState().eventService.prevState.eventsCount,r=e.getState().eventService.eventsCount;if(n!==r){var o=e.getState().eventService.prevState.lastServerCallOK,a=e.getState().eventService.lastServerCallOK,s=e.getState().eventService.priorityEventAdded,c=0===e.getState().eventService.sending.length;c&&s?(t.cancelTimer(),e.dispatch(function(e){return bo("SEND_PRIORITY_EVENTS",e)}(i))):c&&a&&r>=5?(t.cancelTimer(),e.dispatch(So(i))):0===n&&r>=1?(t.cancelTimer(),a?t.startTimer():t.startTimer(1e4)):!0===o&&!1===a&&(t.cancelTimer(),t.startTimer(1e4))}})),e.subscribe((function(){var t=e.getState().eventService.prevState.batchTimerState,n=e.getState().eventService.batchTimerState;t!==n&&"EXPIRED"===n&&e.dispatch(So(i))})),e.subscribe((function(){var t=e.getState().eventService.prevState.eventsCount,i=e.getState().eventService.eventsCount,n=e.getState().eventService.prevState.sending,r=e.getState().eventService.sending,o=e.getState().eventService.terminating;(t!==i||n!==r)&&!o&&function(e){try{var t=JSON.stringify(e);localStorage.setItem("moxieState",t)}catch(e){return}}(e.getState())}))}var Oo=function(e){if(this.store=null,this.batchTimer=null,this.config=e,this.startEventService(),void 0===this.config.serverEndpoint)throw"serverEndpoint config value is required for the EventService"};function To(e){this.scriptElement=e,this.engagementWidgetsVersion=null,this.engagementRulesVersion=null}Oo.prototype.notifyEventService=function(e){this.store.dispatch({type:"ADD_EVENT",payload:e})},Oo.prototype.notifyEventServiceImmediately=function(e){this.store.dispatch({type:"ADD_PRIORITY_EVENT",payload:e})},Oo.prototype.startEventService=function(){var e=Io();null!=e&&null!==e.eventService&&void 0!==e.eventService&&(e.eventService.failureStreak=0),this.store=to(po,e,function(){for(var e=arguments,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=e[n];return function(e){return function(){var t=e.apply(void 0,arguments),n=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},r={getState:t.getState,dispatch:function(){return n.apply(void 0,arguments)}},o=i.map((function(e){return e(r)}));return oo({},t,{dispatch:n=ao.apply(void 0,o)(t.dispatch)})}}}(co));var t,i=(t=this.store,function(e){t.dispatch({type:"SET_TIMER_STATE",value:e})});this.batchTimer=new _o(5e3,i),Eo(this.store,this.batchTimer,this.config),this.store.dispatch({type:"CLEAR_SENT"}),this.batchTimer.startTimer()},Oo.prototype.stopEventService=function(){this.store.dispatch({type:"TERMINATING"}),this.batchTimer.cancelTimer(),this.store.dispatch({type:"CLEAR_SENT"}),this.store.dispatch(So(this.config)),function(){try{localStorage.removeItem("moxieState")}catch(e){return}}()},To.prototype.logError=function(e,t){var i=e+": ";t.stack?i+=t.stack:t.message?i+=t.message:i+=t.toString(),kt.log(i)},To.prototype.getTranslation=function(e,t,i){return this.localization.translate(e+".client."+t,i)},To.prototype.registerNamespace=function(){return window.GoMoxie=window.GoMoxie||{},window.GoMoxie.concierge={},window.GoMoxie.console=kt,this.isTestMode||kt.suppressLogs(),window.GoMoxie};function ko(){return function(){var e,t=["JxBrowser","MoxieAgentClient","JavaFX"];for(e=0;e!==t.length;e++)if(-1!==window.navigator.userAgent.indexOf(t[e]))return!1;var i=!1,n=sn(window.navigator);if(-1!==P(["chrome","firefox","safari","msie","android"],n[0]))if("msie"===n[0]){if(-1!==window.navigator.userAgent.toLowerCase().indexOf("iemobile"))return!1;i=parseInt(n[1])>=11}else i="android"!==n[0]||parseFloat(n[1])>=5;else i=!1;return i}()}function xo(){var e="Concierge failed to load: ";if(!ko())throw ki("conciergeFailedToLoad",e+="unsupported browser"),new Error(e);if(!function(){var e=!1;try{e=void 0!==window.localStorage.getItem("MoxieUndefinedKey")}catch(e){window.console.error(e)}return e}())throw ki("conciergeFailedToLoad",e+="localStorage required"),new Error(e);return!0}To.prototype.prepare=function(e,t,i){i=i||{},Gt("#concierge").remove(),this.url=e,this.pageTitle=t,this.scriptLocation=this.scriptElement.getScriptLocation(),this.isTestMode=this.scriptElement.getTestMode(),this.logDisabled=this.scriptElement.getLogFlag(),this.clientName=this.scriptElement.getClientName(),this.positionMethod=this.scriptElement.getDisplayConfiguration().positionMethod,this.conciergeHost=this.scriptElement.getConciergeHost(),this.separator=this.scriptElement.getConciergeSeparator(),this.protocol=0===this.scriptLocation.indexOf("https:")?"https:":"http:",this.currentOfferCreatedAt=null,this.gomoxie=this.registerNamespace(),this.loadState="LOADING",this.serviceUrl={connector:this.protocol+"//connector"+this.separator+this.clientName+"."+this.conciergeHost,location:this.protocol+"//location."+this.conciergeHost,events:this.protocol+"//events"+this.separator+this.clientName+"."+this.conciergeHost+"/1.1/events"},this.assetVersion={rules:"",widgets:""},this.onQuestionnaireLoadedCallbacks=new Dn,this.onQuestionnaireSubmitCallbacks=new Dn,this.httpGet=this.httpGet||(new Kt).get,this.localization=i.localization||new Mn(this),this.rulesEngine=i.rulesEngine||new Fn(this),this.eventService=i.eventService||new Oo({serverEndpoint:this.serviceUrl.events}),this.publicAPI=i.publicAPI||new Gn,this.publicAPI.registerMethods(this,this.gomoxie),this.publicApiV2=i.publicApiV2||new Bn(this,this.gomoxie),this.cacheManager=this.cacheManager||i.cacheManager||new Cn(this),this.widgetManager=i.widgetManager||new qr(this),this.contextMonitor=i.contextMonitor||new Wn(this),this.serviceLines=i.serviceLines||new Rn(this)},To.prototype.prepareAndInit=function(e,t,i){return this.prepare(e,t,i),this.init()},To.prototype.initAPI=function(){var e=this,t=e.scriptLocation+"/config/latest/configuration.json";return-1!==this.url.indexOf("MoxieTest=true")&&sessionStorage.setItem("MoxieConfigCacheBust","true"),"true"===sessionStorage.getItem("MoxieConfigCacheBust")&&(t+="?cacheBuster="+Date.now()),this.apiReady=A.all([this.httpGet(t).then((function(t){return e.configuration=t,e.assetVersion.widgets=t.widgets.version,e.localization.init(),e.widgetManager.preloadCSS()})),e.cacheManager.init()]).then((function(){return e.contextMonitor.initTracking()})).then((function(){return e.widgetManager.init(),function(e,t){var i=new Xt(e,t,"1.0");try{window.dispatchEvent(i)}catch(t){kt.log("PublicAPI.broadcastNow("+e+"): error: "+(t.stack?t.stack:t.message))}return i}("apiReady")})),this.apiReady},To.prototype.init=function(){var e=this,t=function(t){return function(){return"LOADING"===e.loadState?t():null}};return this.ready=this.initAPI().then((function(){e.rulesEngine.init(e.configuration),e.contextMonitor.start()})).then(t((function(){return e.widgetManager.loadActiveWidgets()}))).then(t((function(){return e.rulesEngine.run(),e.widgetManager.addEventListeners(e.widgetManager),e.widgetManager.showConcierge(),e.widgetManager.fixPosition(e.positionMethod),Ni(e),ki("conciergeReady"),e.loadState="READY",!0}))),this.ready.catch((function(t){e.loadState="FAILED",e.logError("Concierge Unexpected Error",t),ki("conciergeFailedToLoad")})),this.ready};var Lo=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],Wo=/^(?:([^:/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\d*))?))?((((?:[^?#/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,Mo=/^(?:(?![^:@]+:[^:@/]*@)([^:/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#/]*\.[^?#/.]+(?:[?#]|$)))*\/?)?([^?#/]*))(?:\?([^#]*))?(?:#(.*))?)/,Ao=/(?:^|&)([^&=]*)=?([^&]*)/g;function Do(e){xo(),this.element=e}Do.getScriptElement=function(){for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++)if(e[t].getAttribute("data-concierge")||e[t].getAttribute("concierge"))return new Do(e[t]);return null},ut(Do.prototype,{getSourceUri:function(){return function(e,t){for(var i=t?Wo:Mo.exec(e),n={queryKey:{}},r=14;r--;)n[Lo[r]]=i[r]||"";return n.query.replace(Ao,(function(e,t,i){t&&(n.queryKey[t]=i)})),n}(this.element.src,!1)},getTestMode:function(){var e=this.getSourceUri();return e.queryKey.testmode?"true"===e.queryKey.testmode:localStorage.getItem("Moxie_testmode")},getLogFlag:function(){var e=this.getSourceUri();return e.queryKey.log?"false"===e.queryKey.log:localStorage.getItem("Moxie_log")},getAttribute:function(e){return this.element.getAttribute(e)},getScriptLocation:function(){var e=this.getAttribute("data-concierge-script-location");if(e)return e;var t=this.getSourceUri(),i=[t.protocol,"://",t.host];80===t.port&&443===t.port||!t.port||i.push(":"+t.port);var n=t.path?t.path.split("/").slice(0,-2).join("/"):"";return i.push(n),i.join("")},getClientName:function(){return this.getAttribute("data-client")?this.getAttribute("data-client"):this.getScriptLocation().match(/([^/]+)$/).pop()},getConciergeHost:function(){return this.getAttribute("data-concierge-host")?this.getAttribute("data-concierge-host"):"gomoxie.solutions"},getConciergeSeparator:function(){var e="-",t=this.getSourceUri();return t.queryKey.separator&&(e=t.queryKey.separator),e},getDisplayConfiguration:function(){var e=this.getAttribute("data-display-config");return e&&(e=JSON.parse(e)),e&&"object"==typeof e?{positionMethod:e.positionMethod||"css"}:{positionMethod:"css"}}}),function(){var e;try{xo();var t=new To(Do.getScriptElement()),i=document.location.href,n=document.title;e=t.prepareAndInit(i,n)}catch(t){window.console.error(t),e=A.reject(t)}window.conciergeReady=window.conciergeReady||e}()}();
//# sourceMappingURL=concierge-client.js.map
